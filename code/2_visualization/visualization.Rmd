---
title: "Social determinants predict frailty_visualization"
author: "Yan Luo"
date: '2025-04-10'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Make sure the working directory is "your path/social-determinants-frailty"
knitr::opts_knit$set(root.dir = "D:/github_project/social-determinants-frailty")

# Core data manipulation and utilities
library(tidyverse)
library(reshape2)
library(skimr)
library(scales)

# Visualization and plotting
library(ggplot2)
library(patchwork)
library(ggpubr)
library(viridisLite)
library(utile.visuals)
library(ggrepel)
library(ggtext)

# Layout and arrangement
library(grid)
library(gridExtra)

# Model interpretation
library(shapviz)

```

# Self-defined functions

```{r}

# Formats numbers in scientific notation with multiplication symbol (e.g., 2 × 10^6)
scientific_10 <- function(x) {
  ifelse(x == 0, "0", parse(text = sub("e[+]?", " %*% 10^", scientific_format()(x))))
}

# Creates a beeswarm position adjustment for ggplot2 visualizations
position_bee <- function(width = NULL, adjust = NULL) {
  ggplot2::ggproto(NULL, PositionBee, width = width, adjust = adjust)
}

# ggproto object implementing the beeswarm position adjustment algorithm
PositionBee <- ggplot2::ggproto(
  "PositionBee",
  ggplot2::Position,
  required_aes = c("x", "y"),
  setup_params = function(self, data) {
    list(
      width = if (!is.null(self$width)) self$width else
        ggplot2::resolution(data$y, zero = FALSE) * 0.4,
      adjust = if (!is.null(self$adjust)) self$adjust else 0.5
    )
  },
  compute_panel = function(self, data, params, scales) {
    data <- ggplot2::flip_data(data, params$flipped_aes)
    y_jit <- ave2(data$x, g = data$y, FUN = shifter, adjust = params$adjust)
    data <- ggplot2::transform_position(
      data, trans_y = function(y) y + y_jit * params$width
    )
    ggplot2::flip_data(data, params$flipped_aes)
  }
)

# Modified version of ave() that properly handles vector splitting and application of functions
ave2 <- function(x, g = NULL, FUN = mean, ...) {
  if (is.null(g)) {
    x[] <- FUN(x, ...)
  } else {
    split(x, g) <- lapply(split(x, g), FUN, ...)
  }
  x
}

# Calculates point shift values for beeswarm visualization based on density
shifter <- function(y, ...) {
  if (length(y) == 1L) {
    return(0)
  }
  dens <- stats::density(y, ...)
  dens_y <- dens[["y"]] / max(dens[["y"]])
  shift <- halton_sequence(length(y))[rank(y, ties.method = "first")] - 0.5
  2 * shift * stats::approx(dens[["x"]], dens_y, xout = y)[["y"]]
}

# Generates a low-discrepancy Halton sequence of specified length
halton_sequence <- function(n, b = 2) {
  vapply(seq_len(n), halton, FUN.VALUE = 0.0)
}

# Calculates a single value in the Halton sequence
halton <- function(i, b = 2) {
  f <- 1
  r <- 0
  while (i > 0) {
    f <- f / b
    r <- r + f * (i %% b)
    i <- trunc(i / b)
  }
  r
}

```

# Import data

```{r}

print(getwd())

file_list <- list.files(path = str_c(getwd(), "/data/processed", sep = ""), full.names = T)


lapply(file_list, load, .GlobalEnv)

```

# Supplementary Figure 1: Heatmap

```{r}

#### HRS ####
data <- heatmap_mat_hrs # -0.694 -- 0.783
diag(data) <- NA
skim(
  data %>% 
    as_tibble() %>%
    summarise(across(everything(), \(x) max(x, na.rm = TRUE))) %>%
    as.numeric()
  )
skim(
  data %>% 
    as_tibble() %>%
    summarise(across(everything(), \(x) min(x, na.rm = TRUE))) %>%
    as.numeric()
  )

axis_color <- rep(c("#91D1C2CC", "#8491B4CC", "#F39B7FCC", "#3C5488CC", "#00A087CC", "#4DBBD5CC", "#E64B35CC", "#B09C85CC"), c(7, 9, 35, 39, 7, 7, 17, 2))

heatmap_hrs <- 
  heatmap_mat_hrs %>% 
  melt() %>%
  mutate(
    Var2 = factor(Var2, level = colnames(heatmap_mat_hrs)),
    Var1 = fct_rev(factor(Var1, level = colnames(heatmap_mat_hrs)))
    ) %>%
  arrange(Var2, Var1) %>%
  ggplot(data = ., aes(x = Var2, y = Var1, fill = value))+
  geom_tile() +
  scale_fill_gradientn(
    colours = c("#2E5A87", "#7BA8CCFF", "#FFFFFFFF", "#F78171FF", "#A90C38"),
    breaks = c(-1, -0.5, 0, 0.5, 1),
    limit = c(-1, 1),
    space = "Lab",
    name = "Spearman correlation") +
  theme_classic()+ 
  theme(
    axis.text.y = element_text(size = 12, vjust = .5, angle = 0, colour = axis_color),
    axis.text.x = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    legend.key.width = unit(2, "cm"),
    plot.margin = unit(c(t = 0, r = .5, b = 0, l = .5),"cm"),
    plot.title = element_text(size = 25, face = "bold", hjust = 0, vjust = 1)
    ) +
  coord_fixed() +
  labs(
    x = "",
    y = "",
    title = expression(bold("a") ~~ bold("HRS") ~ "(" * italic(N) ~ "=" ~ "5,792" * ")")
  )

#### ELSA ####
data <- heatmap_mat_elsa # -0.667 -- 0.840
diag(data) <- NA
skim(
  data %>% 
    as_tibble() %>%
    summarise(across(everything(), \(x) max(x, na.rm = TRUE))) %>%
    as.numeric()
  )
skim(
  data %>% 
    as_tibble() %>%
    summarise(across(everything(), \(x) min(x, na.rm = TRUE))) %>%
    as.numeric()
  )

axis_color <- rep(c("#91D1C2CC", "#8491B4CC", "#F39B7FCC", "#3C5488CC", "#00A087CC", "#4DBBD5CC", "#E64B35CC", "#B09C85CC"), c(6, 12, 15, 36, 25, 6, 25, 2))

heatmap_elsa <- 
  heatmap_mat_elsa %>% 
  melt() %>%
  mutate(
    Var2 = factor(Var2, level = colnames(heatmap_mat_elsa)),
    Var1 = fct_rev(factor(Var1, level = colnames(heatmap_mat_elsa)))
    ) %>%
  arrange(Var2, Var1) %>%
  ggplot(data = ., aes(x = Var2, y = Var1, fill = value))+
  geom_tile() +
  scale_fill_gradientn(
    colours = c("#2E5A87", "#7BA8CCFF", "#FFFFFFFF", "#F78171FF", "#A90C38"),
    breaks = c(-1, -0.5, 0, 0.5, 1),
    limit = c(-1, 1),
    space = "Lab",
    name = "Spearman correlation") +
  theme_classic()+ 
  theme(
    axis.text.y = element_text(size = 12, vjust = .5, angle = 0, colour = axis_color),
    axis.text.x = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    legend.key.width = unit(2, "cm"),
    plot.margin = unit(c(t = 0, r = .5, b = 0, l = .5),"cm"),
    plot.title = element_text(size = 20, face = "bold", hjust = 0, vjust = 1)
    ) +
  coord_fixed() +
  labs(
    x = "",
    y = "",
    title = expression(bold("b") ~~ bold("ELSA") ~ "(" * italic(N) ~ "=" ~ "3,773" * ")")
  )

#### CHARLS ####
data <- heatmap_mat_charls # -0.352 -- 0.793
diag(data) <- NA
skim(
  data %>% 
    as_tibble() %>%
    summarise(across(everything(), \(x) max(x, na.rm = TRUE))) %>%
    as.numeric()
  )
skim(
  data %>% 
    as_tibble() %>%
    summarise(across(everything(), \(x) min(x, na.rm = TRUE))) %>%
    as.numeric()
  )

axis_color <- rep(c("#91D1C2CC", "#8491B4CC", "#F39B7FCC", "#3C5488CC", "#00A087CC", "#4DBBD5CC", "#E64B35CC", "#B09C85CC"), c(7, 11, 11, 21, 16, 4, 24, 2))

heatmap_charls <- 
  heatmap_mat_charls %>% 
  melt() %>%
  mutate(
    Var2 = factor(Var2, level = colnames(heatmap_mat_charls)),
    Var1 = fct_rev(factor(Var1, level = colnames(heatmap_mat_charls)))
    ) %>%
  arrange(Var2, Var1) %>%
  ggplot(data = ., aes(x = Var2, y = Var1, fill = value))+
  geom_tile() +
  scale_fill_gradientn(
    colours = c("#2E5A87", "#7BA8CCFF", "#FFFFFFFF", "#F78171FF", "#A90C38"),
    breaks = c(-1, -0.5, 0, 0.5, 1),
    limit = c(-1, 1),
    space = "Lab",
    name = "Spearman correlation") +
  theme_classic()+ 
  theme(
    axis.text.y = element_text(size = 12, vjust = .5, angle = 0, colour = axis_color),
    axis.text.x = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    legend.key.width = unit(2, "cm"),
    plot.margin = unit(c(t = 0, r = .5, b = 0, l = .5),"cm"),
    plot.title = element_text(size = 25, face = "bold", hjust = 0, vjust = 1)
    ) +
  coord_fixed() +
  labs(
    x = "",
    y = "",
    title = expression(bold("c") ~~ bold("CHARLS") ~ "(" * italic(N) ~ "=" ~ "5,016" * ")")
  )

#### pool ####
heatmap_pool <- 
  (heatmap_hrs + heatmap_elsa + heatmap_charls) +
  plot_layout(widths = c(ncol(heatmap_mat_hrs)/ncol(heatmap_mat_elsa), 1, ncol(heatmap_mat_charls)/ncol(heatmap_mat_elsa)), ncol = 3, nrow = 1, byrow = T, guides = "collect") &
  theme(
    legend.position = 'bottom'
    ) & 
  guides(fill =
    guide_colourbar(
      barwidth = unit(5, "in"), barheight = unit(0.5, "in"),
      label.theme = element_text(size = 20, colour = "black", angle = 0),
      title.theme = element_text(size = 20, face = "bold", colour = "black", angle = 0)
  )
)

ggsave(str_c(getwd(), "/results/Figure/Heatmap of predictors_pool.png", sep = ""), plot = heatmap_pool, width = 60, height = 18, unit = "in", dpi = 300, device = "png", limitsize = FALSE)

ggsave(str_c(getwd(), "/results/Figure/Heatmap of predictors_pool.pdf", sep = ""), plot = heatmap_pool, width = 60, height = 18, unit = "in", dpi = 300, device = "pdf", limitsize = F)

```

# Distribution of frailty index

## Figure 2

```{r}

#### HRS ####
data <- final_hrs %>% 
  filter(fi_b < 0.2) %>%
  mutate(
    .keep = "none",
    id, male, 
    agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years")),
    fi
    ) %>% 
  mutate(group = "overall")

violin_hrs <- data %>%
  mutate(.keep = "none", group, fi) %>%
  bind_rows(
    data %>% mutate(.keep = "none", group = agegroup, fi)
  ) %>%
  bind_rows(
    data %>% mutate(.keep = "none", group = male, fi)
  ) %>%
  mutate(
    group = factor(group, levels = c("overall", "female", "male", "<65 years", "≥65 years"), labels = c("Overall", "Female", "Male", "<65 years", "≥65 years")),
    facet = case_when(
      group == "Overall" ~ " ",
      group %in% c("Male", "Female") ~ "Sex",
      group %in% c("<65 years", "≥65 years") ~ "Age",
      TRUE ~ NA_character_
    ),
    facet = factor(facet, levels = c(" ", "Sex", "Age"))
  )

max_fi <- violin_hrs %>% group_by(group) %>% summarise(max = max(fi))

violin_hrs <- violin_hrs %>%
  mutate(
    samplesize = case_when(
      fi == as.numeric(max_fi[max_fi$group == "Overall", "max"]) & group == "Overall" ~ as.character(expression(paste(italic("N"), " = 5,792"))), 
      fi == as.numeric(max_fi[max_fi$group == "Female", "max"]) & group == "Female" ~ as.character(expression(paste(italic("N"), " = 3,246"))), 
      fi == as.numeric(max_fi[max_fi$group == "Male", "max"]) & group == "Male" ~ as.character(expression(paste(italic("N"), " = 2,546"))),
      fi == as.numeric(max_fi[max_fi$group == "<65 years", "max"]) & group == "<65 years" ~ as.character(expression(paste(italic("N"), " = 2,987"))),
      fi == as.numeric(max_fi[max_fi$group == "≥65 years", "max"]) & group == "≥65 years" ~ as.character(expression(paste(italic("N"), " = 2,805"))),
      TRUE ~ NA_character_
    )
  )

p_violin_hrs <- ggplot(violin_hrs, aes(x = group, y = fi)) +
  geom_violin(aes(fill = group), alpha = .8, linewidth = .8, trim = T) +
  geom_boxplot(width = .2, linewidth = .8, show.legend = F, outlier.shape = NA) +
  geom_text(aes(label = samplesize), size = 4, position = position_dodge(0.9), 
             vjust = -0.5, hjust = 0.5, parse = T) + 
  theme_bw() + 
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 14, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 14, vjust = 3, angle = 90, face = "plain"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks.x = element_line(colour = "black", linewidth = .5),
    axis.ticks.y = element_line(colour = "black", linewidth = .5),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "bottom",
    plot.margin = unit(c(t = 1, r = 1, b = 1, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    strip.text = element_text(size = 12, colour = "black")
    ) +
  scale_fill_manual(
    values = c("#f5f5f5", "#a6611a", "#dfc27d", "#018571", "#80cdc1")  
    ) +
  scale_y_continuous(limits = c(0,1)) +
  labs(
    x = NULL, 
    y = "Frailty index",
    title = "HRS (USA)"
  ) +
  facet_grid(. ~ facet, scales = "free", space = "free", switch = "both") +
  theme(panel.spacing = unit(0, "lines"))

### ELSA ####
data <- final_elsa %>% 
  filter(fi_b < 0.2) %>%
  mutate(
    .keep = "none",
    id, male, 
    agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years")),
    fi
    ) %>% 
  mutate(group = "overall")

violin_elsa <- data %>%
  mutate(.keep = "none", group, fi) %>%
  bind_rows(
    data %>% mutate(.keep = "none", group = agegroup, fi)
  ) %>%
  bind_rows(
    data %>% mutate(.keep = "none", group = male, fi)
  ) %>%
  mutate(
    group = factor(group, levels = c("overall", "female", "male", "<65 years", "≥65 years"), labels = c("Overall", "Female", "Male", "<65 years", "≥65 years")),
    facet = case_when(
      group == "Overall" ~ " ",
      group %in% c("Male", "Female") ~ "Sex",
      group %in% c("<65 years", "≥65 years") ~ "Age",
      TRUE ~ NA_character_
    ),
    facet = factor(facet, levels = c(" ", "Sex", "Age"))
  )

max_fi <- violin_elsa %>% group_by(group) %>% summarise(max = max(fi))

violin_elsa <- violin_elsa %>%
  mutate(
    samplesize = case_when(
      fi == as.numeric(max_fi[max_fi$group == "Overall", "max"]) & group == "Overall" ~ as.character(expression(paste(italic("N"), " = 3,773"))), 
      fi == as.numeric(max_fi[max_fi$group == "Female", "max"]) & group == "Female" ~ as.character(expression(paste(italic("N"), " = 2,042"))), 
      fi == as.numeric(max_fi[max_fi$group == "Male", "max"]) & group == "Male" ~ as.character(expression(paste(italic("N"), " = 1,731"))),
      fi == as.numeric(max_fi[max_fi$group == "<65 years", "max"]) & group == "<65 years" ~ as.character(expression(paste(italic("N"), " = 1,911"))),
      fi == as.numeric(max_fi[max_fi$group == "≥65 years", "max"]) & group == "≥65 years" ~ as.character(expression(paste(italic("N"), " = 1,862"))),
      TRUE ~ NA_character_
    )
  )

p_violin_elsa <- ggplot(violin_elsa, aes(x = group, y = fi)) +
  geom_violin(aes(fill = group), alpha = .8, linewidth = .8, trim = T) +
  geom_boxplot(width = .2, linewidth = .8, show.legend = F, outlier.shape = NA) +
  geom_text(aes(label = samplesize), size = 4, position = position_dodge(0.9), 
             vjust = -0.5, hjust = 0.5, parse = T) +   theme_bw() + 
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 14, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 14, vjust = 3, angle = 90, face = "plain"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks.x = element_line(colour = "black", linewidth = .5),
    axis.ticks.y = element_line(colour = "black", linewidth = .5),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "bottom",
    plot.margin = unit(c(t = 1, r = 1, b = 1, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    strip.text = element_text(size = 12, colour = "black")
    ) +
  scale_fill_manual(
    values = c("#f5f5f5", "#a6611a", "#dfc27d", "#018571", "#80cdc1")
  ) +
  scale_y_continuous(limits = c(0,1)) +
  labs(
    x = NULL, 
    y = "",
    title = "ELSA (England)"
  ) +
  facet_grid(. ~ facet, scales = "free", space = "free", switch = "both") +
  theme(panel.spacing = unit(0, "lines"))

#### CHARLS ####
data <- final_charls %>% 
  filter(fi_b < 0.2) %>%
  mutate(
    .keep = "none",
    id, male, 
    agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years")),
    fi
    ) %>% 
  mutate(group = "overall")

violin_charls <- data %>%
  mutate(.keep = "none", group, fi) %>%
  bind_rows(
    data %>% mutate(.keep = "none", group = agegroup, fi)
  ) %>%
  bind_rows(
    data %>% mutate(.keep = "none", group = male, fi)
  ) %>%
  mutate(
    group = factor(group, levels = c("overall", "female", "male", "<65 years", "≥65 years"), labels = c("Overall", "Female", "Male", "<65 years", "≥65 years")),
    facet = case_when(
      group == "Overall" ~ " ",
      group %in% c("Male", "Female") ~ "Sex",
      group %in% c("<65 years", "≥65 years") ~ "Age",
      TRUE ~ NA_character_
    ),
    facet = factor(facet, levels = c(" ", "Sex", "Age"))
  )

max_fi <- violin_charls %>% group_by(group) %>% summarise(max = max(fi))

violin_charls <- violin_charls %>%
  mutate(
    samplesize = case_when(
      fi == as.numeric(max_fi[max_fi$group == "Overall", "max"]) & group == "Overall" ~ as.character(expression(paste(italic("N"), " = 5,016"))), 
      fi == as.numeric(max_fi[max_fi$group == "Female", "max"]) & group == "Female" ~ as.character(expression(paste(italic("N"), " = 2,292"))), 
      fi == as.numeric(max_fi[max_fi$group == "Male", "max"]) & group == "Male" ~ as.character(expression(paste(italic("N"), " = 2,724"))),
      fi == as.numeric(max_fi[max_fi$group == "<65 years", "max"]) & group == "<65 years" ~ as.character(expression(paste(italic("N"), " = 3,810"))),
      fi == as.numeric(max_fi[max_fi$group == "≥65 years", "max"]) & group == "≥65 years" ~ as.character(expression(paste(italic("N"), " = 1,206"))),
      TRUE ~ NA_character_
    )
  )

p_violin_charls <- ggplot(violin_charls, aes(x = group, y = fi)) +
  geom_violin(aes(fill = group), alpha = .8, linewidth = .8, trim = T) +
  geom_boxplot(width = .2, linewidth = .8, show.legend = F, outlier.shape = NA) +
  geom_text(aes(label = samplesize), size = 4, position = position_dodge(0.9), 
             vjust = -0.5, hjust = 0.5, parse = T) + 
  theme_bw() + 
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 14, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 14, vjust = 3, angle = 90, face = "plain"),
    axis.line = element_line(colour = "black", linewidth = .5),
    axis.ticks.x = element_line(colour = "black", linewidth = .5),
    axis.ticks.y = element_line(colour = "black", linewidth = .5),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "bottom",
    plot.margin = unit(c(t = 1, r = 1, b = 1, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    strip.text = element_text(size = 12, colour = "black")
    ) +
  scale_fill_manual(
    values = c("#f5f5f5", "#a6611a", "#dfc27d", "#018571", "#80cdc1")
    ) +
  scale_y_continuous(limits = c(0,1)) +
  labs(
    x = NULL, 
    y = "Frailty index",
    title = "CHARLS (China)"
  ) +
  facet_grid(. ~ facet, scales = "free", space = "free", switch = "both") +
  theme(panel.spacing = unit(0, "lines"))

violin_pool <- p_violin_hrs + p_violin_elsa + p_violin_charls +
  plot_annotation(tag_levels = "a") +
  plot_layout(ncol = 2, guides = "collect") &
  theme(
    plot.tag = element_text(size = 20, face = "bold"),
    legend.position = "none"
    )

ggsave(str_c(getwd(), "/results/Figure/Distribution_pool.png", sep = ""), plot = violin_pool, width = 12, height = 10, unit = "in", dpi = 300, device = "png", limitsize = FALSE) 

ggsave(str_c(getwd(), "/results/Figure/Distribution_pool.pdf", sep = ""), plot = violin_pool, width = 12, height = 10, unit = "in", dpi = 300, device = "pdf", limitsize = FALSE)

```

## Supplementary Table 12

```{r}

#### HRS ####
final_hrs %>% 
  filter(fi_b < 0.2) %>%
  summarise(
    sprintf("%0.2f", mean(fi_b)), sprintf("%0.2f", sd(fi_b)), sprintf("%0.2f", mean(fi)), sprintf("%0.2f", sd(fi))
  )

final_hrs %>% 
  filter(fi_b < 0.2) %>%
  mutate(agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years"))) %>%
  group_by(agegroup) %>% 
  summarise(
    sprintf("%0.2f", mean(fi_b)), sprintf("%0.2f", sd(fi_b)), sprintf("%0.2f", mean(fi)), sprintf("%0.2f", sd(fi))
  )

t.test(
  x = final_hrs %>% mutate(agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years"))) %>% filter(fi_b < 0.2 & agegroup == "<65 years") %>% pull(fi_b) %>% as.numeric(), 
  y = final_hrs %>% mutate(agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years"))) %>%filter(fi_b < 0.2 & agegroup == "≥65 years") %>% pull(fi_b) %>% as.numeric(), 
  alternative = c("two.sided"), mu = 0, paired = F, var.equal = T, conf.level = 0.95
  )

t.test(
  x = final_hrs %>% mutate(agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years"))) %>% filter(fi_b < 0.2 & agegroup == "<65 years") %>% pull(fi) %>% as.numeric(), 
  y = final_hrs %>% mutate(agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years"))) %>%filter(fi_b < 0.2 & agegroup == "≥65 years") %>% pull(fi) %>% as.numeric(), 
  alternative = c("two.sided"), mu = 0, paired = F, var.equal = T, conf.level = 0.95
  )


final_hrs %>% 
  filter(fi_b < 0.2) %>%
  group_by(male) %>% 
  summarise(
    sprintf("%0.2f", mean(fi_b)), sprintf("%0.2f", sd(fi_b)), sprintf("%0.2f", mean(fi)), sprintf("%0.2f", sd(fi))
  )

t.test(
  x = final_hrs %>% filter(fi_b < 0.2 & male == "male") %>% pull(fi_b) %>% as.numeric(), 
  y = final_hrs %>% filter(fi_b < 0.2 & male == "female") %>% pull(fi_b) %>% as.numeric(), 
  alternative = c("two.sided"), mu = 0, paired = F, var.equal = T, conf.level = 0.95
  )

t.test(
  x = final_hrs %>% filter(fi_b < 0.2 & male == "male") %>% pull(fi) %>% as.numeric(), 
  y = final_hrs %>% filter(fi_b < 0.2 & male == "female") %>% pull(fi) %>% as.numeric(), 
  alternative = c("two.sided"), mu = 0, paired = F, var.equal = T, conf.level = 0.95
  )

#### ELSA ####
final_elsa %>% 
  filter(fi_b < 0.2) %>%
  summarise(
    sprintf("%0.2f", mean(fi_b)), sprintf("%0.2f", sd(fi_b)), sprintf("%0.2f", mean(fi)), sprintf("%0.2f", sd(fi))
  )

final_elsa %>% 
  filter(fi_b < 0.2) %>%
  mutate(agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years"))) %>%
  group_by(agegroup) %>% 
  summarise(
    sprintf("%0.2f", mean(fi_b)), sprintf("%0.2f", sd(fi_b)), sprintf("%0.2f", mean(fi)), sprintf("%0.2f", sd(fi))
  )

t.test(
  x = final_elsa %>% mutate(agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years"))) %>% filter(fi_b < 0.2 & agegroup == "<65 years") %>% pull(fi_b) %>% as.numeric(), 
  y = final_elsa %>% mutate(agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years"))) %>%filter(fi_b < 0.2 & agegroup == "≥65 years") %>% pull(fi_b) %>% as.numeric(), 
  alternative = c("two.sided"), mu = 0, paired = F, var.equal = T, conf.level = 0.95
  )

t.test(
  x = final_elsa %>% mutate(agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years"))) %>% filter(fi_b < 0.2 & agegroup == "<65 years") %>% pull(fi) %>% as.numeric(), 
  y = final_elsa %>% mutate(agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years"))) %>%filter(fi_b < 0.2 & agegroup == "≥65 years") %>% pull(fi) %>% as.numeric(), 
  alternative = c("two.sided"), mu = 0, paired = F, var.equal = T, conf.level = 0.95
  )

final_elsa %>% 
  filter(fi_b < 0.2) %>%
  group_by(male) %>% 
  summarise(
    sprintf("%0.2f", mean(fi_b)), sprintf("%0.2f", sd(fi_b)), sprintf("%0.2f", mean(fi)), sprintf("%0.2f", sd(fi))
  )

t.test(
  x = final_elsa %>% filter(fi_b < 0.2 & male == "male") %>% pull(fi_b) %>% as.numeric(), 
  y = final_elsa %>% filter(fi_b < 0.2 & male == "female") %>% pull(fi_b) %>% as.numeric(), 
  alternative = c("two.sided"), mu = 0, paired = F, var.equal = T, conf.level = 0.95
  )

t.test(
  x = final_elsa %>% filter(fi_b < 0.2 & male == "male") %>% pull(fi) %>% as.numeric(), 
  y = final_elsa %>% filter(fi_b < 0.2 & male == "female") %>% pull(fi) %>% as.numeric(), 
  alternative = c("two.sided"), mu = 0, paired = F, var.equal = T, conf.level = 0.95
  )

#### CHARLS ####
final_charls %>% 
  filter(fi_b < 0.2) %>%
  summarise(
    sprintf("%0.2f", mean(fi_b)), sprintf("%0.2f", sd(fi_b)), sprintf("%0.2f", mean(fi)), sprintf("%0.2f", sd(fi))
  )

final_charls %>% 
  filter(fi_b < 0.2) %>%
  mutate(agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years"))) %>%
  group_by(agegroup) %>% 
  summarise(
    sprintf("%0.2f", mean(fi_b)), sprintf("%0.2f", sd(fi_b)), sprintf("%0.2f", mean(fi)), sprintf("%0.2f", sd(fi))
  )

t.test(
  x = final_charls %>% mutate(agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years"))) %>% filter(fi_b < 0.2 & agegroup == "<65 years") %>% pull(fi_b) %>% as.numeric(), 
  y = final_charls %>% mutate(agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years"))) %>%filter(fi_b < 0.2 & agegroup == "≥65 years") %>% pull(fi_b) %>% as.numeric(), 
  alternative = c("two.sided"), mu = 0, paired = F, var.equal = T, conf.level = 0.95
  )

t.test(
  x = final_charls %>% mutate(agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years"))) %>% filter(fi_b < 0.2 & agegroup == "<65 years") %>% pull(fi) %>% as.numeric(), 
  y = final_charls %>% mutate(agegroup = factor(ifelse(age < 65, "<65 years", "≥65 years"))) %>%filter(fi_b < 0.2 & agegroup == "≥65 years") %>% pull(fi) %>% as.numeric(), 
  alternative = c("two.sided"), mu = 0, paired = F, var.equal = T, conf.level = 0.95
  )

final_charls %>% 
  filter(fi_b < 0.2) %>%
  group_by(male) %>% 
  summarise(
    sprintf("%0.2f", mean(fi_b)), sprintf("%0.2f", sd(fi_b)), sprintf("%0.2f", mean(fi)), sprintf("%0.2f", sd(fi))
  )

t.test(
  x = final_charls %>% filter(fi_b < 0.2 & male == "male") %>% pull(fi_b) %>% as.numeric(), 
  y = final_charls %>% filter(fi_b < 0.2 & male == "female") %>% pull(fi_b) %>% as.numeric(), 
  alternative = c("two.sided"), mu = 0, paired = F, var.equal = T, conf.level = 0.95
  )

t.test(
  x = final_charls %>% filter(fi_b < 0.2 & male == "male") %>% pull(fi) %>% as.numeric(), 
  y = final_charls %>% filter(fi_b < 0.2 & male == "female") %>% pull(fi) %>% as.numeric(), 
  alternative = c("two.sided"), mu = 0, paired = F, var.equal = T, conf.level = 0.95
  )

```

# SHAP

## Variable-wise

### SHAP beeswarm

#### Figure 4: Overall

```{r}

table(shp_imp_var_overall_hrs %>% slice_tail(n = 20) %>% pull(category))

#### HRS ####
# SHAP value: -0.0231 - 0.110
sv_overall_hrs <- sv_importance(
  shp_overall_hrs, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma")) + 
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 0.5, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold")
  ) +
  scale_y_discrete(
    labels = as.character(shp_imp_var_overall_hrs %>% tail(20) %>% pull(var_name))
  ) + 
  labs(
    x = "SHAP value",
    y = NULL,
    title = "HRS (USA)"
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_overall_hrs %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(feature) %>% as.character(), 
    label = paste0("italic(R)^2 == ", "'", format(round(rsq_boot_xgb_overall_hrs$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_overall_hrs %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(feature) %>% as.character(), 
    label = paste0("MAE == ", "'", format(round(mae_boot_xgb_overall_hrs$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_overall_hrs %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(feature) %>% as.character(), 
    label = paste0("RMSE == ", "'", format(round(rmse_boot_xgb_overall_hrs$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

meanSHAP_plot_overall_hrs <- shp_imp_var_overall_hrs %>% 
  slice_tail(n = 20) %>%
  mutate(
    perform = "Mean absolute SHAP value",
    value_label = format(round(value, 4), big.mark = ",")
  )

p_meanSHAP_overall_hrs <- ggplot(meanSHAP_plot_overall_hrs, aes(x = perform, y = var_name, fill = category)) +
  geom_tile(color = "white") +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12, angle = 00),
    axis.text.y = element_text(size = 12, colour = "black", vjust = 0.5, hjust = 1, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.6, r = 0, b = 1.07, l = 0), "cm")
    ) +
  scale_x_discrete(labels = "") + 
  scale_colour_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", 
               # "#00A087CC", 
               "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC"),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_sv_hrs <- grid.arrange(
  p_meanSHAP_overall_hrs, sv_overall_hrs, ncol = 2, widths = c(1, 1.2)
  ) %>% 
  wrap_elements()


#### ELSA ####
# SHAP value: -0.0251 - 0.136
sv_overall_elsa <- sv_importance(
  shp_overall_elsa, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma")) + 
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 0.5, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold")
  ) +
  scale_y_discrete(
    labels = as.character(shp_imp_var_overall_elsa %>% tail(20) %>% pull(var_name))
  ) + 
  labs(
    x = "SHAP value",
    y = NULL,
    title = "ELSA (England)"
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_overall_elsa %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(feature) %>% as.character(), 
    label = paste0("italic(R)^2 == ", "'", format(round(rsq_boot_xgb_overall_elsa$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_overall_elsa %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(feature) %>% as.character(), 
    label = paste0("MAE == ", "'", "0.050", "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_overall_elsa %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(feature) %>% as.character(), 
    label = paste0("RMSE == ", "'", "0.070", "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

meanSHAP_plot_overall_elsa <- shp_imp_var_overall_elsa %>% 
  slice_tail(n = 20) %>%
  mutate(
    perform = "Mean absolute SHAP value",
    value_label = format(round(value, 4), big.mark = ",")
  )

p_meanSHAP_overall_elsa <- ggplot(meanSHAP_plot_overall_elsa, aes(x = perform, y = var_name, fill = category)) +
  geom_tile(color = "white") +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12, angle = 00),
    axis.text.y = element_text(size = 12, colour = "black", vjust = 0.5, hjust = 1, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.6, r = 0, b = 1.07, l = 0), "cm")
    ) +
  scale_x_discrete(labels = "") + 
  scale_colour_manual(
    values = c("#B09C85CC", 
               # "#E64B35CC", 
               "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC"#, 
               # "#91D1C2CC"
               ),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_sv_elsa <- grid.arrange(
  p_meanSHAP_overall_elsa, sv_overall_elsa, ncol = 2, widths = c(1, 1.7)
  ) %>% 
  wrap_elements()

#### CHARLS ####
# SHAP value: -0.0251 - 0.136
sv_overall_charls <- sv_importance(
  shp_overall_charls, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma")) + 
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0, b = 0.5, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold")
  ) +
  scale_y_discrete(
    labels = as.character(shp_imp_var_overall_charls %>% tail(20) %>% pull(var_name))
  ) + 
  labs(
    x = "SHAP value",
    y = NULL,
    title = "CHARLS (China)"
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_overall_charls %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(feature) %>% as.character(), 
    label = paste0("italic(R)^2 == ", "'", format(round(rsq_boot_xgb_overall_charls$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_overall_charls %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(feature) %>% as.character(), 
    label = paste0("MAE == ", "'", format(round(mae_boot_xgb_overall_charls$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_overall_charls %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(feature) %>% as.character(), 
    label = paste0("RMSE == ", "'", format(round(rmse_boot_xgb_overall_charls$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

meanSHAP_plot_overall_charls <- shp_imp_var_overall_charls %>% 
  slice_tail(n = 20) %>%
  mutate(
    perform = "Mean absolute SHAP value",
    value_label = format(round(value, 4), big.mark = ",")
  )

p_meanSHAP_overall_charls <- ggplot(meanSHAP_plot_overall_charls, aes(x = perform, y = var_name, fill = category)) +
  geom_tile(color = "white") +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12, angle = 00),
    axis.text.y = element_text(size = 12, colour = "black", vjust = 0.5, hjust = 1, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.6, r = 0, b = 1.07, l = 0), "cm")
    ) +
  scale_x_discrete(labels = "") + 
  scale_colour_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC"),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_sv_charls <- grid.arrange(
  p_meanSHAP_overall_charls, sv_overall_charls, ncol = 2, widths = c(1.15, 1)
  ) %>% 
  wrap_elements()

#### pool ####
legend_1_data <- sv_importance(
  shp_overall_hrs, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma"))$data

# magma(5, alpha = 1, begin = 0.25, end = 0.85, direction = 1)
# https://jmsallan.netlify.app/blog/the-viridis-palettes/
legend_1 <- ggplot(legend_1_data, aes(x = value, y = feature)) +
  geom_vline(xintercept = 0, color = "darkgray") +
  geom_point(aes(color = color), position = position_bee(width = 0.4, adjust = 0.5)) +
  scale_colour_gradientn(
    colours = c("#51127CFF", "#8C2981FF", "#CB3E72FF", "#F76F5CFF", "#FEB77EFF"),
    breaks = c(0, 0.25, 0.5, 0.75, 1),
    limit = c(0, 1),
    labels = c("Low", "", "", "", "High"),
    space = "Lab",
    name = "Feature value") +
  guides(colour =
    guide_colourbar(
      barwidth = unit(0.5, "cm"), barheight = unit(5, "cm"),
      title.position = "left",
      title.theme = element_text(size = 12, colour = "black", angle = 90, hjust = .5),
      label.theme = element_text(size = 12, colour = "black", angle = 0)
      )
    )

legend_2 <- ggplot(shp_imp_var_overall_hrs %>% slice_tail(n = 50), aes(x = var_name, y = value, fill = category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC"),
  ) + 
  guides(fill = guide_legend(byrow = T)) +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "right",
    legend.key.size = unit(1.5, "lines")
    )

legend <- wrap_elements(
  (wrap_elements(ggpubr::get_legend(legend_2)) / wrap_elements(ggpubr::get_legend(legend_1))) +
  plot_layout(heights = c(1.5, 1))
  )

p_sv_all <- wrap_elements(
  p_sv_hrs + p_sv_elsa + p_sv_charls + 
    plot_annotation(tag_levels = "a") &
    theme(
      plot.tag = element_text(size = 20, face = "bold")
    )
  )

sv_pool <- wrap_plots(p_sv_all, legend, widths = c(5,1))

ggsave(str_c(getwd(), "/results/Figure/SHAP beewarm plot.png", sep = ""), plot = sv_pool, width = 24, height = 7, unit = "in", dpi = 200, device = "png") 

ggsave(str_c(getwd(), "/results/Figure/SHAP beewarm plot.pdf", sep = ""), plot = sv_pool, width = 24, height = 7, unit = "in", dpi = 300, device = "pdf")


```

#### Supplementary Figure 2: Subgroups

```{r}

table(shp_imp_var_overall_hrs %>% slice_tail(n = 20) %>% pull(category))

#### HRS ####
# female
sv_female_hrs <- sv_importance(
  shp_female_hrs, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma")) + 
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 1, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
  ) +
  scale_y_discrete(
    labels = as.character(shp_imp_var_female_hrs %>% tail(20) %>% pull(var_name))
  ) + 
  labs(
    x = NULL,
    y = NULL,
    title = "Female"
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_female_hrs %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(feature) %>% as.character(), 
    label = paste0("italic(R)^2 == ", "'", format(round(rsq_boot_xgb_female_hrs$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_female_hrs %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(feature) %>% as.character(), 
    label = paste0("MAE == ", "'", format(round(mae_boot_xgb_female_hrs$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_female_hrs %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(feature) %>% as.character(), 
    label = paste0("RMSE == ", "'", format(round(rmse_boot_xgb_female_hrs$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

meanSHAP_plot_female_hrs <- shp_imp_var_female_hrs %>% 
  slice_tail(n = 20) %>%
  mutate(
    perform = "Mean absolute SHAP value",
    value_label = format(round(value, 4), big.mark = ",")
  )

p_meanSHAP_female_hrs <- ggplot(meanSHAP_plot_female_hrs, aes(x = perform, y = var_name, fill = category)) +
  geom_tile(color = "white") +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12, angle = 00),
    axis.text.y = element_text(size = 12, colour = "black", vjust = 0.5, hjust = 1, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.6, r = 0, b = 1.07, l = 0), "cm")
    ) +
  scale_x_discrete(labels = "") + 
  scale_colour_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", 
               # "#00A087CC",
               "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC"),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_sv_female_hrs <- grid.arrange(p_meanSHAP_female_hrs, sv_female_hrs, ncol = 2, widths = c(1, 1.6)) %>% 
  wrap_elements()

# male
sv_male_hrs <- sv_importance(
  shp_male_hrs, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma")) + 
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 1, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
  ) +
  scale_y_discrete(
    labels = as.character(shp_imp_var_male_hrs %>% tail(20) %>% pull(var_name))
  ) + 
  labs(
    x = NULL,
    y = NULL,
    title = "Male"
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_male_hrs %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(feature) %>% as.character(), 
    label = paste0("italic(R)^2 == ", "'", format(round(rsq_boot_xgb_male_hrs$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_male_hrs %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(feature) %>% as.character(), 
    label = paste0("MAE == ", "'", format(round(mae_boot_xgb_male_hrs$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_male_hrs %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(feature) %>% as.character(), 
    label = paste0("RMSE == ", "'", format(round(rmse_boot_xgb_male_hrs$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

meanSHAP_plot_male_hrs <- shp_imp_var_male_hrs %>% 
  slice_tail(n = 20) %>%
  mutate(
    perform = "Mean absolute SHAP value",
    value_label = format(round(value, 4), big.mark = ",")
  )

p_meanSHAP_male_hrs <- ggplot(meanSHAP_plot_male_hrs, aes(x = perform, y = var_name, fill = category)) +
  geom_tile(color = "white") +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12, angle = 00),
    axis.text.y = element_text(size = 12, colour = "black", vjust = 0.5, hjust = 1, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.6, r = 0, b = 1.07, l = 0), "cm")
    ) +
  scale_x_discrete(labels = "") + 
  scale_colour_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC"),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_sv_male_hrs <- grid.arrange(p_meanSHAP_male_hrs, sv_male_hrs, ncol = 2, widths = c(1, 1.7)) %>% 
  wrap_elements()

# 5064
sv_5064_hrs <- sv_importance(
  shp_5064_hrs, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma")) + 
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 1, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
  ) +
  scale_y_discrete(
    labels = as.character(shp_imp_var_5064_hrs %>% tail(20) %>% pull(var_name))
  ) + 
  labs(
    x = NULL,
    y = NULL,
    title = "<65 years"
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_5064_hrs %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(feature) %>% as.character(), 
    label = paste0("italic(R)^2 == ", "'", format(round(rsq_boot_xgb_5064_hrs$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_5064_hrs %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(feature) %>% as.character(), 
    label = "MAE == '0.050'",
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_5064_hrs %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(feature) %>% as.character(), 
    label = paste0("RMSE == ", "'", format(round(rmse_boot_xgb_5064_hrs$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

meanSHAP_plot_5064_hrs <- shp_imp_var_5064_hrs %>% 
  slice_tail(n = 20) %>%
  mutate(
    perform = "Mean absolute SHAP value",
    value_label = format(round(value, 4), big.mark = ",")
  )

p_meanSHAP_5064_hrs <- ggplot(meanSHAP_plot_5064_hrs, aes(x = perform, y = var_name, fill = category)) +
  geom_tile(color = "white") +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12, angle = 00),
    axis.text.y = element_text(size = 12, colour = "black", vjust = 0.5, hjust = 1, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.6, r = 0, b = 1.07, l = 0), "cm")
    ) +
  scale_x_discrete(labels = "") + 
  scale_colour_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC"),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_sv_5064_hrs <- grid.arrange(p_meanSHAP_5064_hrs, sv_5064_hrs, ncol = 2, widths = c(1, 1.7)) %>% 
  wrap_elements()


# 65 plus
sv_65plus_hrs <- sv_importance(
  shp_65plus_hrs, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma")) + 
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 1, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
  ) +
  scale_y_discrete(
    labels = as.character(shp_imp_var_65plus_hrs %>% tail(20) %>% pull(var_name))
  ) + 
  labs(
    x = NULL,
    y = NULL,
    title = "≥65 years"
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_65plus_hrs %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(feature) %>% as.character(), 
    label = paste0("italic(R)^2 == ", "'", format(round(rsq_boot_xgb_65plus_hrs$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_65plus_hrs %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(feature) %>% as.character(), 
    label = paste0("MAE == ", "'", format(round(mae_boot_xgb_65plus_hrs$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_65plus_hrs %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(feature) %>% as.character(), 
    label = paste0("RMSE == ", "'", format(round(rmse_boot_xgb_65plus_hrs$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

meanSHAP_plot_65plus_hrs <- shp_imp_var_65plus_hrs %>% 
  slice_tail(n = 20) %>%
  mutate(
    perform = "Mean absolute SHAP value",
    value_label = format(round(value, 4), big.mark = ",")
  )

p_meanSHAP_65plus_hrs <- ggplot(meanSHAP_plot_65plus_hrs, aes(x = perform, y = var_name, fill = category)) +
  geom_tile(color = "white") +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12, angle = 00),
    axis.text.y = element_text(size = 12, colour = "black", vjust = 0.5, hjust = 1, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.6, r = 0, b = 1.07, l = 0), "cm")
    ) +
  scale_x_discrete(labels = "") + 
  scale_colour_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", 
               "#00A087CC",
               "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC"),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_sv_65plus_hrs <- grid.arrange(p_meanSHAP_65plus_hrs, sv_65plus_hrs, ncol = 2, widths = c(1, 1.7)) %>% 
  wrap_elements()


p_sv_subgroup_hrs <- wrap_elements(
  p_sv_female_hrs + p_sv_male_hrs + p_sv_5064_hrs + p_sv_65plus_hrs +
  plot_layout(ncol = 4, guides = "collect") +
  plot_annotation(
    title = "HRS (USA)",
    theme = theme(plot.title = element_text(size = 20, face = "bold", hjust = .5))
  )
)

#### ELSA ####
# female
sv_female_elsa <- sv_importance(
  shp_female_elsa, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma")) + 
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 1, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
  ) +
  scale_y_discrete(
    labels = as.character(shp_imp_var_female_elsa %>% tail(20) %>% pull(var_name))
  ) + 
  labs(
    x = NULL,
    y = NULL,
    title = "Female"
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_female_elsa %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(feature) %>% as.character(), 
    label = paste0("italic(R)^2 == ", "'", format(round(rsq_boot_xgb_female_elsa$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_female_elsa %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(feature) %>% as.character(), 
    label = paste0("MAE == ", "'", format(round(mae_boot_xgb_female_elsa$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_female_elsa %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(feature) %>% as.character(), 
    label = paste0("RMSE == ", "'", format(round(rmse_boot_xgb_female_elsa$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

meanSHAP_plot_female_elsa <- shp_imp_var_female_elsa %>% 
  slice_tail(n = 20) %>%
  mutate(
    perform = "Mean absolute SHAP value",
    value_label = format(round(value, 4), big.mark = ",")
  )

p_meanSHAP_female_elsa <- ggplot(meanSHAP_plot_female_elsa, aes(x = perform, y = var_name, fill = category)) +
  geom_tile(color = "white") +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12, angle = 00),
    axis.text.y = element_text(size = 12, colour = "black", vjust = 0.5, hjust = 1, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.6, r = 0, b = 1.07, l = 0), "cm")
    ) +
  scale_x_discrete(labels = "") + 
  scale_colour_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", 
               # "#00A087CC", 
               "#3C5488CC", "#F39B7FCC", "#8491B4CC"#, 
               # "#91D1C2CC"
               ),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_sv_female_elsa <- grid.arrange(p_meanSHAP_female_elsa, sv_female_elsa, ncol = 2, widths = c(1, 1.75)) %>% 
  wrap_elements()

# male
sv_male_elsa <- sv_importance(
  shp_male_elsa, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma")) + 
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 1, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_y_discrete(
    labels = as.character(shp_imp_var_male_elsa %>% tail(20) %>% pull(var_name))
  ) + 
  labs(
    x = NULL,
    y = NULL,
    title = "Male"
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_male_elsa %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(feature) %>% as.character(), 
    label = paste0("italic(R)^2 == ", "'", format(round(rsq_boot_xgb_male_elsa$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_male_elsa %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(feature) %>% as.character(), 
    label = paste0("MAE == ", "'", format(round(mae_boot_xgb_male_elsa$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_male_elsa %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(feature) %>% as.character(), 
    label = paste0("RMSE == ", "'", format(round(rmse_boot_xgb_male_elsa$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

meanSHAP_plot_male_elsa <- shp_imp_var_male_elsa %>% 
  slice_tail(n = 20) %>%
  mutate(
    perform = "Mean absolute SHAP value",
    value_label = format(round(value, 4), big.mark = ",")
  )

p_meanSHAP_male_elsa <- ggplot(meanSHAP_plot_male_elsa, aes(x = perform, y = var_name, fill = category)) +
  geom_tile(color = "white") +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12, angle = 00),
    axis.text.y = element_text(size = 12, colour = "black", vjust = 0.5, hjust = 1, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.6, r = 0, b = 1.07, l = 0), "cm")
    ) +
  scale_x_discrete(labels = "") + 
  scale_colour_manual(
    values = c("#B09C85CC", 
               # "#E64B35CC", 
               "#4DBBD5CC", "#00A087CC", 
               "#3C5488CC", "#F39B7FCC", "#8491B4CC"
               # "#91D1C2CC"
               ),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_sv_male_elsa <- grid.arrange(p_meanSHAP_male_elsa, sv_male_elsa, ncol = 2, widths = c(1, 1.8)) %>% 
  wrap_elements()

# 5064
sv_5064_elsa <- sv_importance(
  shp_5064_elsa, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma")) + 
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 1, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
  ) +
  scale_y_discrete(
    labels = as.character(shp_imp_var_5064_elsa %>% tail(20) %>% pull(var_name))
  ) + 
  labs(
    x = NULL,
    y = NULL,
    title = "<65 years"
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_5064_elsa %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(feature) %>% as.character(), 
    label = paste0("italic(R)^2 == ", "'", format(round(rsq_boot_xgb_5064_elsa$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_5064_elsa %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(feature) %>% as.character(), 
    label = paste0("MAE == ", "'", format(round(mae_boot_xgb_5064_elsa$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_5064_elsa %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(feature) %>% as.character(), 
    label = paste0("RMSE == ", "'", format(round(rmse_boot_xgb_5064_elsa$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

meanSHAP_plot_5064_elsa <- shp_imp_var_5064_elsa %>% 
  slice_tail(n = 20) %>%
  mutate(
    perform = "Mean absolute SHAP value",
    value_label = format(round(value, 4), big.mark = ",")
  )

p_meanSHAP_5064_elsa <- ggplot(meanSHAP_plot_5064_elsa, aes(x = perform, y = var_name, fill = category)) +
  geom_tile(color = "white") +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12, angle = 00),
    axis.text.y = element_text(size = 12, colour = "black", vjust = 0.5, hjust = 1, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.6, r = 0, b = 1.07, l = 0), "cm")
    ) +
  scale_x_discrete(labels = "") + 
  scale_colour_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC"
               # "#91D1C2CC"
               ),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_sv_5064_elsa <- grid.arrange(p_meanSHAP_5064_elsa, sv_5064_elsa, ncol = 2, widths = c(1, 1.3)) %>% 
  wrap_elements()


# 65 plus
sv_65plus_elsa <- sv_importance(
  shp_65plus_elsa, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma")) + 
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 1, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
  ) +
  scale_y_discrete(
    labels = as.character(shp_imp_var_65plus_elsa %>% tail(20) %>% pull(var_name))
  ) + 
  labs(
    x = NULL,
    y = NULL,
    title = "≥65 years"
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_65plus_elsa %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(feature) %>% as.character(), 
    label = "italic(R)^2 == '0.130'",
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_65plus_elsa %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(feature) %>% as.character(), 
    label = paste0("MAE == ", "'", format(round(mae_boot_xgb_65plus_elsa$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_65plus_elsa %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(feature) %>% as.character(), 
    label = paste0("RMSE == ", "'", format(round(rmse_boot_xgb_65plus_elsa$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

meanSHAP_plot_65plus_elsa <- shp_imp_var_65plus_elsa %>% 
  slice_tail(n = 20) %>%
  mutate(
    perform = "Mean absolute SHAP value",
    value_label = format(round(value, 4), big.mark = ",")
  )

p_meanSHAP_65plus_elsa <- ggplot(meanSHAP_plot_65plus_elsa, aes(x = perform, y = var_name, fill = category)) +
  geom_tile(color = "white") +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12, angle = 00),
    axis.text.y = element_text(size = 12, colour = "black", vjust = 0.5, hjust = 1, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.6, r = 0, b = 1.07, l = 0), "cm")
    ) +
  scale_x_discrete(labels = "") + 
  scale_colour_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC"),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_sv_65plus_elsa <- grid.arrange(p_meanSHAP_65plus_elsa, sv_65plus_elsa, ncol = 2, widths = c(1, 1.55)) %>% 
  wrap_elements()


p_sv_subgroup_elsa <- wrap_elements(
  p_sv_female_elsa + p_sv_male_elsa + p_sv_5064_elsa + p_sv_65plus_elsa +
  plot_layout(ncol = 4, guides = "collect") +
  plot_annotation(
    title = "ELSA (England)",
    theme = theme(plot.title = element_text(size = 20, face = "bold", hjust = .5))
  )
)

#### CHARLS ####
# female
sv_female_charls <- sv_importance(
  shp_female_charls, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma")) + 
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 1, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
  ) +
  scale_y_discrete(
    labels = as.character(shp_imp_var_female_charls %>% tail(20) %>% pull(var_name))
  ) + 
  labs(
    x = NULL,
    y = NULL,
    title = "Female"
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_female_charls %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(feature) %>% as.character(), 
    label = paste0("italic(R)^2 == ", "'", format(round(rsq_boot_xgb_female_charls$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_female_charls %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(feature) %>% as.character(), 
    label = paste0("MAE == ", "'", format(round(mae_boot_xgb_female_charls$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_female_charls %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(feature) %>% as.character(), 
    label = paste0("RMSE == ", "'", format(round(rmse_boot_xgb_female_charls$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

meanSHAP_plot_female_charls <- shp_imp_var_female_charls %>% 
  slice_tail(n = 20) %>%
  mutate(
    perform = "Mean absolute SHAP value",
    value_label = format(round(value, 4), big.mark = ",")
  )

p_meanSHAP_female_charls <- ggplot(meanSHAP_plot_female_charls, aes(x = perform, y = var_name, fill = category)) +
  geom_tile(color = "white") +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12, angle = 00),
    axis.text.y = element_text(size = 12, colour = "black", vjust = 0.5, hjust = 1, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.6, r = 0, b = 1.07, l = 0), "cm")
    ) +
  scale_x_discrete(labels = "") + 
  scale_colour_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC"),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_sv_female_charls <- grid.arrange(p_meanSHAP_female_charls, sv_female_charls, ncol = 2, widths = c(1, 1.3)) %>% 
  wrap_elements()

# male
sv_male_charls <- sv_importance(
  shp_male_charls, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma")) + 
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 1, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
  ) +
  scale_y_discrete(
    labels = as.character(shp_imp_var_male_charls %>% tail(20) %>% pull(var_name))
  ) + 
  labs(
    x = NULL,
    y = NULL,
    title = "Male"
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_male_charls %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(feature) %>% as.character(), 
    label = paste0("italic(R)^2 == ", "'", format(round(rsq_boot_xgb_male_charls$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_male_charls %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(feature) %>% as.character(), 
    label = paste0("MAE == ", "'", format(round(mae_boot_xgb_male_charls$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_male_charls %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(feature) %>% as.character(), 
    label = paste0("RMSE == ", "'", format(round(rmse_boot_xgb_male_charls$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

meanSHAP_plot_male_charls <- shp_imp_var_male_charls %>% 
  slice_tail(n = 20) %>%
  mutate(
    perform = "Mean absolute SHAP value",
    value_label = format(round(value, 4), big.mark = ",")
  )

p_meanSHAP_male_charls <- ggplot(meanSHAP_plot_male_charls, aes(x = perform, y = var_name, fill = category)) +
  geom_tile(color = "white") +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12, angle = 00),
    axis.text.y = element_text(size = 12, colour = "black", vjust = 0.5, hjust = 1, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.6, r = 0, b = 1.07, l = 0), "cm")
    ) +
  scale_x_discrete(labels = "") + 
  scale_colour_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC"),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_sv_male_charls <- grid.arrange(p_meanSHAP_male_charls, sv_male_charls, ncol = 2, widths = c(1, 1.3)) %>% 
  wrap_elements()

# 5064
sv_5064_charls <- sv_importance(
  shp_5064_charls, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma")) + 
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 1, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_y_discrete(
    labels = as.character(shp_imp_var_5064_charls %>% tail(20) %>% pull(var_name))
  ) + 
  labs(
    x = NULL,
    y = NULL,
    title = "<65 years"
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_5064_charls %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(feature) %>% as.character(), 
    label = paste0("italic(R)^2 == ", "'", format(round(rsq_boot_xgb_5064_charls$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_5064_charls %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(feature) %>% as.character(), 
    label = paste0("MAE == ", "'", format(round(mae_boot_xgb_5064_charls$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_5064_charls %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(feature) %>% as.character(), 
    label = paste0("RMSE == ", "'", format(round(rmse_boot_xgb_5064_charls$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

meanSHAP_plot_5064_charls <- shp_imp_var_5064_charls %>% 
  slice_tail(n = 20) %>%
  mutate(
    perform = "Mean absolute SHAP value",
    value_label = format(round(value, 4), big.mark = ",")
  )

p_meanSHAP_5064_charls <- ggplot(meanSHAP_plot_5064_charls, aes(x = perform, y = var_name, fill = category)) +
  geom_tile(color = "white") +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12, angle = 00),
    axis.text.y = element_text(size = 12, colour = "black", vjust = 0.5, hjust = 1, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.6, r = 0, b = 1.07, l = 0), "cm")
    ) +
  scale_x_discrete(labels = "") + 
  scale_colour_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", 
               # "#3C5488CC", 
               "#F39B7FCC", "#8491B4CC", "#91D1C2CC"),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_sv_5064_charls <- grid.arrange(p_meanSHAP_5064_charls, sv_5064_charls, ncol = 2, widths = c(1, 1.3)) %>% 
  wrap_elements()


# 65 plus
sv_65plus_charls <- sv_importance(
  shp_65plus_charls, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma")) + 
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 1, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain"),
  ) +
  scale_y_discrete(
    labels = as.character(shp_imp_var_65plus_charls %>% tail(20) %>% pull(var_name))
  ) + 
  labs(
    x = NULL,
    y = NULL,
    title = "≥65 years"
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_65plus_charls %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(feature) %>% as.character(), 
    label = "italic(R)^2 == '0.090'",
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_65plus_charls %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(feature) %>% as.character(), 
    label = paste0("MAE == ", "'", format(round(mae_boot_xgb_65plus_charls$t0, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = Inf,
    y = shp_imp_var_65plus_charls %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(feature) %>% as.character(), 
    label = "RMSE == '0.090'",
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

meanSHAP_plot_65plus_charls <- shp_imp_var_65plus_charls %>% 
  slice_tail(n = 20) %>%
  mutate(
    perform = "Mean absolute SHAP value",
    value_label = format(round(value, 4), big.mark = ",")
  )

p_meanSHAP_65plus_charls <- ggplot(meanSHAP_plot_65plus_charls, aes(x = perform, y = var_name, fill = category)) +
  geom_tile(color = "white") +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12, angle = 00),
    axis.text.y = element_text(size = 12, colour = "black", vjust = 0.5, hjust = 1, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.6, r = 0, b = 1.07, l = 0), "cm")
    ) +
  scale_x_discrete(labels = "") + 
  scale_colour_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", 
               # "#3C5488CC", 
               "#F39B7FCC", "#8491B4CC"#, "#91D1C2CC"
               ),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_sv_65plus_charls <- grid.arrange(p_meanSHAP_65plus_charls, sv_65plus_charls, ncol = 2, widths = c(1, 1.65)) %>% 
  wrap_elements()

p_sv_subgroup_charls <- wrap_elements(
  p_sv_female_charls + p_sv_male_charls + p_sv_5064_charls + p_sv_65plus_charls +
  plot_layout(ncol = 4, guides = "collect") +
  plot_annotation(
    title = "CHARLS (China)",
    theme = theme(plot.title = element_text(size = 20, face = "bold", hjust = .5))
  )
)

#### pool ####
legend_1_data <- sv_importance(
  shp_male_hrs, kind = "beeswarm", max_display = 20, 
  viridis_args = list(begin = 0.25, end = 0.85, option = "magma"))$data

# magma(5, alpha = 1, begin = 0.25, end = 0.85, direction = 1)
# https://jmsallan.netlify.app/blog/the-viridis-palettes/
legend_1 <- ggplot(legend_1_data, aes(x = value, y = feature)) +
  geom_vline(xintercept = 0, color = "darkgray") +
  geom_point(aes(color = color), position = position_bee(width = 0.4, adjust = 0.5)) +
  theme(legend.position = "bottom") +
  scale_colour_gradientn(
    colours = c("#51127CFF", "#8C2981FF", "#CB3E72FF", "#F76F5CFF", "#FEB77EFF"),
    breaks = c(0, 0.25, 0.5, 0.75, 1),
    limit = c(0, 1),
    labels = c("Low", "", "", "", "High"),
    space = "Lab",
    name = "Feature value") +
  guides(colour =
    guide_colourbar(
      barwidth = unit(7.5, "cm"), barheight = unit(0.5, "cm"),
      title.position = "top",
      title.theme = element_text(size = 20, colour = "black", angle = 0, hjust = .5),
      label.theme = element_text(size = 20, colour = "black", angle = 0)
      )
    )

legend_2 <- ggplot(shp_imp_var_overall_hrs %>% slice_tail(n = 50), aes(x = var_name, y = value, fill = category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC"),
  ) + 
  guides(fill = guide_legend(byrow = F)) +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 20),
    legend.position = "bottom",
    legend.key.size = unit(1.5, "lines")
    )


legend <- wrap_elements(
  (wrap_elements(ggpubr::get_legend(legend_2)) + wrap_elements(ggpubr::get_legend(legend_1))) +
  plot_layout(widths = c(1.5, 1))
  )

bottom <- textGrob("SHAP value", gp = gpar(fontsize = 20, col = "black"))

p_sv_subgroup_all <- wrap_elements(
  (p_sv_subgroup_hrs / p_sv_subgroup_elsa / p_sv_subgroup_charls) + 
    plot_annotation(tag_levels = "a") &
    theme(
      plot.tag = element_text(size = 20, face = "bold")
    )
  ) / bottom +
  plot_layout(heights = c(100,1))

sv_subgroup_pool <- wrap_plots(p_sv_subgroup_all, legend, nrow = 2, heights = c(9,1))

ggsave(str_c(getwd(), "/results/Figure/SHAP beewarm plot-subgroups.png", sep = ""), plot = sv_subgroup_pool, width = 32, height = 30, unit = "in", dpi = 300, device = "png") 

ggsave(str_c(getwd(), "/results/Figure/SHAP beewarm plot-subgroups.pdf", sep = ""), plot = sv_subgroup_pool, width = 32, height = 30, unit = "in", dpi = 300, device = "pdf")

```


### SHAP dependence plot

#### Figure 5

##### BMI

```{r}

#### HRS ####
p_bmi_overall_hrs <- sv_dependence(
  shp_overall_hrs, v = "bmi", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(10,60),
    breaks = seq(10, 60, by = 5),
  ) +
  labs(
    x = expression(paste("kg/", "m"^2)),
    y = "SHAP value", 
    title = "HRS (USA)"
  )


#### ELSA ####
p_bmi_overall_elsa <- sv_dependence(
  shp_overall_elsa, v = "mbmi", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(10,60),
    breaks = seq(10, 60, by = 5),
  ) +
  labs(
    x = expression(paste("kg/", "m"^2)),
    y = "", 
    title = "ELSA (England)"
  )


#### CHARLS ####
p_bmi_overall_charls <- sv_dependence(
  shp_overall_charls, v = "mbmi", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(10,60),
    breaks = seq(10, 60, by = 5),
  ) +
  labs(
    x = expression(paste("kg/", "m"^2)),
    y = "", 
    title = "CHARLS (China)"
  )

#### pool ####
p_bmi_dependence_overall <- wrap_elements(
  p_bmi_overall_hrs + p_bmi_overall_elsa + p_bmi_overall_charls +
  plot_annotation(
    title = expression(paste(bold("a"), "  Body mass index")),
    theme = theme(plot.title = element_text(size = 20))
    )
  )

```

##### Sleep duration

```{r}

#### ELSA ####
p_sleeph_overall_elsa <- sv_dependence(
  shp_overall_elsa, v = "sleeph", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain"),
    ) +
  scale_x_continuous(
    limits = c(0,14),
    breaks = seq(0, 14, by = 1),
  ) +
  labs(
    x = "Hour", 
    y = "SHAP value", 
    title = "ELSA (England)"
  )

#### CHARLS ####
p_sleeph_overall_charls <- sv_dependence(
  shp_overall_charls, v = "sleep", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(0,14),
    breaks = seq(0, 14, by = 1),
  ) +
  labs(
    x = "Hour",
    y = "", 
    title = "CHARLS (China)"
  )

#### HRS ####
p_sleeph_overall_hrs <- sv_dependence(
  shp_overall_hrs, v = "sleep", interactions = F, color_var = NULL, color = "#002e8c") +
  theme_void() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = 1, b = .25, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(10,30),
  ) +
  labs(
    x = "", 
    y = "", 
    title = ""
  )

#### pool ####
p_sleep_duration_dependence_overall <- wrap_elements(
  p_sleeph_overall_elsa + p_sleeph_overall_charls + p_sleeph_overall_hrs +
  plot_annotation(
    title = expression(paste(bold("b"), "  Sleep duration")),
    theme = theme(plot.title = element_text(size = 20))
    )
  )

```

##### Fruit and vegetables

```{r}

#### ELSA ####
p_fruit_overall_elsa <- sv_dependence(
  shp_overall_elsa, v = "fruit", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain"),
    ) +
  scale_x_continuous(
    limits = c(0,23),
    breaks = seq(0, 23, by = 2.5),
  ) +
  labs(
    x = "Fruit, portion", 
    y = "SHAP value", 
    title = "ELSA (England)"
  )


#### ELSA ####
p_veg_overall_elsa <- sv_dependence(
  shp_overall_elsa, v = "vegetable", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(0,23),
    breaks = seq(0, 23, by = 2.5)
  ) +
  labs(
    x = "Vegetable, portion", 
    y = "", 
    title = "ELSA (England)"
  )

#### CHARLS ####
p_veg_overall_charls <- sv_dependence(
  shp_overall_hrs, v = "sleep", interactions = F, color_var = NULL, color = "#002e8c") +
  theme_void() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0.5, r = 1, b = .25, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(limits = c(10,30)) +
  labs(
    x = "", 
    y = "", 
    title = ""
  )

#### pool ####
p_fv_dependence_overall <- wrap_elements(
  p_fruit_overall_elsa + p_veg_overall_elsa + p_veg_overall_charls+ 
  plot_annotation(
    title = expression(paste(bold("c"), "  Fruit and vegetable consumption")),
    theme = theme(plot.title = element_text(size = 20))
    )
  )

```


##### Watch TV

```{r}

#### HRS ####
p_tv_overall_hrs <- sv_dependence(
  shp_overall_hrs, v = "tv", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain"),
    ) +
  scale_x_continuous(
    limits = c(0.5,7.5),
    breaks = seq(1, 7, by = 1)
  ) +
  labs(
    x = "Frequency", 
    y = "SHAP value", 
    title = "HRS (USA)"
  )


#### ELSA ####
p_tv_overall_elsa <- sv_dependence(
  shp_overall_elsa, v = "tvtime", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain"),
    ) +
  scale_x_continuous(
    limits = c(0,24),
    breaks = seq(0, 24, by = 2),
  ) +
  labs(
    x = "Hour", 
    y = "", 
    title = "ELSA (England)"
  )

#### CHARLS ####
p_tv_overall_charls <- sv_dependence(
  shp_overall_hrs, v = "sleep", interactions = F, color_var = NULL, color = "#002e8c") +
  theme_void() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0.5, r = 1, b = .25, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain"),
    ) +
  scale_x_continuous(limits = c(10,30)) +
  labs(
    x = "", 
    y = "", 
    title = ""
  )

#### pool ####
p_tv_dependence_overall <- wrap_elements(
  p_tv_overall_hrs + p_tv_overall_elsa + p_tv_overall_charls+ 
  plot_annotation(
    title = expression(paste(bold("d"), "  Watching television")),
    theme = theme(plot.title = element_text(size = 20))
    )
  )

```


##### Pool

```{r}

p_pool_dependence_overall <- wrap_elements(
  p_bmi_dependence_overall +
  p_sleep_duration_dependence_overall +
  p_fv_dependence_overall + 
  p_tv_dependence_overall +
  plot_layout(nrow = 4)
  )

ggsave(str_c(getwd(), "/results/Figure/Dependence plot.png", sep = ""), plot = p_pool_dependence_overall, width = 15, height = 13, unit = "in", dpi = 300, device = "png") 

ggsave(str_c(getwd(), "/results/Figure/Dependence plot.pdf", sep = ""), plot = p_pool_dependence_overall, width = 15, height = 13, unit = "in", dpi = 300, device = "pdf")


```

#### Supplementary Figure 3

##### Wealth

```{r}

#### HRS ####
p_wealth_overall_hrs <- sv_dependence(
  shp_overall_hrs, v = "atotb", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(min(shp_overall_hrs$X$atotb), max(shp_overall_hrs$X$atotb)),
    breaks = c(0, 1e+07, 2e+07),
    labels = scientific_10
  ) +
  labs(
    x = "Dollars",
    y = "SHAP value", 
    title = "HRS (USA)"
  )


#### ELSA ####
p_wealth_overall_elsa <- sv_dependence(
  shp_overall_elsa, v = "atotb", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(min(shp_overall_elsa$X$atotb), max(shp_overall_elsa$X$atotb)),
    breaks = c(0, 2e+06, 4e+06, 6e+06),
    labels = scientific_10
  ) +
  labs(
    x = "Pound",
    y = "", 
    title = "ELSA (England)"
  )


#### CHARLS ####
p_wealth_overall_charls <- sv_dependence(
  shp_overall_charls, v = "atotb", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(min(shp_overall_charls$X$atotb), max(shp_overall_charls$X$atotb)),
    breaks = c(0, 2e+07, 4e+07, 6e+07, 8e+07),
    labels = scientific_10
  ) +
  labs(
    x = "Yuan",
    y = "", 
    title = "CHARLS (China)"
  )

#### pool ####
p_wealth_dependence_overall <- wrap_elements(
  p_wealth_overall_hrs + p_wealth_overall_elsa + p_wealth_overall_charls +
  plot_annotation(
    title = expression(paste(bold("a"), "  Household wealth")),
    theme = theme(plot.title = element_text(size = 20))
    )
  )

```

##### Income

```{r}

#### HRS ####
p_income_overall_hrs <- sv_dependence(
  shp_overall_hrs, v = "itot", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(min(shp_overall_hrs$X$itot), max(shp_overall_hrs$X$itot)),
    breaks = c(0, 1e+06, 2e+06),
    labels = scientific_10
  ) +
  labs(
    x = "Dollars",
    y = "SHAP value", 
    title = "HRS (USA)"
  )


#### ELSA ####
p_income_overall_elsa <- sv_dependence(
  shp_overall_elsa, v = "itot", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(min(shp_overall_elsa$X$itot), max(shp_overall_elsa$X$itot)),
    breaks = c(0, 1e+05, 2e+05, 3e+05, 4e+05),
    labels = scientific_10
  ) +
  labs(
    x = "Pound",
    y = "", 
    title = "ELSA (England)"
  )

#### CHARLS ####
p_income_overall_charls <- sv_dependence(
  shp_overall_hrs, v = "sleep", interactions = F, color_var = NULL, color = "#002e8c") +
  theme_void() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0.5, r = 1, b = .25, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(limits = c(10,30)) +
  labs(
    x = "", 
    y = "", 
    title = ""
  )

#### pool ####
p_income_dependence_overall <- wrap_elements(
  p_income_overall_hrs + p_income_overall_elsa + 
  plot_annotation(
    title = expression(paste(bold("b"), "  Annual household income")),
    theme = theme(plot.title = element_text(size = 20))
    )
  )

```


##### Government health insurance

```{r}

#### HRS ####
p_higov_overall_hrs <- sv_dependence(
  shp_overall_hrs, v = "higov_yes", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    breaks = c(0, 1),
    labels = c("No", "Yes")
  ) +
  labs(
    x = "", 
    y = "SHAP value", 
    title = "HRS (USA)"
  )


#### CHARLS ####
p_higov_overall_charls <- sv_dependence(
  shp_overall_charls, v = "higov_yes", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    breaks = c(0, 1),
    labels = c("No", "Yes")
  ) +
  labs(
    x = "",
    y = "", 
    title = "CHARLS (China)"
  )

#### ELSA ####
p_higov_overall_elsa <- sv_dependence(
  shp_overall_hrs, v = "sleep", interactions = F, color_var = NULL, color = "#002e8c") +
  theme_void() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = 1, b = .25, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain"),
    ) +
  scale_x_continuous(limits = c(10,30)) +
  labs(
    x = "", 
    y = "", 
    title = ""
  )

#### pool ####
p_higov_dependence_overall <- wrap_elements(
  p_higov_overall_hrs + p_higov_overall_charls + 
  plot_annotation(
    title = expression(paste(bold("c"), "  Government health insurance")),
    theme = theme(plot.title = element_text(size = 20))
    )
  )

```


##### Out-of-pocket

```{r}

#### HRS ####
p_oop_overall_hrs <- sv_dependence(
  shp_overall_hrs, v = "oopmd", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain"),
    ) +
  scale_x_continuous(
    limits = c(min(shp_overall_hrs$X$oopmd), max(shp_overall_hrs$X$oopmd + 1000)),
  ) +
  labs(
    x = "Dollars",
    y = "SHAP value", 
    title = "HRS (USA)"
  )

#### CHARLS ####
p_oophos_overall_charls <- sv_dependence(
  shp_overall_charls, v = "oophos1y", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain"),
    ) +
  scale_x_continuous(
    limits = c(min(shp_overall_charls$X$oophos1y), max(shp_overall_charls$X$oophos1y + 2000))
  ) +
  labs(
    x = "Hospitalization, Yuan",
    y = "", 
    title = "CHARLS (China)"
  )

#### CHARLS ####
p_oopdoc_overall_charls <- sv_dependence(
  shp_overall_charls, v = "oopdoc1m", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain"),
    ) +
  labs(
    x = "Doctor visit, Yuan",
    y = "", 
    title = "CHARLS (China)"
  )

#### CHARLS ####
p_oopden_overall_charls <- sv_dependence(
  shp_overall_charls, v = "oopden1y", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain"),
    ) +
  labs(
    x = "Dental care, Yuan",
    y = "", 
    title = "CHARLS (China)"
  )

#### pool ####
p_oop_dependence_overall <- wrap_elements(
  p_oop_overall_hrs + p_oophos_overall_charls + p_oopdoc_overall_charls + 
  p_oopden_overall_charls +
  plot_layout(nrow = 1, ncol = 4) +
  plot_annotation(
    title = expression(paste(bold("d"), "  Out-of-pocket medical expenditure")),
    theme = theme(plot.title = element_text(size = 20))
    )
  )

```


##### Smoking

```{r}

#### HRS ####
p_smoke_overall_hrs <- sv_dependence(
  shp_overall_hrs, v = "smoken_yes", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    breaks = c(0, 1),
    labels = c("No", "Yes")
  ) +
  labs(
    x = "", 
    y = "SHAP value", 
    title = "HRS (USA)"
  )

#### HRS ####
p_smoke_overall_elsa <- sv_dependence(
  shp_overall_elsa, v = "smoken_yes", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    breaks = c(0, 1),
    labels = c("No", "Yes")
  ) +
  labs(
    x = "", 
    y = "", 
    title = "ELSA (England)"
  )

#### CHARLS ####
p_smoke_overall_charls <- sv_dependence(
  shp_overall_charls, v = "smoken_yes", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    breaks = c(0, 1),
    labels = c("No", "Yes")
  ) +
  labs(
    x = "",
    y = "", 
    title = "CHARLS (China)"
  )


#### pool ####
p_smoke_dependence_overall <- wrap_elements(
  p_smoke_overall_hrs + p_smoke_overall_elsa + p_smoke_overall_charls + 
  plot_annotation(
    title = expression(paste(bold("e"), "  Current smoking")),
    theme = theme(plot.title = element_text(size = 20))
    )
  )

```


##### Drinking frequency

```{r}

#### ELSA ####
p_drink_overall_elsa <- sv_dependence(
  shp_overall_elsa, v = "drink_e", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain"),
    ) +
  labs(
    x = "Frequency", 
    y = "SHAP value", 
    title = "ELSA (England)"
  )

#### CHARLS ####
p_drinkn_overall_charls <- sv_dependence(
  shp_overall_charls, v = "drinkn_c", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),

    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  labs(
    x = "Frequency", 
    y = "", 
    title = "CHARLS (China)"
  )

#### HRS ####
p_drink_overall_hrs <- sv_dependence(
  shp_overall_hrs, v = "sleep", interactions = F, color_var = NULL, color = "#002e8c") +
  theme_void() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = 1.5, b = .25, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(limits = c(10,30)) +
  labs(
    x = "", 
    y = "", 
    title = NULL
  )

#### pool ####
p_drink_freq_dependence_overall <- wrap_elements(
  p_drink_overall_elsa + p_drinkn_overall_charls + 
  plot_annotation(
    title = expression(paste(bold("f"), "  Higher drinking frequency")),
    theme = theme(plot.title = element_text(size = 20))
    )
  )

```


##### Drinking number

```{r}

#### HRS ####
p_drinkdn_overall_hrs <- sv_dependence(
  shp_overall_hrs, v = "drinkdn", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(limits = c(0,105)) +
  labs(
    x = "Number", 
    y = "SHAP value", 
    title = "HRS (USA)"
  )


#### ELSA ####
p_drinkwn_overall_elsa <- sv_dependence(
  shp_overall_elsa, v = "drinkwn_e", interactions = F, color_var = NULL, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(limits = c(0,56)) +
  labs(
    x = "Number", 
    y = "", 
    title = "ELSA (England)"
  )

#### CHARLS ####
p_drinkn_overall_charls <- sv_dependence(
  shp_overall_hrs, v = "sleep", interactions = F, color_var = NULL, color = "#002e8c") +
  theme_void() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0.5, r = 1, b = .25, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(limits = c(10,30)) +
  labs(
    x = "", 
    y = "", 
    title = NULL
  )

#### pool ####
p_drink_number_dependence_overall <- wrap_elements(
  p_drinkdn_overall_hrs + p_drinkwn_overall_elsa +
  plot_annotation(
    title = expression(paste(bold("g"), "  Total number of drinks per week")),
    theme = theme(plot.title = element_text(size = 20))
    )
  )

```

##### Pool

```{r}

design <- "
AAA#
BBCC
DDDD
EEE#
FFGG
"

p_pool_dependence_overall_sup <- wrap_elements(
  p_wealth_dependence_overall + p_income_dependence_overall + 
  p_higov_dependence_overall + p_oop_dependence_overall +
  p_smoke_dependence_overall + p_drink_freq_dependence_overall +
  p_drink_number_dependence_overall +
  plot_layout(design = design)
  )

ggsave(str_c(getwd(), "/results/Figure/Dependence plot_supplementary.png", sep = ""), plot = p_pool_dependence_overall_sup, width = 18, height = 16, unit = "in", dpi = 300, device = "png") 

ggsave(str_c(getwd(), "/results/Figure/Dependence plot_supplementary.pdf", sep = ""), plot = p_pool_dependence_overall_sup, width = 18, height = 16, unit = "in", dpi = 300, device = "pdf")


```

## Figure 3: Domian-wise

```{r}

#### HRS ####
shap_domain_plot_hrs <- shp_imp_cate_overall_hrs %>% 
  mutate(
    category = factor(category, levels = category),
    perc = round(value_normalized*100, 1),
    perc = ifelse(perc < 10, NA, perc),
    group = "Overall"
  ) %>%
  dplyr::select(category, value_normalized, perc, group) %>% 
    bind_rows(
      shp_imp_cate_male_hrs %>% 
      mutate(
      category = factor(category, levels = category),
      perc = round(value_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "Male"
    )  %>%
    dplyr::select(category, value_normalized, perc, group)
  ) %>% 
    bind_rows(
      shp_imp_cate_female_hrs %>% 
      mutate(
      category = factor(category, levels = category),
      perc = round(value_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "Female"
    ) %>%
    dplyr::select(category, value_normalized, perc, group)
  ) %>% 
    bind_rows(
      shp_imp_cate_5064_hrs %>% 
      mutate(
      category = factor(category, levels = category),
      perc = round(value_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "<65 years"
      ) %>%
    dplyr::select(category, value_normalized, perc, group)
  ) %>% 
    bind_rows(
      shp_imp_cate_65plus_hrs %>% 
      mutate(
      category = factor(category, levels = category),
      perc = round(value_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "≥65 years"
      ) %>%
    dplyr::select(category, value_normalized, perc, group)
  ) %>%
  mutate(
    category = factor(category, levels = c("Demographics", "Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems")),
    perc = str_c(perc, "%"),
    group = factor(group, levels = c("Overall", "Male", "Female", "≥65 years", "<65 years")),
    facet = case_when(
      group == "Overall" ~ " ",
      group %in% c("Male", "Female") ~ "Sex",
      group %in% c("<65 years", "≥65 years") ~ "Age",
      TRUE ~ NA_character_
    ),
    facet = factor(facet, levels = c(" ", "Sex", "Age"))
  )

perform_plot_hrs <- tibble(
  perform = as.character(expression(paste(italic("R")^2))),
  group = factor(c("overall", "female", "male", "<65 years", "≥65 years"), levels = c("≥65 years", "<65 years", "male", "female", "overall"), labels = c("≥65 years", "<65 years", "Male", "Female", "Overall")),
  mean = c(rsq_boot_xgb_overall_hrs$t0, rsq_boot_xgb_female_hrs$t0, rsq_boot_xgb_male_hrs$t0, rsq_boot_xgb_5064_hrs$t0, rsq_boot_xgb_65plus_hrs$t0),
  mean_label = format(round(mean, 3), big.mark = ","),
  sd = c(sd(rsq_boot_xgb_overall_hrs$t), sd(rsq_boot_xgb_female_hrs$t), sd(rsq_boot_xgb_male_hrs$t), sd(rsq_boot_xgb_5064_hrs$t), sd(rsq_boot_xgb_65plus_hrs$t))
)

p_r2_hrs <- ggplot(perform_plot_hrs, aes(x = perform, y = group, fill = mean)) +
  geom_tile(color = "black") +
  geom_text(aes(label = mean_label), color = "black", size = 5) +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.5, r = 1.5, b = 1, l = 0), "cm")
    ) +
  scale_x_discrete(labels = c(expression(paste(italic("R")^2)))) + 
  scale_fill_gradientn(
    colours = c("#2E5A87FF", "#6998C0FF", "#C3DBEDFF", "#FFCCC1FF", "#F1665AFF", "#A90C38FF"),
    breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5),
    limit = c(0, 0.5),
    space = "Lab") +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_shap_domain_hrs <- ggplot(shap_domain_plot_hrs, aes(x = group, y = value_normalized, fill = category)) +
  geom_bar(stat = "identity", width = 0.75) +
  geom_text(aes(label = perc), colour = "black", size = 5, position = position_stack(vjust = 0.5)) +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    legend.key = element_rect(linewidth = 5),
    legend.key.size = unit(1.5, "lines"),
    plot.margin = unit(c(t = 1, r = .5, b = 1, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold"),
    strip.text = element_text(size = 12, colour = "black")
    ) +
  coord_flip() +
  scale_fill_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC")
  ) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = NULL, 
    y = NULL,
    title = "HRS (USA)"
  ) +
  facet_grid(facet ~ ., scales = "free", space = "free", switch = "both") +
  theme(panel.spacing = unit(0, "lines"))

p_r2_shap_hrs <- grid.arrange(p_shap_domain_hrs, p_r2_hrs, ncol = 2, widths = c(5, 1)) %>% 
  wrap_elements()


#### ELSA ####
shap_domain_plot_elsa <- shp_imp_cate_overall_elsa %>% 
  mutate(
    category = factor(category, levels = category),
    perc = round(value_normalized*100, 1),
    perc = ifelse(perc < 10, NA, perc),
    group = "Overall"
  ) %>%
  dplyr::select(category, value_normalized, perc, group) %>% 
    bind_rows(
      shp_imp_cate_male_elsa %>% 
      mutate(
      category = factor(category, levels = category),
      perc = round(value_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "Male"
    )  %>%
    dplyr::select(category, value_normalized, perc, group)
  ) %>% 
    bind_rows(
      shp_imp_cate_female_elsa %>% 
      mutate(
      category = factor(category, levels = category),
      perc = round(value_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "Female"
    ) %>%
    dplyr::select(category, value_normalized, perc, group)
  ) %>% 
    bind_rows(
      shp_imp_cate_5064_elsa %>% 
      mutate(
      category = factor(category, levels = category),
      perc = round(value_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "<65 years"
      ) %>%
    dplyr::select(category, value_normalized, perc, group)
  ) %>% 
    bind_rows(
      shp_imp_cate_65plus_elsa %>% 
      mutate(
      category = factor(category, levels = category),
      perc = round(value_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "≥65 years"
      ) %>%
    dplyr::select(category, value_normalized, perc, group)
  ) %>%
  mutate(
    category = factor(category, levels = c("Demographics", "Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems")),
    perc = str_c(perc, "%"),
    group = factor(group, levels = c("Overall", "Male", "Female", "≥65 years", "<65 years")),
    facet = case_when(
      group == "Overall" ~ " ",
      group %in% c("Male", "Female") ~ "Sex",
      group %in% c("<65 years", "≥65 years") ~ "Age",
      TRUE ~ NA_character_
    ),
    facet = factor(facet, levels = c(" ", "Sex", "Age"))
  )

perform_plot_elsa <- tibble(
  perform = as.character(expression(paste(italic("R")^2))),
  group = factor(c("overall", "female", "male", "<65 years", "≥65 years"), levels = c("≥65 years", "<65 years", "male", "female", "overall"), labels = c("≥65 years", "<65 years", "Male", "Female", "Overall")),
  mean = c(rsq_boot_xgb_overall_elsa$t0, rsq_boot_xgb_female_elsa$t0, rsq_boot_xgb_male_elsa$t0, rsq_boot_xgb_5064_elsa$t0, rsq_boot_xgb_65plus_elsa$t0),
  mean_label = format(round(mean, 3), big.mark = ","),
  sd = c(sd(rsq_boot_xgb_overall_elsa$t), sd(rsq_boot_xgb_female_elsa$t), sd(rsq_boot_xgb_male_elsa$t), sd(rsq_boot_xgb_5064_elsa$t), sd(rsq_boot_xgb_65plus_elsa$t))
)

p_r2_elsa <- ggplot(perform_plot_elsa, aes(x = perform, y = group, fill = mean)) +
  geom_tile(color = "black") +
  geom_text(aes(label = mean_label), color = "black", size = 5) +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.5, r = 1.5, b = 1, l = 0), "cm")
  ) +
  scale_x_discrete(labels = c(expression(paste(italic("R")^2)))) + 
  scale_fill_gradientn(
    colours = c("#2E5A87FF", "#6998C0FF", "#C3DBEDFF", "#FFCCC1FF", "#F1665AFF", "#A90C38FF"),
    breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5),
    limit = c(0, 0.5),
    space = "Lab") +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_shap_domain_elsa <- ggplot(shap_domain_plot_elsa, aes(x = group, y = value_normalized, fill = category)) +
  geom_bar(stat = "identity", width = 0.75) +
  geom_text(aes(label = perc), colour = "black", size = 5, position = position_stack(vjust = 0.5)) +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    legend.key = element_rect(linewidth = 5),
    legend.key.size = unit(1.5, "lines"),
    plot.margin = unit(c(t = 1, r = .5, b = 1, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold"),
    strip.text = element_text(size = 12, colour = "black")
    ) +
  coord_flip() +
  scale_fill_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC")
  ) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = NULL, 
    y = NULL,
    title = "ELSA (England)"
  ) +
  facet_grid(facet ~ ., scales = "free", space = "free", switch = "both") +
  theme(panel.spacing = unit(0, "lines"))

p_r2_shap_elsa <- grid.arrange(p_shap_domain_elsa, p_r2_elsa, ncol = 2, widths = c(5, 1)) %>%
  wrap_elements()


#### CHARLS ####
shap_domain_plot_charls <- shp_imp_cate_overall_charls %>% 
  mutate(
    category = factor(category, levels = category),
    perc = round(value_normalized*100, 1),
    perc = ifelse(perc < 10, NA, perc),
    group = "Overall"
  ) %>%
  dplyr::select(category, value_normalized, perc, group) %>% 
    bind_rows(
      shp_imp_cate_male_charls %>% 
      mutate(
      category = factor(category, levels = category),
      perc = round(value_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "Male"
    )  %>%
    dplyr::select(category, value_normalized, perc, group)
  ) %>% 
    bind_rows(
      shp_imp_cate_female_charls %>% 
      mutate(
      category = factor(category, levels = category),
      perc = round(value_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "Female"
    ) %>%
    dplyr::select(category, value_normalized, perc, group)
  ) %>% 
    bind_rows(
      shp_imp_cate_5064_charls %>% 
      mutate(
      category = factor(category, levels = category),
      perc = round(value_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "<65 years"
      ) %>%
    dplyr::select(category, value_normalized, perc, group)
  ) %>% 
    bind_rows(
      shp_imp_cate_65plus_charls %>% 
      mutate(
      category = factor(category, levels = category),
      perc = round(value_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "≥65 years"
      ) %>%
    dplyr::select(category, value_normalized, perc, group)
  ) %>%
  mutate(
    category = factor(category, levels = c("Demographics", "Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems")),
    perc = str_c(perc, "%"),
    group = factor(group, levels = c("Overall", "Male", "Female", "≥65 years", "<65 years")),
    facet = case_when(
      group == "Overall" ~ " ",
      group %in% c("Male", "Female") ~ "Sex",
      group %in% c("<65 years", "≥65 years") ~ "Age",
      TRUE ~ NA_character_
    ),
    facet = factor(facet, levels = c(" ", "Sex", "Age"))
  )

perform_plot_charls <- tibble(
  perform = as.character(expression(paste(italic("R")^2))),
  group = factor(c("overall", "female", "male", "<65 years", "≥65 years"), levels = c("≥65 years", "<65 years", "male", "female", "overall"), labels = c("≥65 years", "<65 years", "Male", "Female", "Overall")),
  mean = c(rsq_boot_xgb_overall_charls$t0, rsq_boot_xgb_female_charls$t0, rsq_boot_xgb_male_charls$t0, rsq_boot_xgb_5064_charls$t0, rsq_boot_xgb_65plus_charls$t0),
  mean_label = format(round(mean, 3), big.mark = ","),
  sd = c(sd(rsq_boot_xgb_overall_charls$t), sd(rsq_boot_xgb_female_charls$t), sd(rsq_boot_xgb_male_charls$t), sd(rsq_boot_xgb_5064_charls$t), sd(rsq_boot_xgb_65plus_charls$t))
)

p_r2_charls <- ggplot(perform_plot_charls, aes(x = perform, y = group, fill = mean)) +
  geom_tile(color = "black") +
  geom_text(aes(label = mean_label), color = "black", size = 5) +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.5, r = 1.5, b = 1, l = 0), "cm")
  ) +
  scale_x_discrete(labels = c(expression(paste(italic("R")^2)))) + 
  scale_fill_gradientn(
    colours = c("#2E5A87FF", "#6998C0FF", "#C3DBEDFF", "#FFCCC1FF", "#F1665AFF", "#A90C38FF"),
    breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5),
    limit = c(0, 0.5),
    space = "Lab") +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_shap_domain_charls <- ggplot(shap_domain_plot_charls, aes(x = group, y = value_normalized, fill = category)) +
  geom_bar(stat = "identity", width = 0.75) +
  geom_text(aes(label = perc), colour = "black", size = 5, position = position_stack(vjust = 0.5)) +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    legend.key = element_rect(linewidth = 5),
    legend.key.size = unit(1.5, "lines"),
    plot.margin = unit(c(t = 1, r = .5, b = 1, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold"),
    strip.text = element_text(size = 12, colour = "black")
    ) +
  coord_flip() +
  scale_fill_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC")
  ) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = NULL, 
    y = NULL,
    title = "CHARLS (China)"
  ) +
  facet_grid(facet ~ ., scales = "free", space = "free", switch = "both") +
  theme(panel.spacing = unit(0, "lines"))

p_r2_shap_charls <- grid.arrange(p_shap_domain_charls, p_r2_charls, ncol = 2, widths = c(5, 1)) %>%
  wrap_elements()

#### Pool ####
legend_1 <- ggplot(shap_domain_plot_charls, aes(x = group, y = value_normalized, fill = category)) +
  geom_bar(stat = "identity", width = 0.75) +
  geom_text(aes(label = perc), colour = "black", size = 5, position = position_stack(vjust = 0.5)) +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "bottom",
    legend.margin = margin(0, 0, 0, 0, "cm"),
    legend.key = element_rect(linewidth = 5),
    legend.key.size = unit(1.5, "lines")
    ) +
  scale_fill_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC")
  )

legend_2 <- ggplot(perform_plot_charls, aes(x = perform, y = group, fill = mean)) +
  geom_tile(color = "black") +
  geom_text(aes(label = mean_label), color = "black", size = 5) +
  theme_void() +
  theme(
    legend.position = "bottom",
    legend.margin = margin(0, 0, 0, 0, "cm")
  ) +
  scale_x_discrete(labels = c(expression(paste(italic("R")^2)))) + 
  scale_fill_gradientn(
    colours = c("#2E5A87FF", "#6998C0FF", "#C3DBEDFF", "#FFCCC1FF", "#F1665AFF", "#A90C38FF"),
    breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5),
    limit = c(0, 0.5),
    name = expression(paste(italic("R")^2)),
    space = "Lab") +
  guides(fill =
    guide_colourbar(
      barwidth = unit(5, "cm"), barheight = unit(0.75, "cm"),
      title.position = "top",
      title.theme = element_text(size = 12, colour = "black", angle = 0, hjust = .5),
      label.theme = element_text(size = 12, colour = "black", angle = 0)
      )
    )

legend <- wrap_elements(
  (wrap_elements(ggpubr::get_legend(legend_1)) + wrap_elements(ggpubr::get_legend(legend_2))) +
  plot_layout(widths = c(2, 1))
  )

p_shap_domain_pool <- p_r2_shap_hrs + p_r2_shap_elsa + p_r2_shap_charls + 
  plot_annotation(tag_levels = "a") +
  plot_layout(ncol = 2, guides = "collect") &
  theme(
    plot.tag = element_text(size = 20, face = "bold"),
    legend.position = "bottom"
    )

shap_domain_pool <- wrap_plots(wrap_elements(p_shap_domain_pool), legend, heights = c(10,1))

ggsave(str_c(getwd(), "/results/Figure/Domain SHAP importance.png", sep = ""), plot = shap_domain_pool, width = 18, height = 12, unit = "in", dpi = 300, device = "png") 

ggsave(str_c(getwd(), "/results/Figure/Domain SHAP importance.pdf", sep = ""), plot = shap_domain_pool, width = 18, height = 12, unit = "in", dpi = 300, device = "pdf")

```

## GA2M

### Import data

```{r}

file_list <- list.files(path = "E:/Multiple cohort study/Harmonized Data FIile/HarmonizedSurveyData/social_factors_health/code/ga2m_results", pattern = "\\.csv")

file_names <- str_c("E:/Multiple cohort study/Harmonized Data FIile/HarmonizedSurveyData/social_factors_health/code/ga2m_results/", file_list)

data_names <- str_remove(string = file_list, pattern = ".csv")

list2env(lapply(setNames(file_names, data_names), read.csv), envir = .GlobalEnv)  

```

### Supplementary Figure 4: Domian-wise

```{r}

#### HRS ####
ga2m_domain_plot_hrs <- ga2m_imp_cate_overall_hrs %>% 
  mutate(
    category = factor(category, levels = category),
    importance_normalized = importance/sum(importance),
    perc = round(importance_normalized*100, 1),
    perc = ifelse(perc < 10, NA, perc),
    group = "Overall"
  ) %>%
  dplyr::select(category, importance, importance_normalized, perc, group) %>% 
    bind_rows(
      ga2m_imp_cate_male_hrs %>% 
      mutate(
      category = factor(category, levels = category),
      importance_normalized = importance/sum(importance),
      perc = round(importance_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "Male"
    )  %>%
    dplyr::select(category, importance, importance_normalized, perc, group)
  ) %>% 
    bind_rows(
      ga2m_imp_cate_female_hrs %>% 
      mutate(
      category = factor(category, levels = category),
      importance_normalized = importance/sum(importance),
      perc = round(importance_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "Female"
    ) %>%
    dplyr::select(category, importance, importance_normalized, perc, group)
  ) %>% 
    bind_rows(
      ga2m_imp_cate_5064_hrs %>% 
      mutate(
      category = factor(category, levels = category),
      importance_normalized = importance/sum(importance),
      perc = round(importance_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "<65 years"
      ) %>%
    dplyr::select(category, importance, importance_normalized, perc, group)
  ) %>% 
    bind_rows(
      ga2m_imp_cate_65plus_hrs %>% 
      mutate(
      category = factor(category, levels = category),
      importance_normalized = importance/sum(importance),
      perc = round(importance_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "≥65 years"
      ) %>%
    dplyr::select(category, importance, importance_normalized, perc, group)
  ) %>%
  mutate(
    category = factor(category, levels = c("Demographics", "Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems")),
    perc = str_c(perc, "%"),
    group = factor(group, levels = c("Overall", "Male", "Female", "≥65 years", "<65 years")),
    facet = case_when(
      group == "Overall" ~ " ",
      group %in% c("Male", "Female") ~ "Sex",
      group %in% c("<65 years", "≥65 years") ~ "Age",
      TRUE ~ NA_character_
    ),
    facet = factor(facet, levels = c(" ", "Sex", "Age"))
  )

perform_plot_hrs <- tibble(
  perform = as.character(expression(paste(italic("R")^2))),
  group = factor(c("overall", "female", "male", "<65 years", "≥65 years"), levels = c("≥65 years", "<65 years", "male", "female", "overall"), labels = c("≥65 years", "<65 years", "Male", "Female", "Overall")),
  mean = c(0.2180564305488606, 0.24733368233162534, 0.2515971209510065, 0.25601757592272045, 0.14420849791623958),
  mean_label = format(round(mean, 3), big.mark = ","),
  sd = NA
)

p_r2_hrs <- ggplot(perform_plot_hrs, aes(x = perform, y = group, fill = mean)) +
  geom_tile(color = "black") +
  geom_text(aes(label = mean_label), color = "black", size = 5) +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.5, r = 1.5, b = 1, l = 0), "cm")
    ) +
  scale_x_discrete(labels = c(expression(paste(italic("R")^2)))) + 
  scale_fill_gradientn(
    colours = c("#2E5A87FF", "#6998C0FF", "#C3DBEDFF", "#FFCCC1FF", "#F1665AFF", "#A90C38FF"),
    breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5),
    limit = c(0, 0.5),
    space = "Lab") +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_ga2m_domain_hrs <- ggplot(ga2m_domain_plot_hrs, aes(x = group, y = importance_normalized, fill = category)) +
  geom_bar(stat = "identity", width = 0.75) +
  geom_text(aes(label = perc), colour = "black", size = 5, position = position_stack(vjust = 0.5)) +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    legend.key = element_rect(linewidth = 5),
    legend.key.size = unit(1.5, "lines"),
    plot.margin = unit(c(t = 1, r = .5, b = 1, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold"),
    strip.text = element_text(size = 12, colour = "black")
    ) +
  coord_flip() +
  scale_fill_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC")
  ) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = NULL, 
    y = NULL,
    title = "HRS (USA)"
  ) +
  facet_grid(facet ~ ., scales = "free", space = "free", switch = "both") +
  theme(panel.spacing = unit(0, "lines"))

p_r2_ga2m_hrs <- grid.arrange(p_ga2m_domain_hrs, p_r2_hrs, ncol = 2, widths = c(5, 1)) %>% 
  wrap_elements()




#### ELSA ####
ga2m_domain_plot_elsa <- ga2m_imp_cate_overall_elsa %>% 
  mutate(
    category = factor(category, levels = category),
    importance_normalized = importance/sum(importance),
    perc = round(importance_normalized*100, 1),
    perc = ifelse(perc < 10, NA, perc),
    group = "Overall"
  ) %>%
  dplyr::select(category, importance, importance_normalized, perc, group) %>% 
    bind_rows(
      ga2m_imp_cate_male_elsa %>% 
      mutate(
      category = factor(category, levels = category),
      importance_normalized = importance/sum(importance),
      perc = round(importance_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "Male"
    )  %>%
    dplyr::select(category, importance, importance_normalized, perc, group)
  ) %>% 
    bind_rows(
      ga2m_imp_cate_female_elsa %>% 
      mutate(
      category = factor(category, levels = category),
      importance_normalized = importance/sum(importance),
      perc = round(importance_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "Female"
    ) %>%
    dplyr::select(category, importance, importance_normalized, perc, group)
  ) %>% 
    bind_rows(
      ga2m_imp_cate_5064_elsa %>% 
      mutate(
      category = factor(category, levels = category),
      importance_normalized = importance/sum(importance),
      perc = round(importance_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "<65 years"
      ) %>%
    dplyr::select(category, importance, importance_normalized, perc, group)
  ) %>% 
    bind_rows(
      ga2m_imp_cate_65plus_elsa %>% 
      mutate(
      category = factor(category, levels = category),
      importance_normalized = importance/sum(importance),
      perc = round(importance_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "≥65 years"
      ) %>%
    dplyr::select(category, importance, importance_normalized, perc, group)
  ) %>%
  mutate(
    category = factor(category, levels = c("Demographics", "Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems")),
    perc = str_c(perc, "%"),
    group = factor(group, levels = c("Overall", "Male", "Female", "≥65 years", "<65 years")),
    facet = case_when(
      group == "Overall" ~ " ",
      group %in% c("Male", "Female") ~ "Sex",
      group %in% c("<65 years", "≥65 years") ~ "Age",
      TRUE ~ NA_character_
    ),
    facet = factor(facet, levels = c(" ", "Sex", "Age"))
  )

perform_plot_elsa <- tibble(
  perform = as.character(expression(paste(italic("R")^2))),
  group = factor(c("overall", "female", "male", "<65 years", "≥65 years"), levels = c("≥65 years", "<65 years", "male", "female", "overall"), labels = c("≥65 years", "<65 years", "Male", "Female", "Overall")),
  mean = c(0.23727061184845777, 0.2314533194611964, 0.22621146313363416, 0.09738455575922245, 0.0813633986355432),
  mean_label = format(round(mean, 3), big.mark = ","),
  sd = NA
)

p_r2_elsa <- ggplot(perform_plot_elsa, aes(x = perform, y = group, fill = mean)) +
  geom_tile(color = "black") +
  geom_text(aes(label = mean_label), color = "black", size = 5) +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.5, r = 1.5, b = 1, l = 0), "cm")
    ) +
  scale_x_discrete(labels = c(expression(paste(italic("R")^2)))) + 
  scale_fill_gradientn(
    colours = c("#2E5A87FF", "#6998C0FF", "#C3DBEDFF", "#FFCCC1FF", "#F1665AFF", "#A90C38FF"),
    breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5),
    limit = c(0, 0.5),
    space = "Lab") +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_ga2m_domain_elsa <- ggplot(ga2m_domain_plot_elsa, aes(x = group, y = importance_normalized, fill = category)) +
  geom_bar(stat = "identity", width = 0.75) +
  geom_text(aes(label = perc), colour = "black", size = 5, position = position_stack(vjust = 0.5)) +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    legend.key = element_rect(linewidth = 5),
    legend.key.size = unit(1.5, "lines"),
    plot.margin = unit(c(t = 1, r = .5, b = 1, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold"),
    strip.text = element_text(size = 12, colour = "black")
    ) +
  coord_flip() +
  scale_fill_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC")
  ) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = NULL, 
    y = NULL,
    title = "ELSA (England)"
  ) +
  facet_grid(facet ~ ., scales = "free", space = "free", switch = "both") +
  theme(panel.spacing = unit(0, "lines"))

p_r2_ga2m_elsa <- grid.arrange(p_ga2m_domain_elsa, p_r2_elsa, ncol = 2, widths = c(5, 1)) %>% 
  wrap_elements()


#### CHARLS ####
ga2m_domain_plot_charls <- ga2m_imp_cate_overall_charls %>% 
  mutate(
    category = factor(category, levels = category),
    importance_normalized = importance/sum(importance),
    perc = round(importance_normalized*100, 1),
    perc = ifelse(perc < 10, NA, perc),
    group = "Overall"
  ) %>%
  dplyr::select(category, importance, importance_normalized, perc, group) %>% 
    bind_rows(
      ga2m_imp_cate_male_charls %>% 
      mutate(
      category = factor(category, levels = category),
      importance_normalized = importance/sum(importance),
      perc = round(importance_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "Male"
    )  %>%
    dplyr::select(category, importance, importance_normalized, perc, group)
  ) %>% 
    bind_rows(
      ga2m_imp_cate_female_charls %>% 
      mutate(
      category = factor(category, levels = category),
      importance_normalized = importance/sum(importance),
      perc = round(importance_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "Female"
    ) %>%
    dplyr::select(category, importance, importance_normalized, perc, group)
  ) %>% 
    bind_rows(
      ga2m_imp_cate_5064_charls %>% 
      mutate(
      category = factor(category, levels = category),
      importance_normalized = importance/sum(importance),
      perc = round(importance_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "<65 years"
      ) %>%
    dplyr::select(category, importance, importance_normalized, perc, group)
  ) %>% 
    bind_rows(
      ga2m_imp_cate_65plus_charls %>% 
      mutate(
      category = factor(category, levels = category),
      importance_normalized = importance/sum(importance),
      perc = round(importance_normalized*100, 1),
      perc = ifelse(perc < 10, NA, perc),
      group = "≥65 years"
      ) %>%
    dplyr::select(category, importance, importance_normalized, perc, group)
  ) %>%
  mutate(
    category = factor(category, levels = c("Demographics", "Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems")),
    perc = str_c(perc, "%"),
    group = factor(group, levels = c("Overall", "Male", "Female", "≥65 years", "<65 years")),
    facet = case_when(
      group == "Overall" ~ " ",
      group %in% c("Male", "Female") ~ "Sex",
      group %in% c("<65 years", "≥65 years") ~ "Age",
      TRUE ~ NA_character_
    ),
    facet = factor(facet, levels = c(" ", "Sex", "Age"))
  )

perform_plot_charls <- tibble(
  perform = as.character(expression(paste(italic("R")^2))),
  group = factor(c("overall", "female", "male", "<65 years", "≥65 years"), levels = c("≥65 years", "<65 years", "male", "female", "overall"), labels = c("≥65 years", "<65 years", "Male", "Female", "Overall")),
  mean = c(0.14852289226550452, 0.1142887575605418, 0.11599051126159021, 0.13117932323758275, 0.06340084756343589),
  mean_label = format(round(mean, 3), big.mark = ","),
  sd = NA
)

p_r2_charls <- ggplot(perform_plot_charls, aes(x = perform, y = group, fill = mean)) +
  geom_tile(color = "black") +
  geom_text(aes(label = mean_label), color = "black", size = 5) +
  theme_void() +
  theme(
    axis.text.x = element_text(color = "black", size = 12),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    legend.position = "none",
    plot.margin = unit(c(t = 1.5, r = 1.5, b = 1, l = 0), "cm")
    ) +
  scale_x_discrete(labels = c(expression(paste(italic("R")^2)))) + 
  scale_fill_gradientn(
    colours = c("#2E5A87FF", "#6998C0FF", "#C3DBEDFF", "#FFCCC1FF", "#F1665AFF", "#A90C38FF"),
    breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5),
    limit = c(0, 0.5),
    space = "Lab") +
  labs(
    x = NULL, 
    y = NULL, 
    fill = NULL
    )

p_ga2m_domain_charls <- ggplot(ga2m_domain_plot_charls, aes(x = group, y = importance_normalized, fill = category)) +
  geom_bar(stat = "identity", width = 0.75) +
  geom_text(aes(label = perc), colour = "black", size = 5, position = position_stack(vjust = 0.5)) +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 16, vjust = 0, angle = 00, face = "bold"),
    axis.title.y = element_text(size = 16, vjust = 1, angle = 90, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    legend.key = element_rect(linewidth = 5),
    legend.key.size = unit(1.5, "lines"),
    plot.margin = unit(c(t = 1, r = .5, b = 1, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold"),
    strip.text = element_text(size = 12, colour = "black")
    ) +
  coord_flip() +
  scale_fill_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC")
  ) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = NULL, 
    y = NULL,
    title = "CHARLS (China)"
  ) +
  facet_grid(facet ~ ., scales = "free", space = "free", switch = "both") +
  theme(panel.spacing = unit(0, "lines"))

p_r2_ga2m_charls <- grid.arrange(p_ga2m_domain_charls, p_r2_charls, ncol = 2, widths = c(5, 1)) %>% 
  wrap_elements()

#### Pool ####
legend_1 <- ggplot(ga2m_domain_plot_charls, aes(x = group, y = importance_normalized, fill = category)) +
  geom_bar(stat = "identity", width = 0.75) +
  geom_text(aes(label = perc), colour = "black", size = 5, position = position_stack(vjust = 0.5)) +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "bottom",
    legend.margin = margin(0, 0, 0, 0, "cm"),
    legend.key = element_rect(linewidth = 5),
    legend.key.size = unit(1.5, "lines"),
    ) +
  scale_fill_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC")
  )

legend_2 <- ggplot(perform_plot_charls, aes(x = perform, y = group, fill = mean)) +
  geom_tile(color = "black") +
  geom_text(aes(label = mean_label), color = "black", size = 5) +
  theme_void() +
  theme(
    legend.position = "bottom",
    legend.margin = margin(0, 0, 0, 0, "cm")
  ) +
  scale_x_discrete(labels = c(expression(paste(italic("R")^2)))) + 
  scale_fill_gradientn(
    colours = c("#2E5A87FF", "#6998C0FF", "#C3DBEDFF", "#FFCCC1FF", "#F1665AFF", "#A90C38FF"),
    breaks = c(0, 0.1, 0.2, 0.3, 0.4, 0.5),
    limit = c(0, 0.5),
    name = expression(paste(italic("R")^2)),
    space = "Lab") +
  guides(fill =
    guide_colourbar(
      barwidth = unit(5, "cm"), barheight = unit(0.75, "cm"),
      title.position = "top",
      title.theme = element_text(size = 12, colour = "black", angle = 0, hjust = .5),
      label.theme = element_text(size = 12, colour = "black", angle = 0)
      )
    )

legend <- wrap_elements(
  (wrap_elements(ggpubr::get_legend(legend_1)) + wrap_elements(ggpubr::get_legend(legend_2))) +
  plot_layout(widths = c(2, 1))
  )

p_ga2m_domain_pool <- p_r2_ga2m_hrs + p_r2_ga2m_elsa + p_r2_ga2m_charls + 
  plot_annotation(tag_levels = "a") +
  plot_layout(ncol = 2, guides = "collect") &
  theme(
    plot.tag = element_text(size = 20, face = "bold"),
    legend.position = "bottom"
    )

ga2m_domain_pool <- wrap_plots(wrap_elements(p_ga2m_domain_pool), legend, heights = c(10,1))

ggsave(str_c(getwd(), "/results/Figure/Domain importance-ga2m.pdf", sep = ""), plot = ga2m_domain_pool, width = 18, height = 12, unit = "in", dpi = 300, device = "pdf") 

ggsave(str_c(getwd(), "/results/Figure/Domain importance-ga2m.png", sep = ""), plot = ga2m_domain_pool, width = 18, height = 12, unit = "in", dpi = 300, device = "png")

```


### Supplementary Figure 5: Mean absolute score

```{r}

#### HRS ####
ga2m_imp_var_overall_hrs[ga2m_imp_var_overall_hrs$names == "Walk for more than 20 minutes", "names"] <- "Walk for ≥20 minutes"

ga2m_imp_var_overall_hrs <- ga2m_imp_var_overall_hrs %>%
  mutate(
    category = case_when(
      names %in% c("Age", "Sex: male") ~ "Demographics",
      names %in% c(
        "Lower family financial situation", 
        "Higher father's education", 
        "Higher mother's education",
        "Relocated due to financial difficulties",
        "Family received financial help",
        "Father unemployed",
        "Father's occupation", 
        "Repeated school",
        "Trouble with police",
        "Parents used drugs or alcohol",
        "Physically abused",
        "Live in an orphanage",
        "Live in a foster home",
        "Parents separated or divorced",
        "Parents died",
        "Separated from mother",
        "Separated from father"
        ) ~ "Adverse Childhood Experiences",
      names %in% c(
        "Higher education",
        "Household wealth",
        "Annual household income",
        "Higher subjective social status",
        "Race",
        "Hispanic", 
        "Labor force status"
        ) ~ "Socioeconomic Status",
      names %in% c(
        "Received food stamps", 
        "Experienced food insecurity",
        "Home ownership",
        "House's type",
        "Live in the rural area",
        "Census region",
        "Neighborhood unsafety"
        ) ~ "Material Circumstances",
      names %in% c(
        "Marital status",
        "Household size",
        "Number of close children",
        "Number of close family members", 
        "Number of close friends",
        "Contact with children",
        "Contact with other family members", 
        "Contact with friends", 
        "Support from spouse", 
        "Strain from spouse",
        "Support from children", 
        "Strain from children", 
        "Support from other family members", 
        "Strain from other family members", 
        "Support from friends",
        "Strain from friends", 
        "Care for a sick adult", 
        "Do activities with grandchildren",
        "Volunteer with children",
        "Do charity work", 
        "Attend an educational course",
        "Go to a sport/social club",
        "Attend meetings of non-religious organizations", 
        "Pray privately",
        "Reading",
        "Watch television",
        "Do word games",
        "Play cards or chess",
        "Writing",
        "Use a computer or email",
        "Maintenance or gardening",
        "Baking or cooking",
        "Knitting",
        "Work on a hobby or project",
        "Play sports or exercise",
        "Walk for ≥20 minutes",
        "Attend religious activities",
        "Neighborhood physical disorder", 
        "Neighborhood social cohesion"
        ) ~ "Social Connections",
      names %in% c(
        "Daily discrimination", 
        "Loneliness",
        "Ongoing health problems", 
        "Ongoing physical/emotional problems", 
        "Ongoing alcohol/drug issues in family member", 
        "Ongoing difficulties at work", 
        "Ongoing financial strain", 
        "Ongoing housing problems", 
        "Ongoing problems in a close relationship",
        "Helping sick family members or friends regularly",
        "Unfairly dismissed from a job",
        "Unfairly not been hired for a job",
        "Unfairly denied a promotion",
        "Unfairly been prevented from moving into a neighborhood",
        "Unfairly denied a bank loan",
        "Unfairly treated by the police",
        "Unfairly denied health care",
        "Experienced the death of a child", 
        "Experienced a natural disaster",
        "Fired a weapon in combat",
        "Partner addicted to drugs/alcohol", 
        "Been a victim of a physical attack",
        "Ever had a life-threatening illness", 
        "Ever had a spouse/child with a life-threatening illness", 
        "Involuntarily lost a job for reasons other than retirement",
        "Unemployed",
        "Anyone else in the household unemployed", 
        "Moved to a worse residence/neighborhood",
        "Robbed/burglarized",
        "Been the victim of fraud",
        "Ever been in a jail",
        "Ever been in long-term hospitalization",
        "Ever lived in a combat zone",
        "Ever lived in military housing",
        "Ever been homeless"
        ) ~ "Social Stressors",
      names %in% c(
        "Ever smoking", 
        "Currently smoking", 
        "Ever drinking any alcohol",
        "Total number of drinks per week", 
        "Light physical activities", 
        "Moderate physical activities", 
        "Vigorous physical activities",
        "Body mass index",
        "Sleep problems"
      ) ~ "Health Behaviors",
      names %in% c(
        "Government health insurance", 
        "Private health insurance", 
        "Long-term care insurance",
        "Life insurance",
        "Access to routine place for healthcare",
        "Out-of-pocket medical expenditure",
        "Lower healthcare satisfaction"
      ) ~ "Healthcare Systems"
    ),
    category = factor(category, levels = c("Demographics", "Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems"))
  ) %>%
  arrange(scores)
ga2m_imp_var_overall_hrs$names <- factor(ga2m_imp_var_overall_hrs$names, levels = ga2m_imp_var_overall_hrs$names)


# table(ga2m_imp_var_overall_hrs %>% slice_tail(n = 20) %>% pull(category))
p_ga2m_overall_hrs <- ggplot(ga2m_imp_var_overall_hrs %>% slice_tail(n = 20),
       aes(x = names, y = scores, fill = category)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 0.5, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold")
    ) +
  coord_flip() +
  scale_colour_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", 
               #"#00A087CC", 
               "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC"),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL,
    y = "Mean absolute score",
    title = "HRS (USA)"
  ) +
  annotate(
    "text", parse = TRUE,
    x = ga2m_imp_var_overall_hrs %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(names) %>% as.character(), 
    y = Inf,
    label = paste0("italic(R)^2 == ", "'", format(round(0.2180564305488606, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = ga2m_imp_var_overall_hrs %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(names) %>% as.character(), 
    y = Inf,
    label = paste0("MAE == ", "'", format(round(0.055397038940284485, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = ga2m_imp_var_overall_hrs %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(names) %>% as.character(), 
    y = Inf,
    label = paste0("RMSE == ", "'", format(round(0.07392366615117292, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

#### ELSA ####
ga2m_imp_var_overall_elsa <- ga2m_imp_var_overall_elsa %>%
  mutate(
    category = case_when(
      names %in% c("Age", "Sex: male") ~ "Demographics",
      names %in% c(
        "Higher father's education", 
        "Higher mother's education",
        "Overcrowding (childhood)",
        "Number of books (childhood)",
        "Fixed bath (childhood)",
        "Cold running water supply (childhood)",
        "Hot running water supply (childhood)",
        "Indoor toilet (childhood)",
        "Central heating (childhood)",
        "Main carer's occupation", 
        "Parents unemployed",
        "Childhood financial difficulties",
        "Lower bonding with father",
        "Lower bonding with mother",
        "Separated from mother",
        "Parents died",
        "Lived in a children's home",
        "Fostered with another family",
        "Repeated school",
        "Physically assaulted",
        "Sexually abused",
        "Physically abused by parents",
        "Parents argued",
        "Parents used drugs/alcohol or mentally ill",
        "Parents separated or divorced"
        ) ~ "Adverse Childhood Experiences",
      names %in% c(
        "Higher education",
        "Household wealth", 
        "Annual household income",
        "Higher subjective social status",
        "Race",
        "Labor force status"
        ) ~ "Socioeconomic Status",
      names %in% c(
        "Food unaffordability",
        "Home ownership",
        "Central heating",
        "Widened doorways",
        "Ramps",
        "Hand rails",
        "Automatic doors",
        "Accessible parking site",
        "Bathroom modifications",
        "Kitchen modifications",
        "Lift",
        "Chair lift or stair glide",
        "Alerting devices",
        "Shortage of space",
        "Noise from neighbors",
        "Other street noise",
        "Too dark",
        "Environmental problems",
        "Rising damp",
        "Water leaking in",
        "Bad condensation problems",
        "Problems with electrical wiring or plumbing",
        "Rot and decay",
        "Problems with insects, mice or rats",
        "Too cold in winter"
        ) ~ "Material Circumstances",
      names %in% c(
        "Marital status", 
        "Household size",
        "Number of close children",
        "Number of f close family members", 
        "Number of close friends",
        "Contact with children",
        "Contact with other family members", 
        "Contact with friends", 
        "Support from spouse", 
        "Support from children", 
        "Support from other family members", 
        "Support from friends",
        "Strain from spouse",
        "Strain from children", 
        "Strain from other family members", 
        "Strain from friends",
        "Member of political organizations",
        "Member of community organizations",
        "Member of religious groups",
        "Member of charitable associations",
        "Attend educational courses",
        "Participate in a social club",
        "Go to sport clubs",
        "Read newspapers",
        "Use the internet/email",
        "Own a mobile phone",
        "Take a holiday in the UK",
        "Take a holiday abroad",
        "Go on a daytrip",
        "Pet ownership",
        "Do volunteer work",
        "Go to the cinema",
        "Go to an art gallery/museum",
        "Attend theater/concert/opera",
        "Watch television",
        "Neighborhood social cohesion"
        ) ~ "Social Connections",
      names %in% c(
        "Daily discrimination", 
        "Loneliness",
        "Experienced a natural disaster",
        "Ever had a life-threatening illness",
        "Been a victim of a physical attack",
        "Been a victim of a sexual assault",
        "Family members addicted to drugs/alcohol", 
        "Fired a weapon in combat",
        "Witnessed the injury/death in war",
        "Witnessed the accident/violent act",
        "Lost a close friend/relative in war",
        "Close friend/relative died",
        "Provided long-term care",
        "Experienced severe financial hardship",
        "Ever been homeless"
        ) ~ "Social Stressors",
      names %in% c(
        "Ever smoking", 
        "Currently smoking", 
        "Higher drinking frequency",
        "Total number of drinks per week", 
        "Light physical activities", 
        "Moderate physical activities", 
        "Vigorous physical activities",
        "Body mass index",
        "Sleep duration",
        "Sleep problems",
        "Vegetables consumption",
        "Fruit consumption"
      ) ~ "Health Behaviors",
      names %in% c(
        "Private health insurance",
        "Poor access to general practitioner",
        "Poor access to the dentist",
        "Poor access to optician",
        "Poor access to hospital",
        "Transport deprivation"
      ) ~ "Healthcare Systems"
    ),
    category = factor(category, levels = c("Demographics", "Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems"))  
    ) %>%
  arrange(scores)
ga2m_imp_var_overall_elsa$names <- factor(ga2m_imp_var_overall_elsa$names, levels = ga2m_imp_var_overall_elsa$names)

# table(ga2m_imp_var_overall_elsa %>% slice_tail(n = 20) %>% pull(category))
p_ga2m_overall_elsa <- ggplot(ga2m_imp_var_overall_elsa %>% slice_tail(n = 20),
       aes(x = names, y = scores, fill = category)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 0.5, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold")
    ) +
  coord_flip() +
  scale_colour_manual(
    values = c("#B09C85CC", 
               # "#E64B35CC", 
               "#4DBBD5CC", "#00A087CC", 
               "#3C5488CC", "#F39B7FCC", "#8491B4CC"#, 
               # "#91D1C2CC"
               ),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL,
    y = "Mean absolute score",
    title = "ELSA (England)"
  ) +
  annotate(
    "text", parse = TRUE,
    x = ga2m_imp_var_overall_elsa %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(names) %>% as.character(), 
    y = Inf,
    label = paste0("italic(R)^2 == ", "'", format(round(0.23727061184845777, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = ga2m_imp_var_overall_elsa %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(names) %>% as.character(), 
    y = Inf,
    label = paste0("MAE == '0.050'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = ga2m_imp_var_overall_elsa %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(names) %>% as.character(), 
    y = Inf,
    label = paste0("RMSE == ", "'", format(round(0.0710306762243314, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

#### CHARLS ####
ga2m_imp_var_overall_charls[ga2m_imp_var_overall_charls$names %in% c("Ever hospitalized for more than 1 month", "Ever hospitalized more than 3 times"), "names"] <- c("Ever hospitalized for ≥1 month", "Ever hospitalized ≥3 times")

ga2m_imp_var_overall_charls <- ga2m_imp_var_overall_charls %>%
  mutate(
    category = case_when(
      names %in% c("Age", "Sex: male") ~ "Demographics",
      names %in% c(
        "Lower family financial situation", 
        "Higher father's education", 
        "Higher mother's education",
        "Father's occupation", 
        "Mother's occupation", 
        "Food deficiency (childhood)",
        
        "Parents died",
        "Parents divorced",
        "Siblings died",
        "Parental alcohol/drug issues",
        "Parental depression",
        "Parental severe depression",
        "Parents' sick on bed",
        "Parents' deformity",
        "Parents' abnormality of mind",
        "Hit by parents",
        "Inadequate mother's love and affection",
        "Inadequate mother's effort to watch over you",
        "Parents ever quarreled",
        "Parents hit each other",
        "Neighborhood unsafety (childhood)",
        "Felt lonely (childhood)",
        "Abused by neighbor kids",
        "Abused by school kids"
        ) ~ "Adverse Childhood Experiences",
      names %in% c(
        "Higher education",
        "Household wealth", 
        "Labor force status",
        "Hukou type"
        ) ~ "Socioeconomic Status",
      names %in% c(
        "Live in the rural area",
        "Region", 
        "Improved housing materials",
        "Elevator",
        "Handicapped facilities",
        "Kitchen",
        "Indoor sitting toilet", 
        "Running water supply supply", 
        "Shower/bath facility",
        "Coal/natural gas supply",
        "Heating system",
        "Clean cooking fuel",
        "Telephone connection",
        "Internet connection",
        "Air cleaner",
        "Number of bedrooms"
        ) ~ "Material Circumstances",
      names %in% c(
        "Marital status", 
        "Weekly contact with parents",
        "Weekly contact with children",
        "Financial support for work",
        "Nonfinancial support for work",
        "Support for interpersonal relationships",
        "Perceived support from relatives or friends",
        "Household size",
        "Interact with friends",
        "Play mahjong, chess, cards",
        "Provide help to others",
        "Go to a sport/social club",
        "Attend a community organization",
        "Do voluntary/charity work",
        "Care for a sick adult",
        "Attend an educational course",
        "Stock investment",
        "Use the Internet",
        "Financial support from children",
        "Financial support from parents",
        "Financial support from others"
        ) ~ "Social Connections",
      names %in% c(
        "Loneliness",
        "Experienced the death of a child",
        "Experienced the death of siblings in the past year",
        "Ever received medical treatment due to major accidental injury",
        "Been the victim of fraud", 
        "Physically injury",
        "Experienced lifetime discrimination",
        "Ever confined to bed",
        "Ever hospitalized for more than 1 month",
        "Ever hospitalized more than 3 times",
        "Ever left job for health condition"
        ) ~ "Social Stressors",
      names %in% c(
        "Ever smoking", 
        "Currently smoking", 
        "Ever drinking any alcohol",
        "Higher drinking frequency", 
        "Light physical activities", 
        "Moderate physical activities", 
        "Vigorous physical activities",
        "Body mass index",
        "Sleep duration", 
        "Daytime nap duration",
        "Sleep problems"
      ) ~ "Health Behaviors",
      names %in% c(
        "Government health insurance", 
        "Private health insurance",
        "Access to routine place for healthcare",
        "Out-of-pocket hospitalization expenditure",
        "Out-of-pocket doctor visit expenditure",
        "Out-of-pocket dental care expenditure",
        "Lower healthcare satisfaction"
      ) ~ "Healthcare Systems"
    ),
    category = factor(category, levels = c("Demographics", "Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems"))
  ) %>%
  arrange(scores)
ga2m_imp_var_overall_charls$names <- factor(ga2m_imp_var_overall_charls$names, levels = ga2m_imp_var_overall_charls$names)

# table(ga2m_imp_var_overall_charls %>% slice_tail(n = 20) %>% pull(category))
p_ga2m_overall_charls <- ggplot(ga2m_imp_var_overall_charls %>% slice_tail(n = 20),
       aes(x = names, y = scores, fill = category)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 1, r = 0.5, b = 0.5, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold")
    ) +
  coord_flip() +
  scale_colour_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC"),
    aesthetics = c("colour", "fill")
  ) +
  labs(
    x = NULL,
    y = "Mean absolute score",
    title = "CHARLS (China)"
  ) +
  annotate(
    "text", parse = TRUE,
    x = ga2m_imp_var_overall_charls %>% slice_tail(n = 20) %>% dplyr::slice(3) %>% pull(names) %>% as.character(), 
    y = Inf,
    label = paste0("italic(R)^2 == ", "'", format(round(0.14852289226550452, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = ga2m_imp_var_overall_charls %>% slice_tail(n = 20) %>% dplyr::slice(2) %>% pull(names) %>% as.character(), 
    y = Inf,
    label = paste0("MAE == ", "'", format(round(0.05319735413387865, 3), big.mark = ","), "'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  ) +
  annotate(
    "text", parse = TRUE,
    x = ga2m_imp_var_overall_charls %>% slice_tail(n = 20) %>% dplyr::slice(1) %>% pull(names) %>% as.character(), 
    y = Inf,
    label = paste0("RMSE == '0.070'"),
    size = 6, hjust = 1.1, vjust = 0, angle = 0
  )

#### pool ####
legend <- ggplot(ga2m_imp_var_overall_hrs %>% slice_tail(n = 50),
       aes(x = names, y = scores, fill = category)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(
    values = c("#B09C85CC", "#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC"),
  ) + 
  guides(fill = guide_legend(byrow = T)) +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "right",
    legend.key.size = unit(1.5, "lines")
    )

p_ga2m_all <- wrap_elements(
  p_ga2m_overall_hrs + p_ga2m_overall_elsa + p_ga2m_overall_charls + 
    plot_annotation(tag_levels = "a") &
    theme(
      plot.tag = element_text(size = 20, face = "bold")
    )
  )

ga2m_pool <- wrap_plots(p_ga2m_all, ggpubr::get_legend(legend), widths = c(5,1))

ggsave(str_c(getwd(), "/results/Figure/GA2M importance.pdf", sep = ""), plot = ga2m_pool, width = 22, height = 7, unit = "in", dpi = 300, device = "pdf") 

ggsave(str_c(getwd(), "/results/Figure/GA2M importance.png", sep = ""), plot = ga2m_pool, width = 22, height = 7, unit = "in", dpi = 300, device = "png")

```

### Supplementary Figure 6: Shap function

#### BMI

```{r}

#### HRS ####
p_bmi_overall_hrs <- ggplot(ga2m_bmi_plot_data_overall_hrs, aes(bin, score)) + 
  geom_stepconfint(aes(ymin = score-sd, ymax = score+sd), fill = "gray", alpha = .5) +
  geom_step(linewidth = 1, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(10,60),
    breaks = seq(10, 60, by = 5),
  ) +
  labs(
    x = expression(paste("kg/", "m"^2)),
    y = "Score", 
    title = "HRS (USA)"
  )

#### ELSA ####
p_bmi_overall_elsa <- ggplot(ga2m_bmi_plot_data_overall_elsa, aes(bin, score)) + 
  geom_stepconfint(aes(ymin = score-sd, ymax = score+sd), fill = "gray", alpha = .5) +
  geom_step(linewidth = 1, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(10,60),
    breaks = seq(10, 60, by = 5),
  ) +
  labs(
    x = expression(paste("kg/", "m"^2)),
    y = "Score", 
    title = "ELSA (England)"
  )

#### ELSA ####
p_bmi_overall_charls <- ggplot(ga2m_bmi_plot_data_overall_charls, aes(bin, score)) + 
  geom_stepconfint(aes(ymin = score-sd, ymax = score+sd), fill = "gray", alpha = .5) +
  geom_step(linewidth = 1, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(10,60),
    breaks = seq(10, 60, by = 5)
  ) +
  labs(
    x = expression(paste("kg/", "m"^2)),
    y = "Score", 
    title = "CHARLS (China)"
  )

#### pool ####
p_bmi_ga2m_overall <- wrap_elements(
  p_bmi_overall_hrs + p_bmi_overall_elsa + p_bmi_overall_charls +
  plot_annotation(
    title = expression(paste(bold("a"), "  Body mass index")),
    theme = theme(plot.title = element_text(size = 20))
    )
  )

```

#### Sleep duration

```{r}

#### ELSA ####
p_sleeph_overall_elsa <- ggplot(ga2m_sleeph_plot_data_overall_elsa, aes(bin, score)) + 
  geom_stepconfint(aes(ymin = score-sd, ymax = score+sd), fill = "gray", alpha = .5) +
  geom_step(linewidth = 1, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(0,14),
    breaks = seq(0, 14, by = 1),
  ) +
  labs(
    x = "Hour", 
    y = "Score", 
    title = "ELSA (England)"
  )

#### CHARLS ####
p_sleeph_overall_charls <- ggplot(ga2m_sleeph_plot_data_overall_charls, aes(bin, score)) + 
  geom_stepconfint(aes(ymin = score-sd, ymax = score+sd), fill = "gray", alpha = .5) +
  geom_step(linewidth = 1, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = .25), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(0,14),
    breaks = seq(0, 14, by = 1)
  ) +
  labs(
    x = "Hour",
    y = "", 
    title = "CHARLS (China)"
  )

#### HRS ####
p_sleeph_overall_hrs <- sv_dependence(
  shp_overall_hrs, v = "sleep", interactions = F, color_var = NULL, color = "#002e8c") +
  theme_void() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = 1, b = .25, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(limits = c(10,30)) +
  labs(
    x = "", 
    y = "", 
    title = ""
  )

#### pool ####
p_sleep_duration_ga2m_overall <- wrap_elements(
  p_sleeph_overall_elsa + p_sleeph_overall_charls + p_sleeph_overall_hrs +
  plot_annotation(
    title = expression(paste(bold("b"), "  Sleep duration")),
    theme = theme(plot.title = element_text(size = 20))
    )
  )

```

#### Fruit and vegetables

```{r}

#### ELSA ####
p_fruit_overall_elsa <- ggplot(ga2m_fruit_plot_data_overall_elsa, aes(bin, score)) + 
  geom_stepconfint(aes(ymin = score-sd, ymax = score+sd), fill = "gray", alpha = .5) +
  geom_step(linewidth = 1, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain"),
    ) +
  scale_x_continuous(
    limits = c(0,23),
    breaks = seq(0, 23, by = 2.5),
  ) +
  labs(
    x = "Fruit, portion", 
    y = "SHAP value", 
    title = "ELSA (England)"
  )


#### ELSA ####
p_veg_overall_elsa <- ggplot(ga2m_vegetable_plot_data_overall_elsa, aes(bin, score)) + 
  geom_stepconfint(aes(ymin = score-sd, ymax = score+sd), fill = "gray", alpha = .5) +
  geom_step(linewidth = 1, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain"),
    ) +
  scale_x_continuous(
    limits = c(0,23),
    breaks = seq(0, 23, by = 2.5),
  ) +
  labs(
    x = "Vegetable, portion", 
    y = "", 
    title = "ELSA (England)"
  )

#### CHARLS ####
p_veg_overall_charls <- sv_dependence(
  shp_overall_hrs, v = "sleep", interactions = F, color_var = NULL, color = "#002e8c") +
  theme_void() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0.5, r = 1, b = .25, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain"),
    ) +
  scale_x_continuous(limits = c(10,30)) +
  labs(
    x = "", 
    y = "", 
    title = ""
  )

#### pool ####
p_fv_ga2m_overall <- wrap_elements(
  p_fruit_overall_elsa + p_veg_overall_elsa + p_veg_overall_charls+ 
  plot_annotation(
    title = expression(paste(bold("c"), "  Fruit and vegetable consumption")),
    theme = theme(plot.title = element_text(size = 20))
    )
  )

```


#### Watch TV

```{r}

#### HRS ####
p_tv_overall_hrs <- ggplot(ga2m_tv_plot_data_overall_hrs, aes(bin, score)) +
  geom_col(fill = "#002e8c") +
  geom_errorbar(aes(ymin = score-sd, ymax = score+sd), width = 0.15, colour = "#cc9c2d", alpha = 1, linewidth = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(0.5,7.5),
    breaks = seq(1, 7, by = 1)
    ) +
  labs(
    x = "Frequency", 
    y = "Score", 
    title = "HRS (USA)"
  )

#### ELSA ####
p_tv_overall_elsa <- ggplot(ga2m_tv_plot_data_overall_elsa, aes(bin, score)) + 
  geom_stepconfint(aes(ymin = score-sd, ymax = score+sd), fill = "gray", alpha = .5) +
  geom_step(linewidth = 1, color = "#002e8c") +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 1, color = "#A90C38") +
  theme_bw() +
  theme(
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.text.x = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 12, vjust = 0, angle = 00, face = "plain"),
    axis.title.y = element_text(size = 12, vjust = 1, angle = 90, face = "plain"),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = .5, r = .25, b = .25, l = 0), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(
    limits = c(0,24),
    breaks = seq(0, 24, by = 2),
  ) +
  labs(
    x = "Hour", 
    y = "", 
    title = "ELSA (England)"
  )

#### CHARLS ####
p_tv_overall_charls <- sv_dependence(
  shp_overall_hrs, v = "sleep", interactions = F, color_var = NULL, color = "#002e8c") +
  theme_void() +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "none",
    plot.margin = unit(c(t = 0.5, r = 1, b = .25, l = 1), "cm"),
    plot.title = element_text(size = 16, hjust = .5, face = "plain")
    ) +
  scale_x_continuous(limits = c(10,30)) +
  labs(
    x = "", 
    y = "", 
    title = ""
  )

#### pool ####
p_tv_ga2m_overall <- wrap_elements(
  p_tv_overall_hrs + p_tv_overall_elsa + p_tv_overall_charls+ 
  plot_annotation(
    title = expression(paste(bold("d"), "  Watching television")),
    theme = theme(plot.title = element_text(size = 20))
    )
  )

```

#### Pool

```{r}

p_pool_ga2m_overall <- wrap_elements(
  p_bmi_ga2m_overall +
  p_sleep_duration_ga2m_overall + 
  p_fv_ga2m_overall + 
  p_tv_ga2m_overall +
  plot_layout(nrow = 4)
  )

ggsave(str_c(getwd(), "/results/Figure/Shape function.pdf", sep = ""), plot = p_pool_ga2m_overall, width = 15, height = 13, unit = "in", dpi = 300, device = "pdf")

ggsave(str_c(getwd(), "/results/Figure/Shape function.png", sep = ""), plot = p_pool_ga2m_overall, width = 15, height = 13, unit = "in", dpi = 300, device = "png")

```


## Supplementary Figure 7: Manhatan plot

```{r}

#### HRS ####
test_results_hrs <- test_results_hrs %>% 
  mutate(
    validated = ifelse(term %in% combined_results_hrs$term, 1, 0),
    color = case_when(
      category == "Demographics" ~ "#B09C85CC",
      category == "Adverse Childhood Experiences" ~ "#E64B35CC",
      category == "Socioeconomic Status" ~ "#4DBBD5CC",
      category == "Material Circumstances" ~ "#00A087CC",
      category == "Social Connections" ~ "#3C5488CC",
      category ==  "Social Stressors" ~ "#F39B7FCC",
      category == "Health Behaviors" ~ "#8491B4CC",
      category == "Healthcare Systems" ~ "#91D1C2CC"
      ),
    color = ifelse(validated == 1, color, "#D9D9D9CC")
    )

set.seed(12345)
p_manhattan_hrs <- ggplot(test_results_hrs, aes(x = as.factor(category), y = neg_log_p)) +
  geom_point(aes(color = color), alpha = 0.7, position = position_jitter(width = 0.2, height = 0)) + 
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "gray") + 
  geom_text_repel(data = test_results_hrs %>% filter(validated == 1) %>% arrange(-neg_log_p) %>% slice_head(n = 20), aes(label = var_name), seed = 42, box.padding = 0.1, size = 4, max.overlaps = 50) +
  theme_classic() +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 16, angle = 00, face = "bold"),
    axis.title.y = element_markdown(size = 16, angle = 90, face = "bold"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold")
    ) +
  labs(
    x = NULL, 
    y = "-log<sub>10</sub>(*P*)",
    title = "HRS (USA)"
    ) + 
  scale_color_identity()


#### ELSA ####
test_results_elsa <- test_results_elsa %>% 
  mutate(
    validated = ifelse(term %in% combined_results_elsa$term, 1, 0),
    color = case_when(
      category == "Demographics" ~ "#B09C85CC",
      category == "Adverse Childhood Experiences" ~ "#E64B35CC",
      category == "Socioeconomic Status" ~ "#4DBBD5CC",
      category == "Material Circumstances" ~ "#00A087CC",
      category == "Social Connections" ~ "#3C5488CC",
      category ==  "Social Stressors" ~ "#F39B7FCC",
      category == "Health Behaviors" ~ "#8491B4CC",
      category == "Healthcare Systems" ~ "#91D1C2CC"
      ),
    color = ifelse(validated == 1, color, "#D9D9D9CC")
    )

set.seed(12345)
p_manhattan_elsa <- ggplot(test_results_elsa, aes(x = as.factor(category), y = neg_log_p)) +
  geom_point(aes(color = color), alpha = 0.7, position = position_jitter(width = 0.2, height = 0)) + 
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "gray") + 
  geom_text_repel(data = test_results_elsa %>% filter(validated == 1), aes(label = var_name), seed = 42, box.padding = 0.1, size = 4, max.overlaps = 50) +
  theme_classic() +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 16, angle = 00, face = "bold"),
    axis.title.y = element_markdown(size = 16, angle = 90, face = "bold"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold")
    ) +
  labs(
    x = NULL, 
    y = "-log<sub>10</sub>(*P*)",
    title = "ELSA (England)"
    ) +  
  scale_color_identity()


#### CHARLS ####
test_results_charls <- test_results_charls %>% 
  mutate(
    validated = ifelse(term %in% combined_results_charls$term, 1, 0),
    color = case_when(
      category == "Demographics" ~ "#B09C85CC",
      category == "Adverse Childhood Experiences" ~ "#E64B35CC",
      category == "Socioeconomic Status" ~ "#4DBBD5CC",
      category == "Material Circumstances" ~ "#00A087CC",
      category == "Social Connections" ~ "#3C5488CC",
      category ==  "Social Stressors" ~ "#F39B7FCC",
      category == "Health Behaviors" ~ "#8491B4CC",
      category == "Healthcare Systems" ~ "#91D1C2CC"
      ),
    color = ifelse(validated == 1, color, "#D9D9D9CC")
    )

set.seed(12345)
p_manhattan_charls <- ggplot(test_results_charls, aes(x = as.factor(category), y = neg_log_p)) +
  geom_point(aes(color = color), alpha = 0.7, position = position_jitter(width = 0.2, height = 0)) + 
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "gray") + 
  geom_text_repel(data = test_results_charls %>% filter(validated == 1), aes(label = var_name), seed = 42, box.padding = 0.1, size = 4, max.overlaps = 50) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 12, colour = "black", hjust = 1, angle = 45),
    axis.text.y = element_text(size = 12, colour = "black", vjust = .5, angle = 0),
    axis.title.x = element_text(size = 16, angle = 00, face = "bold"),
    axis.title.y = element_markdown(size = 16, angle = 90, face = "bold"),
    plot.title = element_text(size = 16, hjust = .5, face = "bold")
    ) +
  labs(
    x = NULL, 
    y = "-log<sub>10</sub>(*P*)",
    title = "CHARLS (China)"
    ) + 
  scale_color_identity()

#### pool ####
legend <- ggplot(shap_domain_plot_charls %>% filter(!category %in% "Demographics"), aes(x = group, y = value_normalized, fill = category)) +
  geom_bar(stat = "identity", width = 0.75) +
  geom_text(aes(label = perc), colour = "black", size = 5, position = position_stack(vjust = 0.5)) +
  theme_bw() +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "bottom",
    legend.margin = margin(0, 0, 0, 0, "cm"),
    legend.key = element_rect(linewidth = 5),
    legend.key.size = unit(1.5, "lines")
    ) +
  scale_fill_manual(
    values = c("#E64B35CC", "#4DBBD5CC", "#00A087CC", "#3C5488CC", "#F39B7FCC", "#8491B4CC", "#91D1C2CC")
  )

p_manhattan_all <- wrap_elements(
  p_manhattan_hrs + p_manhattan_elsa + p_manhattan_charls +
  plot_layout(nrow = 3, heights = c(0.9, 0.9, 1)) +
  plot_annotation(tag_levels = "a") &
  theme(plot.tag = element_text(size = 16, face = "bold"))
)

manhattan_all <- wrap_plots(p_manhattan_all, ggpubr::get_legend(legend), heights = c(10,1))

ggsave(str_c(getwd(), "/results/Figure/Manhattan plot.png", sep = ""), plot = manhattan_all, width = 18, height = 16, unit = "in", dpi = 300, device = "png")

ggsave(str_c(getwd(), "/results/Figure/Manhattan plot.pdf", sep = ""), plot = manhattan_all, width = 18, height = 16, unit = "in", dpi = 300, device = "pdf")

```
