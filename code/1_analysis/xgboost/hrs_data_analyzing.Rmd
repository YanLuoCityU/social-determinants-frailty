---
title: "Social determinants predict frailty_HRS"
author: "Yan Luo"
date: '2025-04-10'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Make sure the working directory is "your path/social-determinants-frailty"
knitr::opts_knit$set(root.dir = "D:/github_project/social-determinants-frailty")

# Data manipulation and visualization
library(tidyverse)
library(skimr)

# Data import and label handling
library(haven)
library(sjlabelled)

# Missing value handling and analysis
library(VIM)
library(missRanger)

# Statistical analysis and reporting
library(gtsummary)
library(boot)
library(shapviz)

# Machine learning modeling
library(tidymodels)

# Parallel computing and performance
library(doParallel)
library(tictoc)

```

# Self-defined functions

```{r}

# Convert values to a factor with levels "yes" and "no", and set "no" as the reference level
fac_relevel <- function(x){
  y <- factor(x, labels = c("yes", "no"))
  z <- relevel(y, ref = "no")
  return(z)
}

# Convert numeric values to a factor with "yes"/"no" levels
fac_relevel2 <- function(x){
  y <- factor(ifelse(x %in% c(8, 9), NA, x), labels = c("yes", "no"))
  z <- relevel(y, ref = "no")
  return(z)
}

# Convert values to a factor with levels "no" and "yes", and set "no" as the reference level
fac_relevel3 <- function(x){
  y <- factor(x, labels = c("no", "yes"))
  z <- relevel(y, ref = "no")
  return(z)
}

# Replace values equal to 10 with NA
relevel2 <- function(x){
  y <- ifelse(x == 10, NA, x)
  return(y)
}

# Reverse code a scale by subtracting values from the maximum value plus 1
reverse_code <- function(x) {
  max_val <- max(x, na.rm = T)
  return(max_val - x + 1)
}

# Count the number of NA values in a row
count_na_row <- function(x) sum(is.na(x)) 

# Calculate Mean Absolute Error (MAE) for a model using bootstrap resampling
mae_func <- function(model, data, indices){
  data_pred <- data[indices,] %>%
    mutate(
      pred = as.numeric(predict(model, new_data = ., type = "raw"))
      )
  return(data_pred %>%
    yardstick::metrics(fi, pred) %>%
    filter(.metric == "mae") %>%
    pull(.estimate))
}

# Calculate R-squared for a model using bootstrap resampling
rsq_func <- function(model, data, indices){
  data_pred <- data[indices,] %>%
    mutate(
      pred = as.numeric(predict(model, new_data = ., type = "raw"))
      )
  return(data_pred %>%
    yardstick::metrics(fi, pred) %>%
    filter(.metric == "rsq") %>%
    pull(.estimate))
}

# Calculate Root Mean Squared Error (RMSE) for a model using bootstrap resampling
rmse_func <- function(model, data, indices){
  data_pred <- data[indices,] %>%
    mutate(
      pred = as.numeric(predict(model, new_data = ., type = "raw"))
      )
  return(data_pred %>%
    yardstick::metrics(fi, pred) %>%
    filter(.metric == "rmse") %>%
    pull(.estimate))
}

# Create a tidymodels workflow by combining a model and recipe
create_workflow <- function(model, recipe) {
  workflow() %>%
    add_recipe(recipe) %>%
    add_model(model)
}

# Tune a model using grid search with parallel processing
tune_model <- function(workflow, resamples, grid, metrics) {
  n_cores <- detectCores()
  doParallel::registerDoParallel(n_cores/2)
  
  grid_ctrl <- control_grid(
    verbose = TRUE,
    save_pred = FALSE,
    parallel_over = NULL,
    save_workflow = FALSE
  )
  
  tic()
  tuned_results <- tune_grid(
    object = workflow,
    resamples = resamples,
    grid = grid,
    metrics = metrics,
    control = grid_ctrl
  )
  toc()
  
  return(tuned_results)
}

# Evaluate model performance on new data with special handling for ranger models
evaluate_model <- function(model, new_data) {
  # Special handling for ranger random forest model
  if (class(final_rf_mod$fit$fit)[1] == "_ranger") {
    pred <- predict(model, new_data = new_data)$.pred
  } else {
    pred <- predict(model, new_data = new_data, type = "raw") %>% as.vector()
  }
  
  new_data %>%
    mutate(
      pred = pred
    ) %>%
    yardstick::metrics(fi, pred) %>%
    mutate(.estimate = format(round(.estimate, 4), big.mark = ","))
}

# Analyze cross-validation performance for a tuned model
analyze_cv_performance <- function(tuned_model, best_params) {
  best_param_names <- names(best_params)[names(best_params) != ".config"]
  
  filter_conditions <- lapply(best_param_names, function(param) {
    quo(!!sym(param) == best_params[[!!param]])
  })
  
  cv_metrics <- tuned_model %>%
    collect_metrics(summarize = FALSE) %>%
    filter(!!!filter_conditions)
  
  cv_metrics %>%
    group_by(.metric) %>%
    summarise(
      mean = mean(.estimate, na.rm = TRUE),
      sd = sd(.estimate, na.rm = TRUE),
      median = median(.estimate, na.rm = TRUE)
    ) %>%
    mutate(across(where(is.numeric), ~round(., 4)))
}

# Compare performance metrics across multiple machine learning models
analyze_all_models <- function(
  svm_tuned, svm_best_params,
  xgb_tuned, xgb_best_params,
  rf_tuned, rf_best_params,
  lasso_tuned, lasso_best_params,
  elastic_tuned, elastic_best_params
) {
  model_performances <- list(
    SVM = analyze_cv_performance(svm_tuned, svm_best_params),
    XGBoost = analyze_cv_performance(xgb_tuned, xgb_best_params),
    RandomForest = analyze_cv_performance(rf_tuned, rf_best_params),
    Lasso = analyze_cv_performance(lasso_tuned, lasso_best_params),
    ElasticNet = analyze_cv_performance(elastic_tuned, elastic_best_params)
  )
  
  bind_rows(model_performances, .id = "Model")
}

# Perform an environmental wide association study by testing each variable's association with a dependent variable
environmental_wide_association_study <- function(data, dependent_var = "fi", control_vars = c("age", "male")) {

  all_vars <- names(data)
  excluded_vars <- c(dependent_var, control_vars)
  predictor_vars <- setdiff(all_vars, excluded_vars)
  
  results <- data.frame()
  
  for (var in predictor_vars) {
    formula_str <- paste(dependent_var, "~", paste(c(control_vars, var), collapse = " + "))
    model_formula <- as.formula(formula_str)
    
    model <- lm(model_formula, data = data)
    
    model_summary <- tidy(model)
    
    var_summary <- model_summary[!model_summary$term %in% c("(Intercept)", "age", "malemale"), ] %>%
      mutate(var = var)
    
    results <- rbind(results, var_summary)
  }
  
  results <- results %>%
    dplyr::select(var, term, estimate, std.error, p.value) %>%
    arrange(term, p.value)
  
  return(results)
}

```

# Data preprocessing

## Long format Harmonized_HRS and RAND_HRS (without defining variables)

```{r}

print(getwd())

# Import the data
memory.limit(size = 18000)
harm_hrs <- read_sas(str_c(getwd(), "/data/raw/hrs/H_HRS_c.sas7bdat", sep = ""))
rand_hrs <- read_sas(str_c(getwd(), "/data/raw/hrs/randhrs1992_2018v2.sas7bdat", sep = ""))

############### Long format Harmonized_HRS (without define variables) #####################
rand_hrs_age <- rand_hrs %>%
  dplyr::select(
    c(HHIDPN) | (starts_with("R") & contains("AGE") & ends_with("_E") & !contains("ESP")) # Age
  ) %>% 
  rename_with(tolower)

wide_harm_hrs <- harm_hrs %>%
  left_join(rand_hrs_age, by = "hhidpn") %>%
  dplyr::select(
    #### Demographics
    c(hhid, pn, hhidpn, raeducl, ramomeducl, radadeducl, radadoccup,
      rachshlt, rafinanch, ralivdiffch, rapadivch, rapadiech, rasepmom, rasepdad) | 
      (starts_with("r") & contains("age") & ends_with("_e")) | # Age (for merging data)
      (starts_with("h") & (ends_with("lang_h"))) | # Language of Interview
      (starts_with("h") & (ends_with("rural"))) | # Whether Lives in Urban or Rural Area
      (starts_with("r") & (ends_with("hometyp"))) | # Type of Property
    #### Health Behaviors
      (starts_with("r") & (ends_with("smokef"))) | # Health behaviours
      (starts_with("r") & (ends_with("bmicat") | ends_with("obese"))) | # self-reported BMI/obese
      (starts_with("r") & (ends_with("fallslp") | ends_with("wakent") | ends_with("wakeup") | ends_with("rested") | ends_with("rxslp"))) | # Sleep problems
    #### Social Connections
      (starts_with("h") & (ends_with("lvalone"))) | # Live alone
      (starts_with("r") & (ends_with("socwk") | ends_with("socmn") | ends_with("relgwk") | ends_with("socrelg_h"))) | # Social Activities
      (starts_with("r") & (ends_with("kcnt") | ends_with("rfcnt"))) | # Weekly contact with other people
    #### Functions
      (starts_with("r") & (ends_with("sight") | ends_with("dsight") | ends_with("nsight"))) | # Vision (including distance/near eyesight)
      (starts_with("r") & (ends_with("hearing") | ends_with("hearaid"))) | # Hearing 
      (starts_with("r") & (ends_with("adltot_h") | ends_with("adltotm_h"))) | # ADL(0-6)
      (starts_with("r") & (ends_with("iadltot_h") | ends_with("iadltotm_h"))) | # IADL(0-6)
      (starts_with("r") & ((ends_with("orient") & !contains("f")) | ends_with("numer") | ends_with("verbf"))) |
    #### Self-reported Health
      (starts_with("r") & (ends_with("painfr"))) | # Pain
      (starts_with("r") & ends_with("fall")) | # Fall
      (starts_with("r") & ends_with("hipe")) | # Fractured hip
      (starts_with("r") & ends_with("urinai")) # Urinary Incontinence
     ) %>% 
  mutate(
    .keep = "unused",
    r1fallslp = NA, r2fallslp = NA, r3fallslp = NA, r4fallslp = NA, r5fallslp = NA, r1wakent = NA, r2wakent = NA, r3wakent = NA, r4wakent = NA, r5wakent = NA, r1wakeup = NA, r2wakeup = NA, r3wakeup = NA, r4wakeup = NA, r5wakeup = NA, r1rested = NA, r2rested = NA, r3rested = NA, r4rested = NA, r5rested = NA, r1rxslp = NA, r2rxslp = NA, r3rxslp = NA, r4rxslp = NA, r5rxslp = NA, r6rxslp = NA, r7rxslp = NA, # Sleep problems
    r1socwk = NA, r2socwk = NA, r3socwk = NA, r4socwk = NA, r5socwk = NA, r6socwk = NA, r7socwk = NA, r8socwk = NA, 
    r1socmn = NA, r2socmn = NA, r3socmn = NA, r4socmn = NA, r5socmn = NA, r6socmn = NA, r7socmn = NA, r8socmn = NA, # Social Activities
    r4relgwk = NA, r6relgwk = NA, r4socrelg_h = NA, r6socrelg_h = NA,
    r1kcnt = NA, r2kcnt = NA, r3kcnt = NA, r4kcnt = NA, r5kcnt = NA, r6kcnt = NA, 
    r1rfcnt = NA, r2rfcnt = NA, r3rfcnt = NA, r4rfcnt = NA, r5rfcnt = NA, r6rfcnt = NA, # Weekly contact
    r1dsight = NA, r2dsight = NA, r1nsight = NA, r2nsight = NA, # Vision
    r1iadltot_h = NA, r1iadltotm_h = NA, # IADL
    r1orient = NA, r1numer = NA, r2numer = NA, r3numer = NA, r4numer = NA, r5numer = NA, r1verbf = NA, r2verbf = NA, r3verbf = NA, r4verbf = NA, r5verbf = NA, r6verbf = NA, r7verbf = NA, r8verbf = NA, r9verbf = NA, r1orient = NA, r14orient = NA, # Cognition
    r1fall = NA, r2fall = NA, # Fall
    r1hipe = NA, # Fractured hip
    r1urinai = NA, # Urinary Incontinence
    r1mbmicat = NA, r2mbmicat = NA, r3mbmicat = NA, r4mbmicat = NA, r5mbmicat = NA, r6mbmicat = NA,
    r1mobese = NA, r2mobese = NA, r3mobese = NA, r4mobese = NA, r5mobese = NA, r6mobese = NA 
  ) 

index_reorder <- str_detect(names(wide_harm_hrs), "[h-r][0-9]+(.*)")
names_reorder <- names(wide_harm_hrs)[index_reorder] %>% 
  str_match("[h-r]([0-9]+)(.*)") %>% 
  as_tibble() %>% 
  arrange(.[[3]], as.numeric(.[[2]])) %>%
  dplyr::select(V1) %>%
  as_vector("character") %>% unname()

long_harm_hrs <- wide_harm_hrs %>% 
  dplyr::select(!contains(names_reorder), contains(names_reorder)) %>%
  pivot_longer(
    col = !c(hhid, pn, hhidpn, raeducl, ramomeducl, radadeducl, radadoccup, rachshlt, rafinanch, ralivdiffch, rapadivch, rapadiech, rasepmom, rasepdad),
    names_to = ".value",
    names_pattern = "[h-r][0-9]+(.*)"
  )

rm(harm_hrs, wide_harm_hrs, rand_hrs_age)

############### Long format RAND_HRS (without define variables) #####################
wide_rand_hrs <- rand_hrs %>%
  dplyr::select(
    #### Demographics
    c(HHIDPN, HHID, PN, # id
      RAGENDER, # Gender
      RABYEAR, RADAGE_M, RADAGE_Y, RADYEAR, RADMONTH, RADTIMTDTH, # Birth year, Death information
      RARACEM, RAHISPAN, RAEDUC, RAEDYRS, # Race, Hispanic, Education
      RASSRECV, RABPLACE, # Receives social security, place of born
      RAMEDUC, RAFEDUC # parental education
    ) | 
      (starts_with("INW")) | # Wave Status: Response Indicator
      (starts_with("R") & (ends_with("IWEND") | ends_with("IWENDY") | ends_with("IWENDM")))  | # Interview dates
      (starts_with("R") & contains("AGE") & ends_with("_E") & !contains("ESP")) | # Age
      (starts_with("R") & (ends_with("CENREG"))) | # Census Region
    #### Wealth & Income & Insurance
      (starts_with("H") & (ends_with("ATOTB") | ends_with("ATOTW") | ends_with("ATOTN")  | ends_with("ATOTH") | ends_with("ANETHB") | ends_with("ADEBT") | ends_with("ITOT"))) |
      (starts_with("R") & (ends_with("PENINC"))) | # currently receiving pension income
      (starts_with("R") & (ends_with("HIGOV") | ends_with("GOVMR") | ends_with("GOVMD") | ends_with("GOVVA") | ends_with("PRPCNT") | ends_with("COVR") | ends_with("HILTC") | ends_with("LIFEIN") | ends_with("OOPMD"))) | # Covered by federal gov health insurance (Medicare, Medicaid, VA/CHAMPUS), by current or previous employer, long-term care insurance, life insurance 
      (starts_with("R") & (ends_with("HOSP") | ends_with("HSPTIM") | ends_with("HSPNIT") | ends_with("DOCTOR") | ends_with("OUTPT") | ends_with("DOCTIM") | ends_with("NRSHOM") | ends_with("HOMCAR") | ends_with("NRSTIM") | ends_with("DENTST"))) | # healthcare utilization
    #### Employment & Retirement
      (starts_with("R") & (ends_with("LBRF") | ends_with("JPHYS") | ends_with("JSTRES") | ends_with("HLTHLM") | ends_with("SAYRET") | ends_with("RETSAT") | ends_with("WORK") | ends_with("WORK2"))) | # labor force status, current job requires physical effort, current job involves lots of stress, Whether health limits work
    #### Family structure
      (starts_with("H") & (ends_with("CPL"))) | # Whether Couple Household
      (starts_with("R") & (ends_with("MOMLIV") | ends_with("DADLIV") | ends_with("LIVSIB"))) | 
      (starts_with("H") & (ends_with("HHRES") | ends_with("CHILD"))) | 
    #### Health behaviours
      (starts_with("R") & (ends_with("SMOKEV") | ends_with("SMOKEN") | ends_with("DRINK") | ends_with("DRINKD") | ends_with("DRINKN") | ends_with("VGACTX") | ends_with("MDACTX") | ends_with("LTACTX"))) | 
    #### Social Connections
      (starts_with("R") & (ends_with("MSTAT"))) | # Marital status
      (starts_with("R") & (ends_with("FLONE"))) | # Loneliness from the CES-D
    #### Chronic Diseases
      (starts_with("R") & (ends_with("HIBPE") | ends_with("DIABE") | ends_with("CANCRE") | ends_with("LUNGE") | ends_with("HEARTE") | ends_with("STROKE") | ends_with("PSYCHE") | ends_with("ARTHRE"))) | 
      (starts_with("R") & (ends_with("MEMRYE") | ends_with("ALZHEE") | ends_with("DEMENE"))) | # Memory-related diseases, Alzheimer’s disease, dementia
    #### Functions
      (starts_with("R") & (ends_with("BATHA") | ends_with("EATA") | ends_with("BEDA") | ends_with("TOILTA") | ends_with("WALKRA") | ends_with("DRESSA"))) | # ADL
      (starts_with("R") & (ends_with("MAPA") | ends_with("PHONEA") | ends_with("MONEYA") | ends_with("MEDSA") | ends_with("SHOPA") | ends_with("MEALSA"))) | # IADL
      (starts_with("R") & (ends_with("WALKSA") | ends_with("JOGA") | ends_with("WALK1A") | ends_with("SITA") | ends_with("CHAIRA") | ends_with("CLIMSA") | ends_with("CLIM1A") | ends_with("STOOPA") | ends_with("LIFTA") | ends_with("DIMEA") | ends_with("ARMSA") | ends_with("PUSHA"))) | # Other functional limitations
      (starts_with("R") & (ends_with("IMRC") | ends_with("DLRC") | ends_with("SER7") | ends_with("BWC20") | ends_with("MO") | ends_with("DY") | ends_with("YR") | ends_with("DW") | ends_with("SCIS") | ends_with("CACT") | ends_with("PRES") | ends_with("VP") | ends_with("VOCAB") | ends_with("TR20") | ends_with("MSTOT") | ends_with("COGTOT"))) | # Cognition
      (starts_with("R") & (ends_with("DEPRES") | ends_with("EFFORT") | ends_with("SLEEPR") | ends_with("WHAPPY") | ends_with("FSAD") | ends_with("GOING") | ends_with("ENLIFE") | ends_with("CESD") | ends_with("CESDM"))) | # CES-D *excluding Felt lonely
    #### Self-reported Health and BMI
      (starts_with("R") & (ends_with("SHLT") | (ends_with("BMI") & !contains("PM"))))
     ) %>% 
  mutate( # generate n variables (with NA values or values from other related variables) to make the number of measurements equal to 14 (R1 to R14)
    .keep = "unused",
    # Currently receiving any pension income
    R1PENINC = NA, 
    # Healthcare Utilization
    R1OOPMD = NA, R1OUTPT = NA, R1DENTST = NA,
    # Memory-related diseases, Alzheimer’s disease, dementia
    R1MEMRYE = NA, R2MEMRYE = NA, R3MEMRYE = NA, 
    R10MEMRYE = R10ALZHEE + R10DEMENE, R11MEMRYE = R11ALZHEE + R11DEMENE, R12MEMRYE = R12ALZHEE + R12DEMENE, R13MEMRYE = R13ALZHEE + R13DEMENE, R14MEMRYE = R14ALZHEE + R14DEMENE,
    # ADL
    R1BATHA = NA, R1EATA = NA, R1BEDA = NA, R1TOILTA = NA, R1WALKRA = NA, R1DRESSA = NA,
    # IADL
    R1MAPA = NA, R1PHONEA = NA, R1MONEYA = NA, R1MEDSA = NA, R1SHOPA = NA, R1MEALSA = NA,
    # Functional limitations
    R1WALKSA = NA, R1JOGA = NA, R1WALK1A = NA, R1SITA = NA, R1CHAIRA = NA, R1CLIMSA = NA, R1CLIM1A = NA, R1STOOPA = NA, R1LIFTA = NA, R1DIMEA = NA, R1ARMSA = NA, R1PUSHA = NA,
    # Drinking
    R1DRINKD = NA, R2DRINKD = NA, R1DRINKN = NA, R2DRINKN = NA,
    # Physical activity
    R1VGACTX = NA, R2VGACTX = NA, R3VGACTX = NA, R4VGACTX = NA, R5VGACTX = NA, R6VGACTX = NA, R1MDACTX = NA, R2MDACTX = NA, R3MDACTX = NA, R4MDACTX = NA, R5MDACTX = NA, R6MDACTX = NA, R1LTACTX = NA, R2LTACTX = NA, R3LTACTX = NA, R4LTACTX = NA, R5LTACTX = NA, R6LTACTX = NA,
    # Cognition
    R1IMRC = NA, R2IMRC = NA, R1DLRC = NA, R2DLRC = NA, R1BWC20 = NA, R1MO = NA, R1DY = NA, R1YR = NA, R1DW = NA, R1SCIS = NA, R1CACT = NA, R1PRES = NA, R1VP = NA, R1VOCAB = NA, R2VOCAB = NA, R1TR20 = NA, R2TR20 = NA, R1MSTOT = NA, R2MSTOT = NA, R1COGTOT = NA, R2COGTOT = NA, 
    R1FVOCAB = NA, R2FVOCAB = NA, R1SER7 = NA, R1FYR = NA, R1FVP = NA, R1FSER7 = NA, R1FSCIS = NA, R1FPRES = NA, R1FMO = NA, R1FDY = NA, R1FDW = NA, R1FCACT = NA, R1FBWC20 = NA,
    # CES-D
    R1DEPRES = NA, R1EFFORT = NA, R1SLEEPR = NA, R1WHAPPY = NA, R1FLONE = NA, R1FSAD = NA, R1GOING = NA, R1ENLIFE = NA, R1CESD = NA
  ) %>%
  dplyr::select(!c(REIWEND, RECENREG, REOOPMD, REGOVMR, REGOVVA, R2AMSTOT, REHIGOV, RECOVR, REHILTC, REHILTC, RENRSHOM, RENRSTIM, REDOCTOR, REDOCTIM, REHOSP, REHOMCAR, REHSPTIM, REHSPNIT, REMSTAT, RACOHBYR, RAOVRAYR, REXITYR, R2ATR20, R1BEDW, R2MONEYR))

index_reorder <- str_detect(names(wide_rand_hrs), "[H-R][0-9]+(.*)")
names_reorder <- names(wide_rand_hrs)[index_reorder] %>% 
  str_match("[H-R]([0-9]+)(.*)") %>% 
  as_tibble() %>% 
  arrange(.[[3]], as.numeric(.[[2]])) %>%
  dplyr::select(V1) %>%
  as_vector("character") %>% 
  unname()

long_rand_hrs <- wide_rand_hrs %>% 
  dplyr::select(!contains(names_reorder), contains(names_reorder)) %>%
  dplyr::select(!c(INW1, INW2, INW3, INW4, INW5, INW6, INW7, INW8, INW9, INW10, INW11, INW12, INW13, INW14)) %>%
  pivot_longer(
    col = !c(HHIDPN, HHID, PN, RAGENDER, RABYEAR, RADAGE_M, RADAGE_Y, RADYEAR, RADMONTH, RADTIMTDTH, RARACEM, RAHISPAN, RAEDUC, RAEDYRS, RASSRECV, RABPLACE, RAMEDUC, RAFEDUC),
    names_to = ".value", 
    names_pattern = "[H-R][0-9]+(.*)"
  ) %>%
  group_by(HHIDPN) %>%
  mutate(
    followup = row_number(),
    wave = case_when(
      IWENDY %in% c(1998:1999) ~ 1998,
      IWENDY %in% c(2000) ~ 2000,
      IWENDY %in% c(2002:2003) ~ 2002,
      IWENDY %in% c(2004:2005) ~ 2004,
      IWENDY %in% c(2006:2007) ~ 2006,
      IWENDY %in% c(2008:2009) ~ 2008,
      IWENDY %in% c(2010:2011) ~ 2010,
      IWENDY %in% c(2012:2013) ~ 2012,
      IWENDY %in% c(2014:2015) ~ 2014,
      IWENDY %in% c(2016:2017) ~ 2016,
      IWENDY %in% c(2018) & followup < max(row_number()) ~ 2016,
      IWENDY %in% c(2018) & followup == max(row_number()) ~ 2018,
      IWENDY %in% c(2019) ~ 2018
    )
  ) %>%
  ungroup() %>%
  dplyr::select(!c(followup))

rm(rand_hrs, wide_rand_hrs, index_reorder, names_reorder)

```

## Add variables from original raw data (core + LBQ)

### 2010 - 2016 cohort core questionnaire

```{r}

# 2010
hrs_n_w10 <- read_dta(str_c(getwd(), "/data/raw/hrs/H10N_R.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhidpn = as.numeric(str_c(HHID, PN)), hhid = as.numeric(HHID), subhh = MSUBHH, wave = 2010,
    caresat = MN235, usualcare = NA, usualcare2 = NA
  )

hrs_q_w10 <- read_dta(str_c(getwd(), "/data/raw/hrs/H10Q_H.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhid = as.numeric(HHID), subhh = MSUBHH, wave = 2010,
    efoodstamp = MQ400, nfoodstamp = MQ532, enoughfood = MQ415, lessfood = MQ516,
  )

hrs_h_w10 <- read_dta(str_c(getwd(), "/data/raw/hrs/H10H_H.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhid = as.numeric(HHID), subhh = MSUBHH, wave = 2010,
    homeown = MH004, nnsafety = MH150, hometype = MH002, transport = MH118, kitchen = MH146, roomnum = MH147
  )

hrs_core_w10 <- full_join(hrs_q_w10, hrs_h_w10, by = c("hhid", "subhh", "wave")) %>%
  right_join(., hrs_n_w10, by = c("hhid", "subhh", "wave"))
rm(hrs_n_w10, hrs_q_w10, hrs_h_w10)

# 2012
hrs_n_w11 <- read_dta(str_c(getwd(), "/data/raw/hrs/H12N_R.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhidpn = as.numeric(str_c(HHID, PN)), hhid = as.numeric(HHID), subhh = NSUBHH, wave = 2012,
    caresat = NN235, usualcare = NN291, usualcare2 = NN292
  )

hrs_q_w11 <- read_dta(str_c(getwd(), "/data/raw/hrs/H12Q_H.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhid = as.numeric(HHID), subhh = NSUBHH, wave = 2012,
    efoodstamp = NQ400, enoughfood = NQ415
  )

hrs_h_w11 <- read_dta(str_c(getwd(), "/data/raw/hrs/H12H_H.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhid = as.numeric(HHID), subhh = NSUBHH, wave = 2012,
    homeown = NH004, nnsafety = NH150, hometype = NH002, transport = NH118, kitchen = NH146, roomnum = NH147
  )

hrs_core_w11 <- full_join(hrs_q_w11, hrs_h_w11, by = c("hhid", "subhh", "wave")) %>%
  right_join(., hrs_n_w11, by = c("hhid", "subhh", "wave"))
rm(hrs_n_w11, hrs_q_w11, hrs_h_w11)

# 2014
hrs_n_w12 <- read_dta(str_c(getwd(), "/data/raw/hrs/H14N_R.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhidpn = as.numeric(str_c(HHID, PN)), hhid = as.numeric(HHID), subhh = OSUBHH, wave = 2014,
    caresat = ON235, usualcare = ON291, usualcare2 = ON292
  )

hrs_q_w12 <- read_dta(str_c(getwd(), "/data/raw/hrs/H14Q_H.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhid = as.numeric(HHID), subhh = OSUBHH, wave = 2014,
    efoodstamp = OQ400, nfoodstamp = OQ532, enoughfood = OQ415, lessfood = OQ516,
  )

hrs_h_w12 <- read_dta(str_c(getwd(), "/data/raw/hrs/H14H_H.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhid = as.numeric(HHID), subhh = OSUBHH, wave = 2014,
    homeown = OH004, nnsafety = OH150, hometype = OH002, transport = OH118, kitchen = OH146, roomnum = OH147
  )

hrs_core_w12 <- full_join(hrs_q_w12, hrs_h_w12, by = c("hhid", "subhh", "wave")) %>%
  right_join(., hrs_n_w12, by = c("hhid", "subhh", "wave"))
rm(hrs_n_w12, hrs_q_w12, hrs_h_w12)

# 2016
hrs_n_w13 <- read_dta(str_c(getwd(), "/data/raw/hrs/H16N_R.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhidpn = as.numeric(str_c(HHID, PN)), hhid = as.numeric(HHID), subhh = PSUBHH, wave = 2016,
    caresat = PN235, usualcare = PN291, usualcare2 = PN292
  )

hrs_q_w13 <- read_dta(str_c(getwd(), "/data/raw/hrs/H16Q_H.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhid = as.numeric(HHID), subhh = PSUBHH, wave = 2016,
    efoodstamp = PQ400, nfoodstamp = PQ532, enoughfood = PQ415, lessfood = PQ516,
  )

hrs_h_w13 <- read_dta(str_c(getwd(), "/data/raw/hrs/H16H_H.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhid = as.numeric(HHID), subhh = PSUBHH, wave = 2016,
    homeown = PH004, nnsafety = PH150, hometype = PH002, transport = PH118, kitchen = PH146, roomnum = PH147
  )

hrs_core_w13 <- full_join(hrs_q_w13, hrs_h_w13, by = c("hhid", "subhh", "wave")) %>%
  right_join(., hrs_n_w13, by = c("hhid", "subhh", "wave"))
rm(hrs_n_w13, hrs_q_w13, hrs_h_w13)

```

### 2010 - 2012 cohort LBQ questionnaire

```{r}

# 2010 -------------------------------------------------------------------------
hrs_lbq_w10 <- read_dta(str_c(getwd(), "/data/raw/hrs/H10LB_R.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhidpn = as.numeric(str_c(HHID, PN)), wave = 2010, 
    lbelig = MLBELIG, lbcomp = MLBCOMP, # 13702 without completing LBQ (8332 with)
    # Childhood Adverse Experiences
      # Q37c. Lifetime Traumas before the Age of 18
    mischlth = MLB037K, trbpolic = MLB037L, padrug = MLB037M, pabused = MLB037N, 
    
    # Childhood Social Connections
       # Q32a. Quality of Relationships with Parents Early in Life
    momgrela = MLB032D, dadgrela = MLB032E,
    
      # Q37b. Quality of Relationship with Mother Early in Life
    momeft = MLB037I, momatt = MLB037H, momteach = MLB037J,
    
    # Adulthood Socioeconomic
      # Q21. Neighborhood Disorder/Neighborhood Social Cohesion
        # Neighborhood Social Cohesion
    nobelong = MLB021A, notrusted = MLB021C, unfriend = MLB021E, nohelp = MLB021G, 
        # Neighborhood Physical Disorder
    vandal = MLB021B, afwalk = MLB021D, rubbish = MLB021F, vacant = MLB021H, 
    
      # Q40. Experience of Financial Strain
    diff2pay = MLB040, 
    
    # Adulthood Social Connections
      # Q1. Social Participation - Social Engagement
    care = MLB001A, playwthchld = MLB001B, volunteer = MLB001C, charity = MLB001D, educourse = MLB001E, club = MLB001F, organizations = MLB001G,
    pray = MLB001H, book = MLB001I, tv = MLB001J, puzzles = MLB001K, cards = MLB001L, writing = MLB001M, computer = MLB001N, 
    gardening = MLB001O, bake = MLB001P, clothes = MLB001Q, hobby = MLB001R, sports = MLB001S, walk = MLB001T,
    
      # Q4. – Q18. Social Network / Social Integration / Relationship Quality / Social Support
    partnerlb = MLB004, childlb = MLB007, siblb = MLB011, friendlb = MLB015, # Composition of Social Network
    cpartner = MLB006, cchild = MLB010, csib = MLB014, cfriend = MLB018, # Number of Close Social Relationships
        # Contact with Social Network
    chldmeet = MLB009A, chldphone = MLB009B, chldemail = MLB009C, 
    sibmeet = MLB013A, sibphone = MLB013B, sibemail = MLB013C,
    friendmeet = MLB017A, friendphone = MLB017B, friendemail = MLB017C,
        # Perceived Social Support (Relationship Quality)
    sustdfe = MLB005A, srely = MLB005B, sopenup = MLB005C, sdemand = MLB005D, scritze = MLB005E, sletdow = MLB005F, sgetnev = MLB005G, 
    kustdfe = MLB008A, krely = MLB008B, kopenup = MLB008C, kdemand = MLB008D, kcritze = MLB008E, kletdow = MLB008F, kgetnev = MLB008G,
    oustdfe = MLB012A, orely = MLB012B, oopenup = MLB012C, odemand = MLB012D, ocritze = MLB012E, oletdow = MLB012F, ogetnev = MLB012G, 
    fustdfe = MLB016A, frely = MLB016B, fopenup = MLB016C, fdemand = MLB016D, fcritze = MLB016E, fletdow = MLB016F, fgetnev = MLB016G,
    
    # Adulthood Psychological
      # Q33. The "Big 5" Personality Traits
        # Neuroticism
    moody = MLB033D, worrying = MLB033H, ptnervous = MLB033L, ptcalm = MLB033Q,
        # Extraversion
    outgoing = MLB033A, friendly = MLB033F, lively = MLB033J, ptactive = MLB033U, talkative = MLB033Z_2, 
        # Openness to Experience
    creative = MLB033M, imaginative = MLB033O, intelligent = MLB033S, curious = MLB033T, bminded = MLB033W, sophisticated = MLB033Z_3, 
    adventurous = MLB033Z_4,
        # Agreeableness
    helpful = MLB033B, warm = MLB033G, caring = MLB033K, softhearted = MLB033P, sympathetic = MLB033Y,
        # Conscientiousness
    reckless = MLB033C, organized = MLB033E, responsible = MLB033I, hardwork = MLB033N, disciplined = MLB033R, careless = MLB033V, 
    impulsive = MLB033X,  cautious = MLB033Z, thorough = MLB033Z_5, thrifty = MLB033Z_6,
    
      # Q42. Anger
    kthing = MLB042A, withdraw = MLB042B, irritated = MLB042C, angrier = MLB042D, 
    argothers = MLB042E, strike = MLB042E, nasty = MLB042F, losetemp = MLB042H, quicktemp = MLB042I, fiery = MLB042J, flyoff = MLB042K,
    
      # Q19a - Q19e. Cynical Hostility
    dislike = MLB019A, unfairm = MLB019B, nocares = MLB019C, lie = MLB019D, hidden = MLB019E,
    
      # Q19l - Q19o. Hopelessness
    impossible = MLB019L, hopeless = MLB019M, noexpectwant = MLB019N, nousetry = MLB019O,
    
      # Q20. Loneliness
    complac = MLB020A, leftout = MLB020B, isolate = MLB020C, intune = MLB020D, alone = MLB020E, ppletalk = MLB020F, 
    ppleturn = MLB020G, ppleundrstnd = MLB020H, ppleclose = MLB020I, partfrd = MLB020J, pparoud = MLB020K,
    
      # Q39. Satisfaction with Life Domains and Life-as-a-Whole
    satlivcond = MLB039A, satlivcity = MLB039B, satleisure = MLB039C, satfamlife = MLB039D, satfi = MLB039E, satincome = MLB039F, 
    sathealth = MLB039G, satwhole = MLB039H,
    
      # Q19f - Q19k. Optimism - Pessimism
    gowrong = MLB019F, optimistic = MLB019G, expect = MLB019H, good = MLB019I, noexpect = MLB019J, raregood = MLB019K,
    
      # Q27. Positive and Negative Affect
        # positive affect
    determined = MLB027C, enthusiastic = MLB027D, pnactive = MLB027F, proud = MLB027G, interested = MLB027H, happy = MLB027K, 
    attentive = MLB027P, content = MLB027Q,  inspired = MLB027T, hopeful = MLB027U, alert = MLB027V, pncalm = MLB027X, excited = MLB027Y, 
        # negative affect
    afraid = MLB027A, upset = MLB027B, guilty = MLB027E, scared = MLB027I, frustrated = MLB027J, bored = MLB027L, hostile = MLB027M, 
    jittery = MLB027N, ashamed = MLB027O, pnnervous = MLB027R, sad = MLB027S, distressed = MLB027W,
    
      # Q35. Purpose in Life (Psychological Well-Being – Eudaimonic Well-being)
    plans = MLB035A, trivial = MLB035B, actplan = MLB035C, noaccomplish = MLB035D, doneall = MLB035E, nofuture = MLB035F, direction = MLB035G,
    
      # Q28. Religiosity/Spirituality
    god = MLB028A, divine = MLB028B, religbelief = MLB028C, reglcomfort = MLB028D,
    
      # Q22. - Q23. Personal Sense of Control - Self-Efficacy - Agency - Mastery
        # Perceived Constraints on Personal Control
    helpless = MLB022A, ppdetermine = MLB022B, bydcontrol = MLB022C, littlecontrol = MLB022D, noway = MLB022E,
        # Perceived Mastery
    doanything = MLB023A, succeed = MLB023B, ownhands = MLB023C, selfdepend = MLB023D, dothingswant = MLB023E,
    
      # Q41. Anxiety
    fear = MLB041A, anervous = MLB041B, trembling = MLB041C, feardying = MLB041D, faint = MLB041E,
    
      # Q24 -Q26. Domain Specific Control (Efficacy)
    hlthcontrol = MLB024, soccontrol = MLB025, ficontrol = MLB026,
    
      # Q26a. Perceived Change in Control over Financial Situation in the Last Year
    ficontrol_c = MLB026A,
    
      # Q29. Self-Perceptions of Aging: Subjective Age - Satisfaction with Aging – Attitudes Toward Own Aging
    subjectage = MLB029A,
        # Self-perceptions of Aging (Satisfaction with Aging; Attitudes Toward Own Aging)
    worseold = MLB029B1, samepep = MLB029B2, useless = MLB029B3, happyold = MLB029B4, betterold = MLB029B5, 
    sataging = MLB029B6, stoplike = MLB029B7, bringunlike = MLB029B8,
    
      # Q32. Social Effort/ Reward Balance
    satbalance = MLB032A, appreciation = MLB032B, satrewards = MLB032C,
    
      # Q43- Q44. Subjective Social Status – Cantril Ladder
    socladder = MLB043, socladderchange = MLB044, 
    
    # Adulthood Adverse Experiences
      # Q37a. Lifetime Traumas
    chdeathe = MLB037A, nadise = MLB037B, combate = MLB037C, drugcse = MLB037D, attacke = MLB037E, lifethe = MLB037F, lifethcse = MLB037G, 
    
      # Q30 – Q31. Perceived Everyday Discrimination
    lsrspct = MLB030A, prsrvc = MLB030B, notsmrt = MLB030C, actafd = MLB030D, harass = MLB030E, prtrmt = MLB030F,
    
      # Q36. Major Experiences of Lifetime Discrimination
    ufdis = MLB036A, ufhire = MLB036B, ufdenyp = MLB036C, ufpvmov = MLB036D, ufdenyb = MLB036E, ufpolic = MLB036F, ufdenyh = MLB036G,
    
      # Q40a. Ongoing Chronic Stressors
    oghealth = MLB040A_A, ogphymen = MLB040A_B, ogdrug = MLB040A_C, ogwork = MLB040A_D, ogfis = MLB040A_E, oghouse = MLB040A_F, 
    ogclose = MLB040A_G, oghelp = MLB040A_H, 
    
      # Q38. Stressful Life Events
    lostjob = MLB038A, unemployed = MLB038B, hshdunemployed = MLB038C, worseresid = MLB038D, robbed = MLB038E, fraud = MLB038F
  )

# 2012 -------------------------------------------------------------------------
hrs_lbq_w11 <- read_dta(str_c(getwd(), "/data/raw/hrs/H12LB_R.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhidpn = as.numeric(str_c(HHID, PN)), wave = 2012, 
    lbelig = NLBELIG, lbcomp = NLBCOMP, # 13142 without completing LBQ (7412 with)
    
    # Childhood Adverse Experiences
      # Q37c. Lifetime Traumas before the Age of 18
    mischlth = NLB037K, trbpolic = NLB037L, padrug = NLB037M, pabused = NLB037N, 
    
    # Childhood Social Connections
       # Q32a. Quality of Relationships with Parents Early in Life
    momgrela = NLB032D, dadgrela = NLB032E,
    
      # Q37b. Quality of Relationship with Mother Early in Life
    momeft = NLB037I, momatt = NLB037H, momteach = NLB037J,
    
    # Adulthood Socioeconomic
      # Q21. Neighborhood Disorder/Neighborhood Social Cohesion
        # Neighborhood Social Cohesion
    nobelong = NLB021A, notrusted = NLB021C, unfriend = NLB021E, nohelp = NLB021G, 
        # Neighborhood Physical Disorder
    vandal = NLB021B, afwalk = NLB021D, rubbish = NLB021F, vacant = NLB021H, 
    
      # Q40. Experience of Financial Strain
    diff2pay = NLB040, 
    
    # Adulthood Social Connections
      # Q1. Social Participation - Social Engagement
    care = NLB001A, playwthchld = NLB001B, volunteer = NLB001C, charity = NLB001D, educourse = NLB001E, club = NLB001F, organizations = NLB001G,
    pray = NLB001H,  book = NLB001I, tv = NLB001J, puzzles = NLB001K, cards = NLB001L, writing = NLB001M, computer = NLB001N, 
    gardening = NLB001O, bake = NLB001P, clothes = NLB001Q, hobby = NLB001R, sports = NLB001S, walk = NLB001T,
    
      # Q4. – Q18. Social Network / Social Integration / Relationship Quality / Social Support
    partnerlb = NLB004, childlb = NLB007, siblb = NLB011, friendlb = NLB015, # Composition of Social Network
    cpartner = NLB006, cchild = NLB010, csib = NLB014, cfriend = NLB018, # Number of Close Social Relationships
        # Contact with Social Network
    chldmeet = NLB009A, chldphone = NLB009B, chldemail = NLB009C, 
    sibmeet = NLB013A, sibphone = NLB013B, sibemail = NLB013C,
    friendmeet = NLB017A, friendphone = NLB017B, friendemail = NLB017C,
        # Perceived Social Support (Relationship Quality)
    sustdfe = NLB005A, srely = NLB005B, sopenup = NLB005C, sdemand = NLB005D, scritze = NLB005E, sletdow = NLB005F, sgetnev = NLB005G, 
    kustdfe = NLB008A, krely = NLB008B, kopenup = NLB008C, kdemand = NLB008D, kcritze = NLB008E, kletdow = NLB008F, kgetnev = NLB008G,
    oustdfe = NLB012A, orely = NLB012B, oopenup = NLB012C, odemand = NLB012D, ocritze = NLB012E, oletdow = NLB012F, ogetnev = NLB012G, 
    fustdfe = NLB016A, frely = NLB016B, fopenup = NLB016C, fdemand = NLB016D, fcritze = NLB016E, fletdow = NLB016F, fgetnev = NLB016G,
    
    # Adulthood Psychological
      # Q33. The "Big 5" Personality Traits
        # Neuroticism
    moody = NLB033D, worrying = NLB033H, ptnervous = NLB033L, ptcalm = NLB033Q,
        # Extraversion
    outgoing = NLB033A, friendly = NLB033F, lively = NLB033J, ptactive = NLB033U, talkative = NLB033Z_2, 
        # Openness to Experience
    creative = NLB033M, imaginative = NLB033O, intelligent = NLB033S, curious = NLB033T, bminded = NLB033W, sophisticated = NLB033Z_3, 
    adventurous = NLB033Z_4,
        # Agreeableness
    helpful = NLB033B, warm = NLB033G, caring = NLB033K, softhearted = NLB033P, sympathetic = NLB033Y,
        # Conscientiousness
    reckless = NLB033C, organized = NLB033E, responsible = NLB033I, hardwork = NLB033N, disciplined = NLB033R, careless = NLB033V, 
    impulsive = NLB033X,  cautious = NLB033Z, thorough = NLB033Z_5, thrifty = NLB033Z_6,
    
      # Q42. Anger
    kthing = NLB042A, withdraw = NLB042B, irritated = NLB042C, angrier = NLB042D, 
    argothers = NLB042E, strike = NLB042E, nasty = NLB042F, losetemp = NLB042H, quicktemp = NLB042I, fiery = NLB042J, flyoff = NLB042K,
    
      # Q19a - Q19e. Cynical Hostility
    dislike = NLB019A, unfairm = NLB019B, nocares = NLB019C, lie = NLB019D, hidden = NLB019E,
    
      # Q19l - Q19o. Hopelessness
    impossible = NLB019L, hopeless = NLB019M, noexpectwant = NLB019N, nousetry = NLB019O,
    
      # Q20. Loneliness
    complac = NLB020A, leftout = NLB020B, isolate = NLB020C, intune = NLB020D, alone = NLB020E, ppletalk = NLB020F, 
    ppleturn = NLB020G, ppleundrstnd = NLB020H, ppleclose = NLB020I, partfrd = NLB020J, pparoud = NLB020K,
    
      # Q39. Satisfaction with Life Domains and Life-as-a-Whole
    satlivcond = NLB039A, satlivcity = NLB039B, satleisure = NLB039C, satfamlife = NLB039D, satfi = NLB039E, satincome = NLB039F, 
    sathealth = NLB039G, satwhole = NLB039H,
    
      # Q19f - Q19k. Optimism - Pessimism
    gowrong = NLB019F, optimistic = NLB019G, expect = NLB019H, good = NLB019I, noexpect = NLB019J, raregood = NLB019K,
    
      # Q27. Positive and Negative Affect
        # positive affect
    determined = NLB027C, enthusiastic = NLB027D, pnactive = NLB027F, proud = NLB027G, interested = NLB027H, happy = NLB027K, 
    attentive = NLB027P, content = NLB027Q,  inspired = NLB027T, hopeful = NLB027U, alert = NLB027V, pncalm = NLB027X, excited = NLB027Y, 
        # negative affect
    afraid = NLB027A, upset = NLB027B, guilty = NLB027E, scared = NLB027I, frustrated = NLB027J, bored = NLB027L, hostile = NLB027M, 
    jittery = NLB027N, ashamed = NLB027O, pnnervous = NLB027R, sad = NLB027S,distressed = NLB027W,
    
      # Q35. Purpose in Life (Psychological Well-Being – Eudaimonic Well-being)
    plans = NLB035A, trivial = NLB035B, actplan = NLB035C, noaccomplish = NLB035D, doneall = NLB035E, nofuture = NLB035F, direction = NLB035G,
    
      # Q28. Religiosity/Spirituality
    god = NLB028A, divine = NLB028B, religbelief = NLB028C, reglcomfort = NLB028D,
    
      # Q22. - Q23. Personal Sense of Control - Self-Efficacy - Agency - Mastery
        # Perceived Constraints on Personal Control
    helpless = NLB022A, ppdetermine = NLB022B, bydcontrol = NLB022C, littlecontrol = NLB022D, noway = NLB022E,
        # Perceived Mastery
    doanything = NLB023A, succeed = NLB023B, ownhands = NLB023C, selfdepend = NLB023D, dothingswant = NLB023E,
    
      # Q41. Anxiety
    fear = NLB041A, anervous = NLB041B, trembling = NLB041C, feardying = NLB041D, faint = NLB041E,
    
      # Q24 -Q26. Domain Specific Control (Efficacy)
    hlthcontrol = NLB024, soccontrol = NLB025, ficontrol = NLB026,
    
      # Q26a. Perceived Change in Control over Financial Situation in the Last Year
    ficontrol_c = NLB026A,
    
      # Q29. Self-Perceptions of Aging: Subjective Age - Satisfaction with Aging – Attitudes Toward Own Aging
    subjectage = NLB029A,
        # Self-perceptions of Aging (Satisfaction with Aging; Attitudes Toward Own Aging)
    worseold = NLB029B1, samepep = NLB029B2, useless = NLB029B3, happyold = NLB029B4, betterold = NLB029B5, 
    sataging = NLB029B6, stoplike = NLB029B7, bringunlike = NLB029B8,
    
      # Q32. Social Effort/ Reward Balance
    satbalance = NLB032A, appreciation = NLB032B, satrewards = NLB032C,
    
      # Q43- Q44. Subjective Social Status – Cantril Ladder
    socladder = NLB043, socladderchange = NLB044, 
    
    # Adulthood Adverse Experiences
      # Q37a. Lifetime Traumas
    chdeathe = NLB037A, nadise = NLB037B, combate = NLB037C, drugcse = NLB037D, attacke = NLB037E, lifethe = NLB037F, lifethcse = NLB037G, 
    
      # Q30 – Q31. Perceived Everyday Discrimination
    lsrspct = NLB030A, prsrvc = NLB030B, notsmrt = NLB030C, actafd = NLB030D, harass = NLB030E, prtrmt = NLB030F,
    
      # Q36. Major Experiences of Lifetime Discrimination
    ufdis = NLB036A, ufhire = NLB036B, ufdenyp = NLB036C, ufpvmov = NLB036D, ufdenyb = NLB036E, ufpolic = NLB036F, ufdenyh = NLB036G,
    
      # Q40a. Ongoing Chronic Stressors
    oghealth = NLB040A_A, ogphymen = NLB040A_B, ogdrug = NLB040A_C, ogwork = NLB040A_D, ogfis = NLB040A_E, oghouse = NLB040A_F, 
    ogclose = NLB040A_G, oghelp = NLB040A_H, 
    
      # Q38. Stressful Life Events
    lostjob = NLB038A, unemployed = NLB038B, hshdunemployed = NLB038C, worseresid = NLB038D, robbed = NLB038E, fraud = NLB038F
  )

```

### 2015 + 2017 life history

```{r}

hrs_lhms <- read_dta(str_c(getwd(), "/data/raw/hrs/lhms1517a_r.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhidpn = as.numeric(str_c(hhid, pn)), lhms,
    orphanage = LH2A, fosterhome = LH2B, boarding = LH2C, padivch = LH2D, padiech = LH2E, sepmom = LH2G, sepdad = LH2H,
    jail = LH4A, longhospital = LH4B, combatzone = LH4C, military = LH4D, homeless = LH4E,
    vact1829 = LH58A, vact3039 = LH58B, vact4049 = LH58C, mact1829 = LH59A, mact3039 = LH59B, mact4049 = LH59C
    )

```

### Cross-Wave Childhood Health And Family Aggregated Data

```{r}

hrs_child <- read_dta(str_c(getwd(), "/data/raw/hrs/AGGCHLDFH2016A_R.dta", sep = "")) %>%
  mutate(
    .keep = "none",
    hhidpn = as.numeric(str_c(HHID, PN)),
    FAMFIN, MOVFIN, FMFINH, FAUNEM, FJOB, FAEDUC, MOEDUC, RELWMO, RELWFA, ATTENMO, EFFMO, TEACHMO, SCHLOVER, TRPOLICE, DRKDRUG, PHYABUSE,
    RTHLTHCH, CHMISSCH, MEASLE, MUMP, CPOX, DIFFSEE, PARSMOKE, ASTHMA, DIABETES, RESP, SPEECH, ALLERGY, HEART, EAR, 
    EPILEPSY, MIGRAIN, STOMACH, HIGHBP, DEPRESS, DRUG, OTPSY, CHHEADINJ, CHDISABL, CHSMOKE, CHLEARN, CHOTHCON
    ) %>%
  rename_with(tolower)

```

## Variable definition + Exclusion

```{r}

long_hrs <- bind_cols(long_rand_hrs, long_harm_hrs) %>% 
  dplyr::select(-c(hhid, pn, hhidpn, agem_e, agey_e)) %>%
  rename_with(tolower) %>%
  left_join(hrs_lhms, by = c("hhidpn")) %>%
  left_join(hrs_child, by = c("hhidpn"))

long_core <- bind_rows(hrs_core_w10, hrs_core_w11, hrs_core_w12, hrs_core_w13)
rm(hrs_core_w10, hrs_core_w11, hrs_core_w12, hrs_core_w13)

long_lbq <- bind_rows(hrs_lbq_w10, hrs_lbq_w11)
rm(hrs_lbq_w10, hrs_lbq_w11)

############### Exclusion ############### 
# The number of participants completing LBQ in 2010 / 2012 is 8332 / 7397
id_2010 <- long_lbq %>%
  filter(wave == 2010 & lbcomp %in% c(1:4)) %>%
  pull(hhidpn)

id_2012 <- long_lbq %>%
  filter(wave == 2012 & lbcomp %in% c(1:4) & !hhidpn %in% id_2010) %>% # Exclude overlapping participants with 2010
  pull(hhidpn)

# The number of participants aged >=50 years in 2010 / 2012 is 7923 / 7146
id_50plus_2010 <- long_hrs %>%
  filter(hhidpn %in% id_2010 & wave == 2010 & agey_e >= 51) %>%
  pull(hhidpn)

id_50plus_2012 <- long_hrs %>%
  filter(hhidpn %in% id_2012 & wave == 2012 & agey_e >= 51) %>%
  pull(hhidpn)

# The number of participants in 2010 / 2012 and with 4-year follow-up is 6666 / 5762
id_4year_2010 <- long_hrs %>%
  filter(hhidpn %in% id_50plus_2010 & wave == 2014) %>%
  pull(hhidpn)

id_4year_2012 <- long_hrs %>%
  filter(hhidpn %in% id_50plus_2012 & wave == 2016) %>%
  pull(hhidpn)

# The number of participants completing LHMS (2015 + 2017) is 11761
id_lhms <- hrs_lhms$hhidpn

# The number of participants included (i.e., completing both LBQ (2010 / 2012), LHMS (2015 + 2017), and with 4-year follow-up is 9148

id_include_2010 <- intersect(id_4year_2010, id_lhms) # 4689
id_include_2012 <- intersect(id_4year_2012, id_lhms) # 4459
id_include <- c(id_include_2010, id_include_2012) # 9148


############### Healthcare variables for 2010 cohort + Sleep problems for 2012 cohort ###############
# Impute healthcare variables for 2010 cohort using information in 2012
tidy_healthcare <- long_core %>%
  filter((hhidpn %in% id_include_2010 & wave == 2012) | (hhidpn %in% id_include_2012 & wave == 2012)) %>%
  mutate(
    .keep = "none",
    hhidpn, caresat, usualcare,
    wave = case_when(
      hhidpn %in% id_include_2010 ~ 2010,
      hhidpn %in% id_include_2012 ~ 2012,
      TRUE ~ NA_real_
    )
  )

# Impute sleep problems for 2010 cohort using information in 2010
tidy_sleep <- long_hrs %>%
  filter((hhidpn %in% id_include_2010 & wave == 2010) | (hhidpn %in% id_include_2012 & wave == 2010)) %>%
  mutate(
    .keep = "none",
    hhidpn, fallslp, wakent, wakeup, rested,
    wave = case_when(
      hhidpn %in% id_include_2010 ~ 2010,
      hhidpn %in% id_include_2012 ~ 2012,
      TRUE ~ NA_real_
    )
  )

############### Define variables ###############
long_core <- long_core %>%
  dplyr::select(!c(caresat, usualcare)) %>%
  left_join(tidy_healthcare, by = c("hhidpn", "wave"))

long_hrs <- long_hrs %>%
  dplyr::select(!c(fallslp, wakent, wakeup, rested)) %>%
  left_join(tidy_sleep, by = c("hhidpn", "wave"))


tidy_hrs <- long_hrs %>%
  filter((hhidpn %in% id_include_2010 & wave == 2010) | (hhidpn %in% id_include_2012 & wave == 2012)) %>%
  left_join(long_lbq, by = c("hhidpn", "wave")) %>%
  left_join(
    long_core %>% dplyr::select(!c(hhid, subhh)), 
    by = c("hhidpn", "wave")) %>%
  mutate( # Defining variables
    .keep = "none",
    # Basic information---
    id = hhidpn, cohort = "hrs", country = 840, wave, 
    iwy = iwendy, iwm = iwendm, lhms,
    # Demographics---
    age = agey_e, rahispan, 
    male = ifelse(ragender == 2, "female", "male"), male = relevel(factor(male), ref = "female"),
    raracem = case_when(
      raracem == 1 ~ "white",
      raracem == 2 ~ "black",
      raracem == 3 ~ "other",
      TRUE ~ NA_character_
    ),
    raracem = relevel(factor(raracem), ref = "white"),
    foreignborn = case_when(
      rabplace %in% c(1:10) ~ "no",
      rabplace == 11 ~ "yes",
      TRUE ~ NA_character_
    ),
    foreignborn = relevel(factor(foreignborn), ref = "no"),
    
    # Childhood Adverse Experiences---
    famfin = case_when( # lower family ses
      famfin == 1 ~ 1,
      famfin == 3 ~ 2,
      famfin == 5 ~ 3,
      TRUE ~ NA_real_
    ),
    movfin, fmfinh, rameduc, rafeduc, # ramomeducl, radadeducl,
    faunem = case_when(
      faunem == 1 ~ "yes",
      faunem == 5 ~ "no",
      faunem == 6 ~ "never_work",
      faunem == 7 ~ "not_alive",
      TRUE ~ NA_character_
    ),
    faunem = relevel(factor(faunem), ref = "no"),
    radadoccup = case_when(
      radadoccup == 1 ~ "whitecollar",
      radadoccup == 2 ~ "bluecollar",
      radadoccup == 3 ~ "military",
      TRUE ~ NA_character_
    ),
    radadoccup = relevel(factor(radadoccup), ref = "whitecollar"),
    schlover, trpolice, drkdrug, phyabuse, 
    orphanage, fosterhome, padivch, padiech, sepmom, sepdad,
    
    # Socioeconomic status---
    raeduc, raedyrs, atotb, atotw, atotn, itot, 
    atotw_tile = ntile(atotw, n = 20), itot_tile = ntile(itot, n = 20),
    lbrf = case_when(
      lbrf %in% c(1, 2) ~ "employed",
      lbrf %in% c(4, 5) ~ "retired",
      lbrf %in% c(3, 6, 7) ~ "others",
      TRUE ~ NA_character_
    ), 
    lbrf = relevel(factor(lbrf), ref = "employed"),
    socladder, # higher status
    
    # Material circumstances
    rural, nnsafety = ifelse(nnsafety %in% c(8, 9), NA, nnsafety), # poorer safety
    cenreg = case_when(
      cenreg == 1 ~ "Northeast",
      cenreg == 2 ~ "Midwest",
      cenreg == 3 ~ "South",
      cenreg == 4 ~ "West",
      # cenreg == 5 ~ "Other",
      TRUE ~ NA_character_
    ),
    cenreg = relevel(factor(cenreg), ref = "South"),
    homeown = ifelse(homeown == 1, 1, 0),
    hometype = case_when(
      hometype == 1 ~ "mobilehome",
      hometype == 2 ~ "onefamily",
      hometype == 3 ~ "twofamily",
      hometype == 4 ~ "apartment",
      hometype %in% c(10:13) ~ "other",
      TRUE ~ NA_character_
    ),
    hometype = relevel(factor(hometype), ref = "twofamily"),
    efoodstamp, 
    enoughfood = case_when(
      enoughfood == 1 ~ "no",
      enoughfood == 5 ~ "yes",
      TRUE ~ NA_character_
    ),
    enoughfood = relevel(factor(enoughfood), ref = "no"),
    
    # Psychosocial circumstances---
    mstat = case_when(
      mstat %in% c(1:3) ~ "married",
      mstat %in% c(4:6) ~ "separated",
      mstat == 7 ~ "widowed",
      mstat == 8 ~ "never",
      TRUE ~ NA_character_
      ),
    mstat = relevel(factor(mstat), ref = "married"),
    hhres, lvalone, momliv, dadliv, child, livsib,
    partnerlb, childlb, siblb, friendlb,
    cchild = ifelse(cchild %in% c(0:30), cchild, NA), 
    csib = ifelse(csib %in% c(0:30), csib, NA), 
    cfriend = ifelse(cfriend %in% c(0:30), cfriend, NA),
    chldmeet, chldphone, chldemail, # higher frequency
    sibmeet, sibphone, sibemail,
    friendmeet, friendphone, friendemail,
    sustdfe, srely, sopenup, sdemand, scritze, sletdow, sgetnev, # higher positive/negative support
    kustdfe, krely, kopenup, kdemand, kcritze, kletdow, kgetnev,
    oustdfe, orely, oopenup, odemand, ocritze, oletdow, ogetnev, 
    fustdfe, frely, fopenup, fdemand, fcritze, fletdow, fgetnev,
    care, playwthchld, volunteer, charity, educourse, club, organizations, socrelg_h, # lower frequency
    pray, book, tv, puzzles, cards, writing, computer, gardening, bake, clothes, 
    hobby, sports, walk,
    nobelong, notrusted, unfriend, nohelp, vandal, afwalk, rubbish, vacant, 
    lsrspct, prsrvc, notsmrt, actafd, harass, prtrmt, # Everyday discrimination (yes/no)
    complac, leftout, isolate, # loneliness
    ufdis, ufhire, ufdenyp, ufpvmov, ufdenyb, ufpolic, ufdenyh, # Lifetime discrimination (yes/no)
    oghealth, ogphymen, ogdrug, ogwork, ogfis, oghouse, ogclose, oghelp, # Ongoing stress (more stresses)
    lostjob, unemployed, hshdunemployed, worseresid, robbed, fraud, # Stressful life events (yes/no)
    jail, longhospital, combatzone, military, homeless, 
    chdeathe, nadise, combate, drugcse, attacke, lifethe, lifethcse, # Lifetime trauma (yes/no)
    fear, anervous, trembling, feardying, faint,
    
    # Healthcare systems---
    higov, govmr, govmd, govva, prpcnt, hipriv = ifelse(prpcnt >= 1, 1, 0), covr, hiltc, lifein, oopmd,
    insurance = case_when(
      higov == 1 & hipriv == 1 ~ 2,
      higov == 1 & hipriv == 0 ~ 1,
      higov == 0 & hipriv == 0 ~ 0,
      TRUE ~ 3
    ),
    caresat = ifelse(caresat %in% c(8:9), NA, caresat), # less satisfication
    usualcare = ifelse(usualcare %in% c(7), 1, usualcare),
    hosp, hsptim, hspnit, doctor, outpt, doctim, nrshom, homcar, nrstim, dentst,
    
    # Health Behaviors---
    smokev, smoken, smokef, drink, drinkd, drinkn, drinkdn = drinkd*drinkn,
    vgactx, mdactx, ltactx, # lower frequency
    bmi,
    obesity = case_when(
      bmicat %in% c(4:6) ~ 1,
      bmicat %in% c(1:3) ~ 0,
      TRUE ~ NA_real_
      ),
    fallslp, wakent, wakeup, rested
  ) %>%
  arrange(id, wave)

rm(
  long_rand_hrs, long_harm_hrs, hrs_lhms, hrs_child, hrs_epiclock,
  id_2010, id_2012, id_50plus_2010, id_50plus_2012, id_4year_2010, id_4year_2012, id_lhms
  )


############### Frailty index ############### 
# Baseline
tidy_fi_baseline <- long_hrs %>%
  filter((hhidpn %in% id_include_2010 & wave == 2010) | (hhidpn %in% id_include_2012 & wave == 2012)) %>%
  mutate(
    .keep = "none",
    id = hhidpn, wave,
    # Disease
    hibpe, diabe, cancre, lunge, hearte, stroke, arthre, psyche, 
    memrye = case_when(
      memrye >= 1 ~ 1,
      memrye == 0 ~ 0,
      TRUE ~ NA_real_
      ),
      # Physical function
    dressa, batha, eata, beda, toilta, walkra, # ADLs 
    moneya, medsa, shopa, mealsa, phonea, mapa, # IADLs
    walksa, walk1a, sita, chaira, climsa, clim1a, stoopa, lifta, dimea, armsa, pusha, # Mobility limitations
      # Self-reported health
    prshlt = case_when(
      shlt == 5 ~ 1,
      shlt == 4 ~ 0.75,
      shlt == 3 ~ 0.5,
      shlt == 2 ~ 0.25,
      shlt == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    dvi = case_when(
      dsight %in% c(5:6) ~ 1,
      dsight == 4 ~ 0.75,
      dsight == 3 ~ 0.5,
      dsight == 2 ~ 0.25,
      dsight == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    nvi = case_when(
      nsight %in% c(5:6) ~ 1,
      nsight == 4 ~ 0.75,
      nsight == 3 ~ 0.5,
      nsight == 2 ~ 0.25,
      nsight == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    hi = case_when(
      hearing %in% c(5:6) ~ 1,
      hearing == 4 ~ 0.75,
      hearing == 3 ~ 0.5,
      hearing == 2 ~ 0.25,
      hearing == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    pain = painfr, urinai, 
      # Depressive symptoms
    depres, effort, whappy = 1-whappy, fsad, going, enlife = 1-enlife,
      # Cognition
    imrc, dlrc, ser7
    ) %>%
  remove_all_labels() %>%
  zap_formats()

# Check completeness of data
a <- tidy_fi_baseline %>%
  mutate(perc_na = apply(., 1, count_na_row) / (ncol(.) - 2))
print(
  round(nrow(a %>% filter(perc_na == 0))*100 / nrow(a), 1)
  )
rm(a)

# Impute missing data
tic()
tidy_fi_baseline_imp <- missRanger(tidy_fi_baseline, . ~ . - id - wave, pmm.k = 5, maxiter = 10, num.trees = 100, returnOOB = T, verbose = 1, seed = 12345)  %>%
  rowwise() %>% 
  mutate(
    disease = sum(c(hibpe, diabe, cancre, lunge, hearte, stroke, arthre, psyche, memrye), na.rm = F), # 9
    adl = sum(c(dressa, batha, eata, beda, toilta, walkra), na.rm = F), # 6
    iadl = sum(c(moneya, medsa, shopa, mealsa, phonea, mapa), na.rm = F), # 6
    moblimit = sum(c(walksa, walk1a, sita, chaira, climsa, clim1a, stoopa, lifta, dimea, armsa, pusha), na.rm = T), # 11
    depres, effort, whappy, fsad, going, enlife, # 6
    cognition = 1 - sum(c(imrc, dlrc, ser7), na.rm = F)/25, # 1
    fi = sum(c(disease, adl, iadl, moblimit, prshlt, dvi, nvi, hi, pain, urinai, depres, effort, whappy, fsad, going, enlife, cognition), na.rm = F)/45
  ) %>%
  ungroup() %>%
  dplyr::select(c(id, wave), !c(id, wave))
toc() # 10 s

colnames(tidy_fi_baseline_imp)[-c(1:2)] <- str_c(colnames(tidy_fi_baseline_imp)[-c(1:2)], "_b")

# Follow-up
tidy_fi_follow <- long_hrs %>%
  filter((hhidpn %in% id_include_2010 & wave == 2014) | (hhidpn %in% id_include_2012 & wave == 2016)) %>%
  mutate(
    .keep = "none",
    id = hhidpn, wave,
    # Disease
    hibpe, diabe, cancre, lunge, hearte, stroke, arthre, psyche, 
    memrye = case_when(
      memrye >= 1 ~ 1,
      memrye == 0 ~ 0,
      TRUE ~ NA_real_
      ),
      # Physical function
    dressa, batha, eata, beda, toilta, walkra, # ADLs 
    moneya, medsa, shopa, mealsa, phonea, mapa, # IADLs
    walksa, walk1a, sita, chaira, climsa, clim1a, stoopa, lifta, dimea, armsa, pusha, # Mobility limitations
      # Self-reported health
    prshlt = case_when(
      shlt == 5 ~ 1,
      shlt == 4 ~ 0.75,
      shlt == 3 ~ 0.5,
      shlt == 2 ~ 0.25,
      shlt == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    dvi = case_when(
      dsight %in% c(5:6) ~ 1,
      dsight == 4 ~ 0.75,
      dsight == 3 ~ 0.5,
      dsight == 2 ~ 0.25,
      dsight == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    nvi = case_when(
      nsight %in% c(5:6) ~ 1,
      nsight == 4 ~ 0.75,
      nsight == 3 ~ 0.5,
      nsight == 2 ~ 0.25,
      nsight == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    hi = case_when(
      hearing %in% c(5:6) ~ 1,
      hearing == 4 ~ 0.75,
      hearing == 3 ~ 0.5,
      hearing == 2 ~ 0.25,
      hearing == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    pain = painfr, urinai, 
      # Depressive symptoms
    depres, effort, whappy = 1-whappy, fsad, going, enlife = 1-enlife,
      # Cognition
    imrc, dlrc, ser7
    ) %>%
  remove_all_labels() %>%
  zap_formats()

# Check completeness of data
a <- tidy_fi_follow %>%
  mutate(perc_na = apply(., 1, count_na_row) / (ncol(.) - 2))
print(
  round(nrow(a %>% filter(perc_na == 0))*100 / nrow(a), 1)
  )
rm(a)

# Impute missing data
tic()
tidy_fi_follow_imp <- missRanger(tidy_fi_follow, . ~ . - id - wave, pmm.k = 5, maxiter = 10, num.trees = 100, returnOOB = T, verbose = 1, seed = 12345)  %>%
  rowwise() %>% 
  mutate(
    disease = sum(c(hibpe, diabe, cancre, lunge, hearte, stroke, arthre, psyche, memrye), na.rm = F),
    adl = sum(c(dressa, batha, eata, beda, toilta, walkra), na.rm = F),
    iadl = sum(c(moneya, medsa, shopa, mealsa, phonea, mapa), na.rm = F),
    moblimit = sum(c(walksa, walk1a, sita, chaira, climsa, clim1a, stoopa, lifta, dimea, armsa, pusha), na.rm = T),
    depres, effort, whappy, fsad, going, enlife, # 6
    cognition = 1 - sum(c(imrc, dlrc, ser7), na.rm = F)/25, # 1
    fi = sum(c(disease, adl, iadl, moblimit, prshlt, dvi, nvi, hi, pain, urinai, depres, effort, whappy, fsad, going, enlife, cognition), na.rm = F)/45
  ) %>%
  ungroup() %>%
  dplyr::select(c(id, wave), !c(id, wave))
toc() # 10 s


############### Relevel some variables ############### 
# For categorical variables coding as 1-yes and 5-no
cate_var_fac_relevel <- c("schlover", "trpolice", "drkdrug", "phyabuse", "orphanage", "fosterhome", "padivch", "padiech", "sepmom", "sepdad", "chdeathe", "nadise", "combate", "drugcse", "attacke", "lifethe", "lifethcse", "ufdis", "ufhire", "ufdenyp", "ufpvmov", "ufdenyb", "ufpolic", "ufdenyh", "lostjob", "unemployed", "hshdunemployed", "worseresid", "robbed", "fraud", "jail", "longhospital", "combatzone", "military", "homeless")

# For categorical variables coding as 1-yes, 5-no, and 8/9-missing
cate_var_fac_relevel2 <- c("efoodstamp", "movfin", "fmfinh", "usualcare")

# For categorical variables coding as 1-yes and 0-no
cate_var_fac_relevel3 <- c("rural", "homeown", "lvalone", "higov", "govmr", "govmd", "govva", "hipriv", "covr", "hiltc", "lifein", "smokev", "smoken", "drink", "obesity", "momliv", "dadliv", "rahispan")

tidy_relevel <- tidy_hrs %>%
  mutate_at(c(cate_var_fac_relevel), fac_relevel) %>%
  mutate_at(c(cate_var_fac_relevel2), fac_relevel2) %>%
  mutate_at(c(cate_var_fac_relevel3), fac_relevel3)

############### Reverse-code and Define variables ############### 
var_reverse <- c(
  # Psychosocial circumstances
  "chldmeet", "chldphone", "chldemail", 
  "sibmeet", "sibphone", "sibemail",
  "friendmeet", "friendphone", "friendemail",
  "sustdfe", "srely", "sopenup", "sdemand", "scritze", "sletdow", "sgetnev",
  "kustdfe", "krely", "kopenup", "kdemand", "kcritze", "kletdow", "kgetnev",
  "oustdfe", "orely", "oopenup", "odemand", "ocritze", "oletdow", "ogetnev", 
  "fustdfe", "frely", "fopenup", "fdemand", "fcritze", "fletdow", "fgetnev",
  "care", "playwthchld", "volunteer", "charity", "educourse", "club", "organizations", "socrelg_h",
  "pray", "book", "tv", "puzzles", "cards", "writing", "computer", "gardening", "bake", "clothes",
  "hobby", "sports", "walk",
  "nobelong", "notrusted", "unfriend", "nohelp",
  # Health Behaviors
  "fallslp", "wakent", "wakeup", "vgactx", "mdactx", "ltactx",
  # Adverse Experiences
  "complac", "leftout", "isolate", 
  "lsrspct", "prsrvc", "notsmrt", "actafd", "harass", "prtrmt"
  )

tidy_reverse <- tidy_relevel %>%
  mutate_at(c(var_reverse), reverse_code) %>% 
  mutate(
    .keep = "unused",
    # Adulthood Socioeconomic
    nnphysical = rowMeans(.[c("vandal", "afwalk", "rubbish", "vacant")], na.rm = T),
    nnphysical = ifelse(apply(.[c("vandal", "afwalk", "rubbish", "vacant")], 1, count_na_row) > 1, NA, nnphysical), # higher score - poorer health
    
    nnsocial = rowMeans(.[c("nobelong", "notrusted", "unfriend", "nohelp")], na.rm = T),
    nnsocial = ifelse(apply(.[c("nobelong", "notrusted", "unfriend", "nohelp")], 1, count_na_row) > 1, NA, nnsocial), # higher score - better health
    
    # Adulthood Health Behaviors
    sleep = rowMeans(.[c("fallslp", "wakent", "wakeup", "rested")], na.rm = T),
    sleep = ifelse(apply(.[c("fallslp", "wakent", "wakeup", "rested")], 1, count_na_row) > 2, NA, sleep),
    
    # Adulthood Social Connections
    closerela = rowSums(.[c("cchild", "csib", "cfriend")], na.rm = F),
    
    chldcontact = rowMeans(.[c("chldmeet", "chldphone", "chldemail")], na.rm = T),
    chldcontact = ifelse(apply(.[c("chldmeet", "chldphone", "chldemail")], 1, count_na_row) > 1, NA, chldcontact),
    
    sibcontact = rowMeans(.[c("sibmeet", "sibphone", "sibemail")], na.rm = T),
    sibcontact = ifelse(apply(.[c("sibmeet", "sibphone", "sibemail")], 1, count_na_row) > 1, NA, sibcontact),
    
    friendcontact = rowMeans(.[c("friendmeet", "friendphone", "friendemail")], na.rm = T),
    friendcontact = ifelse(apply(.[c("friendmeet", "friendphone", "friendemail")], 1, count_na_row) > 1, NA, friendcontact),
    
    sposupport = rowMeans(.[c("sustdfe", "srely", "sopenup")], na.rm = T),
    sposupport = ifelse(apply(.[c("sustdfe", "srely", "sopenup")], 1, count_na_row) > 1, NA, sposupport),
    
    snegsupport = rowMeans(.[c("sdemand", "scritze", "sletdow", "sgetnev")], na.rm = T),
    snegsupport = ifelse(apply(.[c("sdemand", "scritze", "sletdow", "sgetnev")], 1, count_na_row) > 2, NA, snegsupport),
    
    kposupport = rowMeans(.[c("kustdfe", "krely", "kopenup")], na.rm = T),
    kposupport = ifelse(apply(.[c("kustdfe", "krely", "kopenup")], 1, count_na_row) > 1, NA, kposupport),
    
    knegsupport = rowMeans(.[c("kdemand", "kcritze", "kletdow", "kgetnev")], na.rm = T),
    knegsupport = ifelse(apply(.[c("kdemand", "kcritze", "kletdow", "kgetnev")], 1, count_na_row) > 2, NA, knegsupport),
    
    oposupport = rowMeans(.[c("oustdfe", "orely", "oopenup")], na.rm = T),
    oposupport = ifelse(apply(.[c("oustdfe", "orely", "oopenup")], 1, count_na_row) > 1, NA, oposupport),
    
    onegsupport = rowMeans(.[c("odemand", "ocritze", "oletdow", "ogetnev")], na.rm = T),
    onegsupport = ifelse(apply(.[c("odemand", "ocritze", "oletdow", "ogetnev")], 1, count_na_row) > 2, NA, onegsupport),
    
    fposupport = rowMeans(.[c("fustdfe", "frely", "fopenup")], na.rm = T),
    fposupport = ifelse(apply(.[c("fustdfe", "frely", "fopenup")], 1, count_na_row) > 1, NA, fposupport),
    
    fnegsupport = rowMeans(.[c("fdemand", "fcritze", "fletdow", "fgetnev")], na.rm = T),
    fnegsupport = ifelse(apply(.[c("fdemand", "fcritze", "fletdow", "fgetnev")], 1, count_na_row) > 2, NA, fnegsupport),
    
    anxiety = rowMeans(.[c("fear", "anervous", "trembling", "feardying", "faint")], na.rm = T),
    anxiety = ifelse(apply(.[c("fear", "anervous", "trembling", "feardying", "faint")], 1, count_na_row) > 2, NA, anxiety),
    
    loneliness = rowMeans(.[c("complac", "leftout", "isolate")], na.rm = T),
    loneliness = ifelse(apply(.[c("complac", "leftout", "isolate")], 1, count_na_row) > 1, NA, loneliness),
    
    # Adulthood Adverse Experiences
    pdailydiscrim = rowMeans(.[c("lsrspct", "prsrvc", "notsmrt", "actafd", "harass", "prtrmt")], na.rm = T),
    pdailydiscrim = ifelse(apply(.[c("lsrspct", "prsrvc", "notsmrt", "actafd", "harass", "prtrmt")], 1, count_na_row) > 3, NA, pdailydiscrim)
  )

############### Final datasets ############### 
final <- tidy_reverse %>% 
  left_join(tidy_fi_baseline_imp, by = c("id", "wave")) %>%
  left_join(tidy_fi_follow_imp %>% dplyr::select(-wave), by = c("id")) %>%
  remove_all_labels() %>%
  zap_formats()

```

# Descriptive analyses

## Supplementary Table 1: Descriptive statistics for missing rate of all predictors

### Overall

```{r}

# Select variables
missing_desc <- final %>% 
  filter(fi_b < 0.2) %>%
  dplyr::select(
    age, male, 
    famfin, movfin, fmfinh, rameduc, rafeduc, faunem, radadoccup, 
    schlover, trpolice, drkdrug, phyabuse, 
    orphanage, fosterhome, padivch, padiech, sepmom, sepdad,
    raracem, rahispan, raedyrs, atotb, itot, lbrf, socladder,
    efoodstamp, enoughfood, rural, nnsafety, cenreg, hometype, homeown,
    mstat, hhres, cchild, csib, cfriend, 
    care, playwthchld, volunteer, charity, educourse, club, organizations, pray, book, tv, 
    puzzles, cards, writing, computer, gardening, bake, clothes, hobby, sports, walk, socrelg_h, 
    nnphysical, nnsocial,
    chldcontact, sibcontact, friendcontact, 
    sposupport, kposupport, oposupport, fposupport, 
    snegsupport, knegsupport, onegsupport, fnegsupport, 
    pdailydiscrim, loneliness,
    ufdis, ufhire, ufdenyp, ufpvmov, ufdenyb, ufpolic, ufdenyh,
    chdeathe, nadise, combate, drugcse, attacke, lifethe, lifethcse, 
    oghealth, ogphymen, ogdrug, ogwork, ogfis, oghouse, ogclose, oghelp,
    lostjob, unemployed, hshdunemployed, worseresid, robbed, fraud, 
    jail, longhospital, combatzone, military, homeless,
    smokev, smoken, drink, drinkdn, vgactx, mdactx, ltactx, bmi, sleep,
    higov, hipriv, hiltc, lifein, oopmd, caresat, usualcare) 

# Calculate missing percentages for each variable
missing_perc <- tibble(
  variable = skim(missing_desc)$skim_variable,
  missing_rate = (1 - skim(missing_desc)$complete_rate)*100
)

# Define variable groups
demo <- c("age", "male")
ace <- c(
  "famfin", "rafeduc", "rameduc", "movfin", "fmfinh", "faunem", "radadoccup", 
  "schlover", "trpolice", "drkdrug", "phyabuse", "orphanage", "fosterhome", "padivch", "padiech", "sepmom", "sepdad")
ses <- c("raedyrs", "atotb", "itot", "socladder", "raracem", "rahispan", "lbrf")
mc <- c("efoodstamp", "enoughfood", "homeown", "hometype", "rural", "cenreg", "nnsafety")
socc <- c(
  "mstat", "hhres", "cchild", "csib", "cfriend", 
  "chldcontact", "sibcontact", "friendcontact", 
  "sposupport", "kposupport", "oposupport", "fposupport", "snegsupport", "knegsupport", "onegsupport", "fnegsupport", 
  "care", "playwthchld", "volunteer", "charity", "educourse", "club", "organizations", 
  "pray", "book", "tv", "puzzles", "cards", "writing", "computer", "gardening", "bake", "clothes", 
  "hobby", "sports", "walk", "socrelg_h", "nnphysical", "nnsocial")
stress <- c(
  "pdailydiscrim", "loneliness", 
  "oghealth", "ogphymen", "ogdrug", "ogwork", "ogfis", "oghouse", "ogclose", "oghelp", 
  "ufdis", "ufhire", "ufdenyp", "ufpvmov", "ufdenyb", "ufpolic", "ufdenyh", 
  "chdeathe", "nadise", "combate", "drugcse", "attacke", "lifethe", "lifethcse", 
  "lostjob", "unemployed", "hshdunemployed", "worseresid", "robbed", "fraud", 
  "jail", "longhospital", "combatzone", "military", "homeless")
behav <- c("smokev", "smoken", "drink", "drinkdn", "ltactx", "mdactx", "vgactx", "bmi", "sleep")
hcare <- c("higov", "hipriv", "hiltc", "lifein", "usualcare", "oopmd", "caresat")

# Define the order of variables
var_order <- c(demo, ace, ses, mc, socc, stress, behav, hcare)

# Define variable names
var_name <- c(
  "Age",
  "Sex: male",
  
  "Lower family financial situation",
  "Higher father's education", 
  "Higher mother's education",
  "Relocated due to financial difficulties",
  "Family received financial help",
  "Father unemployed",
  "Father's occupation", 

  "Repeated school",
  "Trouble with police",
  "Parents used drugs or alcohol",
  "Physically abused",
  "Live in an orphanage",
  "Live in a foster home",
  "Parents separated or divorced",
  "Parents died",
  "Separated from mother",
  "Separated from father",
  
  "Higher education",
  "Household wealth",
  "Annual household income",
  "Higher subjective social status",
  "Race",
  "Hispanic", 
  "Labor force status",
  
  "Received food stamps", 
  "Experienced food insecurity",
  "Home ownership",
  "House's type",
  "Live in the rural area",
  "Census region",
  "Neighborhood unsafety", 
  
  "Marital status",
  "Household size",
  "Number of close children",
  "Number of close family members", 
  "Number of close friends",
  "Contact with children",
  "Contact with other family members", 
  "Contact with friends", 
  "Support from spouse", 
  "Strain from spouse",
  "Support from children", 
  "Strain from children", 
  "Support from other family members", 
  "Strain from other family members", 
  "Support from friends",
  "Strain from friends", 
  "Care for a sick adult", 
  "Do activities with grandchildren",
  "Volunteer with children",
  "Do charity work", 
  "Attend an educational course",
  "Go to a sport/social club",
  "Attend meetings of non-religious organizations", 
  "Pray privately",
  "Reading",
  "Watch television",
  "Do word games",
  "Play cards or chess",
  "Writing",
  "Use a computer or email",
  "Maintenance or gardening",
  "Baking or cooking",
  "Knitting",
  "Work on a hobby or project",
  "Play sports or exercise",
  "Walk for ≥20 minutes",
  "Attend religious activities",
  "Neighborhood physical disorder", 
  "Neighborhood social cohesion", 

  "Daily discrimination", 
  "Loneliness",
  "Ongoing health problems", 
  "Ongoing physical/emotional problems", 
  "Ongoing alcohol/drug issues in family member", 
  "Ongoing difficulties at work", 
  "Ongoing financial strain", 
  "Ongoing housing problems", 
  "Ongoing problems in a close relationship",
  "Helping sick family members or friends regularly",
  "Unfairly dismissed from a job",
  "Unfairly not been hired for a job",
  "Unfairly denied a promotion",
  "Unfairly been prevented from moving into a neighborhood",
  "Unfairly denied a bank loan",
  "Unfairly treated by the police",
  "Unfairly denied health care",
  "Experienced the death of a child", 
  "Experienced a natural disaster",
  "Fired a weapon in combat",
  "Partner addicted to drugs/alcohol", 
  "Been a victim of a physical attack",
  "Ever had a life-threatening illness", 
  "Ever had a spouse/child with a life-threatening illness", 
  "Involuntarily lost a job for reasons other than retirement",
  "Unemployed",
  "Anyone else in the household unemployed", 
  "Moved to a worse residence/neighborhood",
  "Robbed/burglarized",
  "Been the victim of fraud",
  "Ever been in a jail",
  "Ever been in long-term hospitalization",
  "Ever lived in a combat zone",
  "Ever lived in military housing",
  "Ever been homeless",
  
  "Ever smoking", 
  "Currently smoking", 
  "Ever drinking any alcohol",
  "Total number of drinks per week", 
  "Light physical activities", 
  "Moderate physical activities", 
  "Vigorous physical activities",
  "Body mass index",
  "Sleep problems", 

  "Government health insurance", 
  "Private health insurance", 
  "Long-term care insurance",
  "Life insurance",
  "Access to routine place for healthcare",
  "Out-of-pocket medical expenditure",
  "Lower healthcare satisfaction"
  )

# Create a list of label formulas for table summary
label_list <- list()
for (i in 1:length(var_name)) {
  formula_str <- paste0(var_order[i], " ~ ", "\"", gsub("'", "'", var_name[i]), "\"")
  label_list[[i]] <- as.formula(formula_str)
}

# Create summary table with detailed configurations
tbl <- missing_desc %>%
  mutate(
    male = relevel(factor(male, labels = c("no", "yes")), ref = "no"),
    raracem = factor(raracem, labels = c("White", "Black", "Other")),
    faunem = factor(faunem, levels = c("yes", "no", "never_work", "not_alive"), labels = c("Yes", "No", "Father never worked/always disabled", "Never lived with father/father was not alive")), 
    radadoccup = factor(radadoccup, labels = c("White collar", "Blue collar", "Military")),
    lbrf = factor(lbrf, levels = c("employed", "retired", "others"), labels = c("Working full-time/part-time", "Partly retired/retired", "Unemployed/disabled/not in the labor force")),
    hometype = factor(hometype, levels = c("mobilehome", "onefamily", "twofamily", "apartment", "other"), labels = c("Mobile home", "One-family house", "Two-family house/duplex", "Apartment/townhouse", "Other")),
    cenreg = factor(cenreg, levels = c("South", "Northeast", "Midwest", "West"), labels = c("South", "Northeast", "Midwest", "West")),
    mstat = factor(mstat, levels = c("married", "separated", "widowed", "never"), labels = c("Married/partnered", "Separated/divorced", "Widowed", "Never married")),
  ) %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = label_list,
    type = list(famfin ~ "continuous", socladder ~ "continuous", nnsafety ~ "continuous", care ~ "continuous", playwthchld ~ "continuous", volunteer ~ "continuous", charity ~ "continuous", educourse ~ "continuous", club ~ "continuous", organizations ~ "continuous", pray ~ "continuous", book ~ "continuous", tv ~ "continuous", puzzles ~ "continuous", cards ~ "continuous", writing ~ "continuous", computer ~ "continuous", gardening ~ "continuous", bake ~ "continuous", clothes ~ "continuous", hobby ~ "continuous", sports ~ "continuous", walk ~ "continuous", socrelg_h ~ "continuous", loneliness ~ "continuous", oghealth ~ "continuous", ogphymen ~ "continuous", ogdrug ~ "continuous", ogwork ~ "continuous", ogfis ~ "continuous", oghouse ~ "continuous", ogclose ~ "continuous", oghelp ~ "continuous", ltactx ~ "continuous", mdactx ~ "continuous", vgactx ~ "continuous", caresat ~ "continuous"),
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1)),
    missing = "no"
    ) %>%
  modify_table_body(
    fun = ~.x %>%
      arrange(factor(variable, levels = var_order)) %>%
      left_join(missing_perc, by = "variable") %>%
      mutate(
        missing_rate = case_when(
          row_type == "label" ~ missing_rate,
          TRUE ~ NA_real_
        )
      )
     ) %>%
  modify_header(
    label = "**Variable**",
    missing_rate = "**Missing rate (%)**"
    ) %>%
  modify_fmt_fun(missing_rate ~ function(x) style_number(x, digits = 1))

tbl %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = "E:/Multiple cohort study/Harmonized Data FIile/HarmonizedSurveyData/social_factors_health/results/Table/Table 1_missing predictors_overall_hrs.docx")

rm(missing_desc, missing_perc, tbl)

```

### By sex

```{r}

# Select variables
missing_desc <- final %>% 
  filter(fi_b < 0.2) %>%
  dplyr::select(
    age, male, 
    famfin, movfin, fmfinh, rameduc, rafeduc, faunem, radadoccup, 
    schlover, trpolice, drkdrug, phyabuse, 
    orphanage, fosterhome, padivch, padiech, sepmom, sepdad,
    raracem, rahispan, raedyrs, atotb, itot, lbrf, socladder,
    efoodstamp, enoughfood, rural, nnsafety, cenreg, hometype, homeown,
    mstat, hhres, cchild, csib, cfriend, 
    care, playwthchld, volunteer, charity, educourse, club, organizations, pray, book, tv, 
    puzzles, cards, writing, computer, gardening, bake, clothes, hobby, sports, walk, socrelg_h, 
    nnphysical, nnsocial,
    chldcontact, sibcontact, friendcontact, 
    sposupport, kposupport, oposupport, fposupport, 
    snegsupport, knegsupport, onegsupport, fnegsupport, 
    pdailydiscrim, loneliness,
    ufdis, ufhire, ufdenyp, ufpvmov, ufdenyb, ufpolic, ufdenyh,
    chdeathe, nadise, combate, drugcse, attacke, lifethe, lifethcse, 
    oghealth, ogphymen, ogdrug, ogwork, ogfis, oghouse, ogclose, oghelp,
    lostjob, unemployed, hshdunemployed, worseresid, robbed, fraud, 
    jail, longhospital, combatzone, military, homeless,
    smokev, smoken, drink, drinkdn, vgactx, mdactx, ltactx, bmi, sleep,
    higov, hipriv, hiltc, lifein, oopmd, caresat, usualcare) 

# Calculate missing percentages for each variable
missing_perc <- tibble(
  variable = skim(missing_desc)$skim_variable,
  missing_rate = (1 - skim(missing_desc)$complete_rate)*100
)

# Define variable groups
demo <- c("age")
ace <- c(
  "famfin", "rafeduc", "rameduc", "movfin", "fmfinh", "faunem", "radadoccup", 
  "schlover", "trpolice", "drkdrug", "phyabuse", "orphanage", "fosterhome", "padivch", "padiech", "sepmom", "sepdad")
ses <- c("raedyrs", "atotb", "itot", "socladder", "raracem", "rahispan", "lbrf")
mc <- c("efoodstamp", "enoughfood", "homeown", "hometype", "rural", "cenreg", "nnsafety")
socc <- c(
  "mstat", "hhres", "cchild", "csib", "cfriend", 
  "chldcontact", "sibcontact", "friendcontact", 
  "sposupport", "kposupport", "oposupport", "fposupport", "snegsupport", "knegsupport", "onegsupport", "fnegsupport", 
  "care", "playwthchld", "volunteer", "charity", "educourse", "club", "organizations", 
  "pray", "book", "tv", "puzzles", "cards", "writing", "computer", "gardening", "bake", "clothes", 
  "hobby", "sports", "walk", "socrelg_h", "nnphysical", "nnsocial")
stress <- c(
  "pdailydiscrim", "loneliness", 
  "oghealth", "ogphymen", "ogdrug", "ogwork", "ogfis", "oghouse", "ogclose", "oghelp", 
  "ufdis", "ufhire", "ufdenyp", "ufpvmov", "ufdenyb", "ufpolic", "ufdenyh", 
  "chdeathe", "nadise", "combate", "drugcse", "attacke", "lifethe", "lifethcse", 
  "lostjob", "unemployed", "hshdunemployed", "worseresid", "robbed", "fraud", 
  "jail", "longhospital", "combatzone", "military", "homeless")
behav <- c("smokev", "smoken", "drink", "drinkdn", "ltactx", "mdactx", "vgactx", "bmi", "sleep")
hcare <- c("higov", "hipriv", "hiltc", "lifein", "usualcare", "oopmd", "caresat")

# Define the order of variables
var_order <- c(demo, ace, ses, mc, socc, stress, behav, hcare)

# Define variable names
var_name <- c(
  "Age",
  
  "Lower family financial situation",
  "Higher father's education", 
  "Higher mother's education",
  "Relocated due to financial difficulties",
  "Family received financial help",
  "Father unemployed",
  "Father's occupation", 

  "Repeated school",
  "Trouble with police",
  "Parents used drugs or alcohol",
  "Physically abused",
  "Live in an orphanage",
  "Live in a foster home",
  "Parents separated or divorced",
  "Parents died",
  "Separated from mother",
  "Separated from father",
  
  "Higher education",
  "Household wealth",
  "Annual household income",
  "Higher subjective social status",
  "Race",
  "Hispanic", 
  "Labor force status",
  
  "Received food stamps", 
  "Experienced food insecurity",
  "Home ownership",
  "House's type",
  "Live in the rural area",
  "Census region",
  "Neighborhood unsafety", 
  
  "Marital status",
  "Household size",
  "Number of close children",
  "Number of close family members", 
  "Number of close friends",
  "Contact with children",
  "Contact with other family members", 
  "Contact with friends", 
  "Support from spouse", 
  "Strain from spouse",
  "Support from children", 
  "Strain from children", 
  "Support from other family members", 
  "Strain from other family members", 
  "Support from friends",
  "Strain from friends", 
  "Care for a sick adult", 
  "Do activities with grandchildren",
  "Volunteer with children",
  "Do charity work", 
  "Attend an educational course",
  "Go to a sport/social club",
  "Attend meetings of non-religious organizations", 
  "Pray privately",
  "Reading",
  "Watch television",
  "Do word games",
  "Play cards or chess",
  "Writing",
  "Use a computer or email",
  "Maintenance or gardening",
  "Baking or cooking",
  "Knitting",
  "Work on a hobby or project",
  "Play sports or exercise",
  "Walk for ≥20 minutes",
  "Attend religious activities",
  "Neighborhood physical disorder", 
  "Neighborhood social cohesion", 

  "Daily discrimination", 
  "Loneliness",
  "Ongoing health problems", 
  "Ongoing physical/emotional problems", 
  "Ongoing alcohol/drug issues in family member", 
  "Ongoing difficulties at work", 
  "Ongoing financial strain", 
  "Ongoing housing problems", 
  "Ongoing problems in a close relationship",
  "Helping sick family members or friends regularly",
  "Unfairly dismissed from a job",
  "Unfairly not been hired for a job",
  "Unfairly denied a promotion",
  "Unfairly been prevented from moving into a neighborhood",
  "Unfairly denied a bank loan",
  "Unfairly treated by the police",
  "Unfairly denied health care",
  "Experienced the death of a child", 
  "Experienced a natural disaster",
  "Fired a weapon in combat",
  "Partner addicted to drugs/alcohol", 
  "Been a victim of a physical attack",
  "Ever had a life-threatening illness", 
  "Ever had a spouse/child with a life-threatening illness", 
  "Involuntarily lost a job for reasons other than retirement",
  "Unemployed",
  "Anyone else in the household unemployed", 
  "Moved to a worse residence/neighborhood",
  "Robbed/burglarized",
  "Been the victim of fraud",
  "Ever been in a jail",
  "Ever been in long-term hospitalization",
  "Ever lived in a combat zone",
  "Ever lived in military housing",
  "Ever been homeless",
  
  "Ever smoking", 
  "Currently smoking", 
  "Ever drinking any alcohol",
  "Total number of drinks per week", 
  "Light physical activities", 
  "Moderate physical activities", 
  "Vigorous physical activities",
  "Body mass index",
  "Sleep problems", 

  "Government health insurance", 
  "Private health insurance", 
  "Long-term care insurance",
  "Life insurance",
  "Access to routine place for healthcare",
  "Out-of-pocket medical expenditure",
  "Lower healthcare satisfaction"
  )

# Create a list of label formulas for table summary
label_list <- list()
for (i in 1:length(var_name)) {
  formula_str <- paste0(var_order[i], " ~ ", "\"", gsub("'", "'", var_name[i]), "\"")
  label_list[[i]] <- as.formula(formula_str)
}

# Create summary table with detailed configurations
tbl <- missing_desc %>%
  mutate(
    male = relevel(factor(male, labels = c("no", "yes")), ref = "no"),
    raracem = factor(raracem, labels = c("White", "Black", "Other")),
    faunem = factor(faunem, levels = c("yes", "no", "never_work", "not_alive"), labels = c("Yes", "No", "Father never worked/always disabled", "Never lived with father/father was not alive")), 
    radadoccup = factor(radadoccup, labels = c("White collar", "Blue collar", "Military")),
    lbrf = factor(lbrf, levels = c("employed", "retired", "others"), labels = c("Working full-time/part-time", "Partly retired/retired", "Unemployed/disabled/not in the labor force")),
    hometype = factor(hometype, levels = c("mobilehome", "onefamily", "twofamily", "apartment", "other"), labels = c("Mobile home", "One-family house", "Two-family house/duplex", "Apartment/townhouse", "Other")),
    cenreg = factor(cenreg, levels = c("South", "Northeast", "Midwest", "West"), labels = c("South", "Northeast", "Midwest", "West")),
    mstat = factor(mstat, levels = c("married", "separated", "widowed", "never"), labels = c("Married/partnered", "Separated/divorced", "Widowed", "Never married")),
  ) %>%
  tbl_summary(
    by = male,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = label_list,
    type = list(famfin ~ "continuous", socladder ~ "continuous", nnsafety ~ "continuous", care ~ "continuous", playwthchld ~ "continuous", volunteer ~ "continuous", charity ~ "continuous", educourse ~ "continuous", club ~ "continuous", organizations ~ "continuous", pray ~ "continuous", book ~ "continuous", tv ~ "continuous", puzzles ~ "continuous", cards ~ "continuous", writing ~ "continuous", computer ~ "continuous", gardening ~ "continuous", bake ~ "continuous", clothes ~ "continuous", hobby ~ "continuous", sports ~ "continuous", walk ~ "continuous", socrelg_h ~ "continuous", loneliness ~ "continuous", oghealth ~ "continuous", ogphymen ~ "continuous", ogdrug ~ "continuous", ogwork ~ "continuous", ogfis ~ "continuous", oghouse ~ "continuous", ogclose ~ "continuous", oghelp ~ "continuous", ltactx ~ "continuous", mdactx ~ "continuous", vgactx ~ "continuous", caresat ~ "continuous"),
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1)),
    missing = "no"
    ) %>%
  modify_table_body(
    fun = ~.x %>%
      arrange(factor(variable, levels = var_order)) %>%
      left_join(missing_perc, by = "variable") %>%
      mutate(
        missing_rate = case_when(
          row_type == "label" ~ missing_rate,
          TRUE ~ NA_real_
        )
      )
     ) %>%
  modify_header(
    label = "**Variable**",
    missing_rate = "**Missing rate (%)**"
    ) %>%
  modify_fmt_fun(missing_rate ~ function(x) style_number(x, digits = 1))

tbl %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = "E:/Multiple cohort study/Harmonized Data FIile/HarmonizedSurveyData/social_factors_health/results/Table/Table 1_missing predictors_by sex_hrs.docx")

rm(missing_desc, missing_perc, tbl)

```

### By age

```{r}

# Select variables
missing_desc <- final %>% 
  filter(fi_b < 0.2) %>%
  dplyr::select(
    age, male, 
    famfin, movfin, fmfinh, rameduc, rafeduc, faunem, radadoccup, 
    schlover, trpolice, drkdrug, phyabuse, 
    orphanage, fosterhome, padivch, padiech, sepmom, sepdad,
    raracem, rahispan, raedyrs, atotb, itot, lbrf, socladder,
    efoodstamp, enoughfood, rural, nnsafety, cenreg, hometype, homeown,
    mstat, hhres, cchild, csib, cfriend, 
    care, playwthchld, volunteer, charity, educourse, club, organizations, pray, book, tv, 
    puzzles, cards, writing, computer, gardening, bake, clothes, hobby, sports, walk, socrelg_h, 
    nnphysical, nnsocial,
    chldcontact, sibcontact, friendcontact, 
    sposupport, kposupport, oposupport, fposupport, 
    snegsupport, knegsupport, onegsupport, fnegsupport, 
    pdailydiscrim, loneliness,
    ufdis, ufhire, ufdenyp, ufpvmov, ufdenyb, ufpolic, ufdenyh,
    chdeathe, nadise, combate, drugcse, attacke, lifethe, lifethcse, 
    oghealth, ogphymen, ogdrug, ogwork, ogfis, oghouse, ogclose, oghelp,
    lostjob, unemployed, hshdunemployed, worseresid, robbed, fraud, 
    jail, longhospital, combatzone, military, homeless,
    smokev, smoken, drink, drinkdn, vgactx, mdactx, ltactx, bmi, sleep,
    higov, hipriv, hiltc, lifein, oopmd, caresat, usualcare) 

# Calculate missing percentages for each variable
missing_perc <- tibble(
  variable = skim(missing_desc)$skim_variable,
  missing_rate = (1 - skim(missing_desc)$complete_rate)*100
)

# Define variable groups
demo <- c("age", "male")
ace <- c(
  "famfin", "rafeduc", "rameduc", "movfin", "fmfinh", "faunem", "radadoccup", 
  "schlover", "trpolice", "drkdrug", "phyabuse", "orphanage", "fosterhome", "padivch", "padiech", "sepmom", "sepdad")
ses <- c("raedyrs", "atotb", "itot", "socladder", "raracem", "rahispan", "lbrf")
mc <- c("efoodstamp", "enoughfood", "homeown", "hometype", "rural", "cenreg", "nnsafety")
socc <- c(
  "mstat", "hhres", "cchild", "csib", "cfriend", 
  "chldcontact", "sibcontact", "friendcontact", 
  "sposupport", "kposupport", "oposupport", "fposupport", "snegsupport", "knegsupport", "onegsupport", "fnegsupport", 
  "care", "playwthchld", "volunteer", "charity", "educourse", "club", "organizations", 
  "pray", "book", "tv", "puzzles", "cards", "writing", "computer", "gardening", "bake", "clothes", 
  "hobby", "sports", "walk", "socrelg_h", "nnphysical", "nnsocial")
stress <- c(
  "pdailydiscrim", "loneliness", 
  "oghealth", "ogphymen", "ogdrug", "ogwork", "ogfis", "oghouse", "ogclose", "oghelp", 
  "ufdis", "ufhire", "ufdenyp", "ufpvmov", "ufdenyb", "ufpolic", "ufdenyh", 
  "chdeathe", "nadise", "combate", "drugcse", "attacke", "lifethe", "lifethcse", 
  "lostjob", "unemployed", "hshdunemployed", "worseresid", "robbed", "fraud", 
  "jail", "longhospital", "combatzone", "military", "homeless")
behav <- c("smokev", "smoken", "drink", "drinkdn", "ltactx", "mdactx", "vgactx", "bmi", "sleep")
hcare <- c("higov", "hipriv", "hiltc", "lifein", "usualcare", "oopmd", "caresat")

# Define the order of variables
var_order <- c(demo, ace, ses, mc, socc, stress, behav, hcare)

# Define variable names
var_name <- c(
  "Age",
  "Sex: male",
  
  "Lower family financial situation",
  "Higher father's education", 
  "Higher mother's education",
  "Relocated due to financial difficulties",
  "Family received financial help",
  "Father unemployed",
  "Father's occupation", 

  "Repeated school",
  "Trouble with police",
  "Parents used drugs or alcohol",
  "Physically abused",
  "Live in an orphanage",
  "Live in a foster home",
  "Parents separated or divorced",
  "Parents died",
  "Separated from mother",
  "Separated from father",
  
  "Higher education",
  "Household wealth",
  "Annual household income",
  "Higher subjective social status",
  "Race",
  "Hispanic", 
  "Labor force status",
  
  "Received food stamps", 
  "Experienced food insecurity",
  "Home ownership",
  "House's type",
  "Live in the rural area",
  "Census region",
  "Neighborhood unsafety", 
  
  "Marital status",
  "Household size",
  "Number of close children",
  "Number of close family members", 
  "Number of close friends",
  "Contact with children",
  "Contact with other family members", 
  "Contact with friends", 
  "Support from spouse", 
  "Strain from spouse",
  "Support from children", 
  "Strain from children", 
  "Support from other family members", 
  "Strain from other family members", 
  "Support from friends",
  "Strain from friends", 
  "Care for a sick adult", 
  "Do activities with grandchildren",
  "Volunteer with children",
  "Do charity work", 
  "Attend an educational course",
  "Go to a sport/social club",
  "Attend meetings of non-religious organizations", 
  "Pray privately",
  "Reading",
  "Watch television",
  "Do word games",
  "Play cards or chess",
  "Writing",
  "Use a computer or email",
  "Maintenance or gardening",
  "Baking or cooking",
  "Knitting",
  "Work on a hobby or project",
  "Play sports or exercise",
  "Walk for ≥20 minutes",
  "Attend religious activities",
  "Neighborhood physical disorder", 
  "Neighborhood social cohesion", 

  "Daily discrimination", 
  "Loneliness",
  "Ongoing health problems", 
  "Ongoing physical/emotional problems", 
  "Ongoing alcohol/drug issues in family member", 
  "Ongoing difficulties at work", 
  "Ongoing financial strain", 
  "Ongoing housing problems", 
  "Ongoing problems in a close relationship",
  "Helping sick family members or friends regularly",
  "Unfairly dismissed from a job",
  "Unfairly not been hired for a job",
  "Unfairly denied a promotion",
  "Unfairly been prevented from moving into a neighborhood",
  "Unfairly denied a bank loan",
  "Unfairly treated by the police",
  "Unfairly denied health care",
  "Experienced the death of a child", 
  "Experienced a natural disaster",
  "Fired a weapon in combat",
  "Partner addicted to drugs/alcohol", 
  "Been a victim of a physical attack",
  "Ever had a life-threatening illness", 
  "Ever had a spouse/child with a life-threatening illness", 
  "Involuntarily lost a job for reasons other than retirement",
  "Unemployed",
  "Anyone else in the household unemployed", 
  "Moved to a worse residence/neighborhood",
  "Robbed/burglarized",
  "Been the victim of fraud",
  "Ever been in a jail",
  "Ever been in long-term hospitalization",
  "Ever lived in a combat zone",
  "Ever lived in military housing",
  "Ever been homeless",
  
  "Ever smoking", 
  "Currently smoking", 
  "Ever drinking any alcohol",
  "Total number of drinks per week", 
  "Light physical activities", 
  "Moderate physical activities", 
  "Vigorous physical activities",
  "Body mass index",
  "Sleep problems", 

  "Government health insurance", 
  "Private health insurance", 
  "Long-term care insurance",
  "Life insurance",
  "Access to routine place for healthcare",
  "Out-of-pocket medical expenditure",
  "Lower healthcare satisfaction"
  )

# Create a list of label formulas for table summary
label_list <- list()
for (i in 1:length(var_name)) {
  formula_str <- paste0(var_order[i], " ~ ", "\"", gsub("'", "'", var_name[i]), "\"")
  label_list[[i]] <- as.formula(formula_str)
}

# Create summary table with detailed configurations
tbl <- missing_desc %>%
  mutate(
    agegroup = relevel(factor(ifelse(age >= 65, ">=65", "<65")), ref = "<65"),
    male = relevel(factor(male, labels = c("no", "yes")), ref = "no"),
    raracem = factor(raracem, labels = c("White", "Black", "Other")),
    faunem = factor(faunem, levels = c("yes", "no", "never_work", "not_alive"), labels = c("Yes", "No", "Father never worked/always disabled", "Never lived with father/father was not alive")), 
    radadoccup = factor(radadoccup, labels = c("White collar", "Blue collar", "Military")),
    lbrf = factor(lbrf, levels = c("employed", "retired", "others"), labels = c("Working full-time/part-time", "Partly retired/retired", "Unemployed/disabled/not in the labor force")),
    hometype = factor(hometype, levels = c("mobilehome", "onefamily", "twofamily", "apartment", "other"), labels = c("Mobile home", "One-family house", "Two-family house/duplex", "Apartment/townhouse", "Other")),
    cenreg = factor(cenreg, levels = c("South", "Northeast", "Midwest", "West"), labels = c("South", "Northeast", "Midwest", "West")),
    mstat = factor(mstat, levels = c("married", "separated", "widowed", "never"), labels = c("Married/partnered", "Separated/divorced", "Widowed", "Never married")),
  ) %>%
  tbl_summary(
    by = agegroup,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = label_list,
    type = list(famfin ~ "continuous", socladder ~ "continuous", nnsafety ~ "continuous", care ~ "continuous", playwthchld ~ "continuous", volunteer ~ "continuous", charity ~ "continuous", educourse ~ "continuous", club ~ "continuous", organizations ~ "continuous", pray ~ "continuous", book ~ "continuous", tv ~ "continuous", puzzles ~ "continuous", cards ~ "continuous", writing ~ "continuous", computer ~ "continuous", gardening ~ "continuous", bake ~ "continuous", clothes ~ "continuous", hobby ~ "continuous", sports ~ "continuous", walk ~ "continuous", socrelg_h ~ "continuous", loneliness ~ "continuous", oghealth ~ "continuous", ogphymen ~ "continuous", ogdrug ~ "continuous", ogwork ~ "continuous", ogfis ~ "continuous", oghouse ~ "continuous", ogclose ~ "continuous", oghelp ~ "continuous", ltactx ~ "continuous", mdactx ~ "continuous", vgactx ~ "continuous", caresat ~ "continuous"),
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1)),
    missing = "no"
    ) %>%
  modify_table_body(
    fun = ~.x %>%
      arrange(factor(variable, levels = var_order)) %>%
      left_join(missing_perc, by = "variable") %>%
      mutate(
        missing_rate = case_when(
          row_type == "label" ~ missing_rate,
          TRUE ~ NA_real_
        )
      )
     ) %>%
  modify_header(
    label = "**Variable**",
    missing_rate = "**Missing rate (%)**"
    ) %>%
  modify_fmt_fun(missing_rate ~ function(x) style_number(x, digits = 1))

tbl %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = "E:/Multiple cohort study/Harmonized Data FIile/HarmonizedSurveyData/social_factors_health/results/Table/Table 1_missing predictors_by age_hrs.docx")

rm(missing_desc, missing_perc, tbl)

```


## Supplementary Table 4: Descriptive statistics for missing rate of frailty index

### Baseline

```{r}

id_nonf_2010 <- final %>% filter(fi_b < 0.2 & wave == 2010) %>% pull(id)
id_nonf_2012 <- final %>% filter(fi_b < 0.2 & wave == 2012) %>% pull(id)

missing_fi <- long_hrs %>%
  filter((hhidpn %in% id_nonf_2010 & wave == 2010) | (hhidpn %in% id_nonf_2012 & wave == 2012)) %>%
  mutate(
    .keep = "none",
    id = hhidpn, wave,
    # Disease
    hibpe, diabe, cancre, lunge, hearte, stroke, arthre, psyche, 
    memrye = case_when(
      memrye >= 1 ~ 1,
      memrye == 0 ~ 0,
      TRUE ~ NA_real_
      ),
      # Physical function
    dressa, batha, eata, beda, toilta, walkra, # ADLs 
    moneya, medsa, shopa, mealsa, phonea, mapa, # IADLs
    walksa, walk1a, sita, chaira, climsa, clim1a, stoopa, lifta, dimea, armsa, pusha, # Mobility limitations
      # Self-reported health
    prshlt = case_when(
      shlt == 5 ~ 1,
      shlt == 4 ~ 0.75,
      shlt == 3 ~ 0.5,
      shlt == 2 ~ 0.25,
      shlt == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    dvi = case_when(
      dsight %in% c(5:6) ~ 1,
      dsight == 4 ~ 0.75,
      dsight == 3 ~ 0.5,
      dsight == 2 ~ 0.25,
      dsight == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    nvi = case_when(
      nsight %in% c(5:6) ~ 1,
      nsight == 4 ~ 0.75,
      nsight == 3 ~ 0.5,
      nsight == 2 ~ 0.25,
      nsight == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    hi = case_when(
      hearing %in% c(5:6) ~ 1,
      hearing == 4 ~ 0.75,
      hearing == 3 ~ 0.5,
      hearing == 2 ~ 0.25,
      hearing == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    pain = painfr, urinai, 
      # Depressive symptoms
    depres, effort, whappy = 1-whappy, fsad, going, enlife = 1-enlife,
      # Cognition
    imrc, dlrc, ser7
    ) %>%
  remove_all_labels() %>%
  zap_formats() %>%
  rowwise() %>% 
  mutate(
    disease = sum(c(hibpe, diabe, cancre, lunge, hearte, stroke, arthre, psyche, memrye), na.rm = F),
    adl = sum(c(dressa, batha, eata, beda, toilta, walkra), na.rm = F),
    iadl = sum(c(moneya, medsa, shopa, mealsa, phonea, mapa), na.rm = F),
    moblimit = sum(c(walksa, walk1a, sita, chaira, climsa, clim1a, stoopa, lifta, dimea, armsa, pusha), na.rm = T),
    depres, effort, whappy, fsad, going, enlife, # 6
    cognition = 1 - sum(c(imrc, dlrc, ser7), na.rm = F)/25, # 1
    fi = sum(c(disease, adl, iadl, moblimit, prshlt, dvi, nvi, hi, pain, urinai, depres, effort, whappy, fsad, going, enlife, cognition), na.rm = F)/45
  ) %>%
  ungroup() %>%
  dplyr::select(hibpe, diabe, cancre, lunge, hearte, stroke, arthre, psyche, memrye, dressa, batha, eata, beda, toilta, walkra, moneya, medsa, shopa, mealsa, phonea, mapa, walksa, walk1a, sita, chaira, climsa, clim1a, stoopa, lifta, dimea, armsa, pusha, pain, urinai, depres, effort, whappy, fsad, going, enlife, cognition, prshlt, dvi, nvi, hi) %>%
  mutate_at(.vars = c("hibpe", "diabe", "cancre", "lunge", "hearte", "stroke", "arthre", "psyche", "memrye", "dressa", "batha", "eata", "beda", "toilta", "walkra", "moneya", "medsa", "shopa", "mealsa", "phonea", "mapa", "walksa", "walk1a", "sita", "chaira", "climsa", "clim1a", "stoopa", "lifta", "dimea", "armsa", "pusha", "pain", "urinai", "depres", "effort", "whappy", "fsad", "going", "enlife"), .funs = fac_relevel3)

# Calculate missing percentages for each variable
missing_perc <- tibble(
  variable = skim(missing_fi)$skim_variable,
  missing_rate = (1 - skim(missing_fi)$complete_rate)*100
)

# Define the order of variables
var_order <- c("hibpe", "diabe", "cancre", "lunge", "hearte", "stroke", "arthre", "psyche", "memrye", "dressa", "batha", "eata", "beda", "toilta", "walkra", "moneya", "medsa", "shopa", "mealsa", "phonea", "mapa", "walksa", "walk1a", "sita", "chaira", "climsa", "clim1a", "stoopa", "lifta", "dimea", "armsa", "pusha", "pain", "urinai", "depres", "effort", "whappy", "fsad", "going", "enlife", "cognition", "prshlt", "dvi", "nvi", "hi")

# Define variable names 
var_name <- c(
  "Ever had high blood pressure or hypertension",
  "Ever had diabetes or high blood sugar",
  "Ever had cancer or a malignant tumor of any kind except skin cancer",
  "Ever had chronic lung disease except asthma such as chronic bronchitis or emphysema",
  "Ever had heart attack, coronary heart disease, angina, congestive heart failure, or other heart problems",
  "Ever had stroke or transient ischemic attack",
  "Ever had arthritis or rheumatism",
  "Ever had motional, nervous, or psychiatric problems",
  "Ever had memory-related disease",
  
  "Limitations in dressing",
  "Limitations in bathing or showering",
  "Limitations in eating",
  "Limitations in getting into or out of bed",
  "Limitations in using the toilet",
  "Limitations in walking in house",
  
  "Limitations in managing money",
  "Limitations in taking medications",
  "Limitations in shopping for groceries",
  "Limitations in preparing hot meals",
  "Limitations in using the telephone",
  "Limitations in using map",
  
  "Limitations in walking several blocks",
  "Limitations in walking one block",
  "Limitations in sitting for two hours",
  "Limitations in getting up from a chair",
  "Limitations in climbing several flights of stairs",
  "Limitations in climbing one flight of stairs",
  "Limitations in stooping, kneeling, or crouching",
  "Limitations in lifting or carrying weights over 10 pounds",
  "Limitations in picking up a dime from the table",
  "Limitations in reaching arms above shoulder level",
  "Limitations in pushing or pulling large objects",
  
  "Experiences frequent pain",
  "Experienced any urinary incontinence in last year",
  "Felt depressed",
  "Felt that everything they did was an effort",
  "Was not happy",
  "Felt sad",
  "Did not enjoy life",
  "Could not get going",
  "Cognitive decline",
  "Self-rating of health",
  "Distance vision impairment",
  "Near vision impairment",
  "Hearing impairment"
  )

# Create a list of label formulas for table summary
label_list <- list()
for (i in 1:length(var_name)) {
  formula_str <- paste0(var_order[i], " ~ ", "\"", gsub("'", "'", var_name[i]), "\"")
  label_list[[i]] <- as.formula(formula_str)
}

# Create summary table with detailed configurations
tbl <- missing_fi %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = label_list,
    type = list(cognition ~ "continuous", prshlt ~ "continuous", dvi ~ "continuous", nvi ~ "continuous", hi ~ "continuous"),
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1)),
    missing = "no"
    ) %>%
  modify_table_body(
    fun = ~.x %>%
      arrange(factor(variable, levels = var_order)) %>%
      left_join(missing_perc, by = "variable") %>%
      mutate(
        missing_rate = case_when(
          row_type == "label" ~ missing_rate,
          TRUE ~ NA_real_
        )
      )
  ) %>%
  modify_header(
    label = "**Variable**",
    missing_rate = "**Missing rate (%)**"
  ) %>%
  modify_fmt_fun(missing_rate ~ function(x) style_number(x, digits = 1)) %>%
  modify_footnote(
    label ~ "Data are presented as Mean (standard error) or Frequency (%).",
    all_stat_cols() ~ NA
  )
  
tbl %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = "E:/Multiple cohort study/Harmonized Data FIile/HarmonizedSurveyData/social_factors_health/results/Table/Table 1_ missing fi_baseline_hrs.docx")

rm(missing_fi, missing_perc, tbl)

```

### Follow-up

```{r}

missing_fi <- long_hrs %>%
  filter((hhidpn %in% id_nonf_2010 & wave == 2014) | (hhidpn %in% id_nonf_2012 & wave == 2016)) %>%
  mutate(
    .keep = "none",
    id = hhidpn, wave,
    # Disease
    hibpe, diabe, cancre, lunge, hearte, stroke, arthre, psyche, 
    memrye = case_when(
      memrye >= 1 ~ 1,
      memrye == 0 ~ 0,
      TRUE ~ NA_real_
      ),
      # Physical function
    dressa, batha, eata, beda, toilta, walkra, # ADLs 
    
    moneya, medsa, shopa, mealsa, phonea, mapa, # IADLs
    walksa, walk1a, sita, chaira, climsa, clim1a, stoopa, lifta, dimea, armsa, pusha, # Mobility limitations
      # Self-reported health
    prshlt = case_when(
      shlt == 5 ~ 1,
      shlt == 4 ~ 0.75,
      shlt == 3 ~ 0.5,
      shlt == 2 ~ 0.25,
      shlt == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    dvi = case_when(
      dsight %in% c(5:6) ~ 1,
      dsight == 4 ~ 0.75,
      dsight == 3 ~ 0.5,
      dsight == 2 ~ 0.25,
      dsight == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    nvi = case_when(
      nsight %in% c(5:6) ~ 1,
      nsight == 4 ~ 0.75,
      nsight == 3 ~ 0.5,
      nsight == 2 ~ 0.25,
      nsight == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    hi = case_when(
      hearing %in% c(5:6) ~ 1,
      hearing == 4 ~ 0.75,
      hearing == 3 ~ 0.5,
      hearing == 2 ~ 0.25,
      hearing == 1 ~ 0,
      TRUE ~ NA_real_
      ),
    pain = painfr, urinai, 
      # Depressive symptoms
    depres, effort, whappy = 1-whappy, fsad, going, enlife = 1-enlife,
      # Cognition
    imrc, dlrc, ser7
    ) %>%
  remove_all_labels() %>%
  zap_formats() %>%
  rowwise() %>% 
  mutate(
    disease = sum(c(hibpe, diabe, cancre, lunge, hearte, stroke, arthre, psyche, memrye), na.rm = F),
    adl = sum(c(dressa, batha, eata, beda, toilta, walkra), na.rm = F),
    iadl = sum(c(moneya, medsa, shopa, mealsa, phonea, mapa), na.rm = F),
    moblimit = sum(c(walksa, walk1a, sita, chaira, climsa, clim1a, stoopa, lifta, dimea, armsa, pusha), na.rm = T),
    depres, effort, whappy, fsad, going, enlife, # 6
    cognition = 1 - sum(c(imrc, dlrc, ser7), na.rm = F)/25, # 1
    fi = sum(c(disease, adl, iadl, moblimit, prshlt, dvi, nvi, hi, pain, urinai, depres, effort, whappy, fsad, going, enlife, cognition), na.rm = F)/45
  ) %>%
  ungroup() %>%
  dplyr::select(hibpe, diabe, cancre, lunge, hearte, stroke, arthre, psyche, memrye, dressa, batha, eata, beda, toilta, walkra, moneya, medsa, shopa, mealsa, phonea, mapa, walksa, walk1a, sita, chaira, climsa, clim1a, stoopa, lifta, dimea, armsa, pusha, pain, urinai, depres, effort, whappy, fsad, going, enlife, cognition, prshlt, dvi, nvi, hi) %>%
  mutate_at(.vars = c("hibpe", "diabe", "cancre", "lunge", "hearte", "stroke", "arthre", "psyche", "memrye", "dressa", "batha", "eata", "beda", "toilta", "walkra", "moneya", "medsa", "shopa", "mealsa", "phonea", "mapa", "walksa", "walk1a", "sita", "chaira", "climsa", "clim1a", "stoopa", "lifta", "dimea", "armsa", "pusha", "pain", "urinai", "depres", "effort", "whappy", "fsad", "going", "enlife"), .funs = fac_relevel3)

# Calculate missing percentages for each variable
missing_perc <- tibble(
  variable = skim(missing_fi)$skim_variable,
  missing_rate = (1 - skim(missing_fi)$complete_rate)*100
)

# Define the order of variables
var_order <- c("hibpe", "diabe", "cancre", "lunge", "hearte", "stroke", "arthre", "psyche", "memrye", "dressa", "batha", "eata", "beda", "toilta", "walkra", "moneya", "medsa", "shopa", "mealsa", "phonea", "mapa", "walksa", "walk1a", "sita", "chaira", "climsa", "clim1a", "stoopa", "lifta", "dimea", "armsa", "pusha", "pain", "urinai", "depres", "effort", "whappy", "fsad", "going", "enlife", "cognition", "prshlt", "dvi", "nvi", "hi")

# Define variable names 
var_name <- c(
  "Ever had high blood pressure or hypertension",
  "Ever had diabetes or high blood sugar",
  "Ever had cancer or a malignant tumor of any kind except skin cancer",
  "Ever had chronic lung disease except asthma such as chronic bronchitis or emphysema",
  "Ever had heart attack, coronary heart disease, angina, congestive heart failure, or other heart problems",
  "Ever had stroke or transient ischemic attack",
  "Ever had arthritis or rheumatism",
  "Ever had motional, nervous, or psychiatric problems",
  "Ever had memory-related disease",
  
  "Limitations in dressing",
  "Limitations in bathing or showering",
  "Limitations in eating",
  "Limitations in getting into or out of bed",
  "Limitations in using the toilet",
  "Limitations in walking in house",
  
  "Limitations in managing money",
  "Limitations in taking medications",
  "Limitations in shopping for groceries",
  "Limitations in preparing hot meals",
  "Limitations in using the telephone",
  "Limitations in using map",
  
  "Limitations in walking several blocks",
  "Limitations in walking one block",
  "Limitations in sitting for two hours",
  "Limitations in getting up from a chair",
  "Limitations in climbing several flights of stairs",
  "Limitations in climbing one flight of stairs",
  "Limitations in stooping, kneeling, or crouching",
  "Limitations in lifting or carrying weights over 10 pounds",
  "Limitations in picking up a dime from the table",
  "Limitations in reaching arms above shoulder level",
  "Limitations in pushing or pulling large objects",
  
  "Experiences frequent pain",
  "Experienced any urinary incontinence in last year",
  "Felt depressed",
  "Felt that everything they did was an effort",
  "Was not happy",
  "Felt sad",
  "Did not enjoy life",
  "Could not get going",
  "Cognitive decline",
  "Self-rating of health",
  "Distance vision impairment",
  "Near vision impairment",
  "Hearing impairment"
  )

# Create a list of label formulas for table summary
label_list <- list()
for (i in 1:length(var_name)) {
  formula_str <- paste0(var_order[i], " ~ ", "\"", gsub("'", "'", var_name[i]), "\"")
  label_list[[i]] <- as.formula(formula_str)
}

# Create summary table with detailed configurations
tbl <- missing_fi %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = label_list,
    type = list(cognition ~ "continuous", prshlt ~ "continuous", dvi ~ "continuous", nvi ~ "continuous", hi ~ "continuous"),
    digits = list(all_continuous() ~ 1, all_categorical() ~ c(0, 1)),
    missing = "no"
    ) %>%
  modify_table_body(
    fun = ~.x %>%
      arrange(factor(variable, levels = var_order)) %>%
      left_join(missing_perc, by = "variable") %>%
      mutate(
        missing_rate = case_when(
          row_type == "label" ~ missing_rate,
          TRUE ~ NA_real_
        )
      )
  ) %>%
  modify_header(
    label = "**Variable**",
    missing_rate = "**Missing rate (%)**"
  ) %>%
  modify_fmt_fun(missing_rate ~ function(x) style_number(x, digits = 1)) %>%
  modify_footnote(
    label ~ "Data are presented as Mean (standard error) or Frequency (%).",
    all_stat_cols() ~ NA
  )
  
tbl %>%
  as_flex_table() %>%
  flextable::save_as_docx(path = "E:/Multiple cohort study/Harmonized Data FIile/HarmonizedSurveyData/social_factors_health/results/Table/Table 1_ missing fi_followup_hrs.docx")

rm(missing_fi, missing_perc, tbl)

```

## Heatamp for predictors

```{r}

predictors <- final %>%
  filter(fi_b < 0.2) %>%
  dplyr::select(
    age, male, 
    famfin, movfin, fmfinh, rameduc, rafeduc, faunem, radadoccup, 
    schlover, trpolice, drkdrug, phyabuse, 
    orphanage, fosterhome, padivch, padiech, sepmom, sepdad,
    raracem, rahispan, raedyrs, atotb, itot, lbrf, socladder,
    efoodstamp, enoughfood, rural, nnsafety, cenreg, hometype, homeown,
    mstat, hhres, cchild, csib, cfriend, 
    care, playwthchld, volunteer, charity, educourse, club, organizations, pray, book, tv, 
    puzzles, cards, writing, computer, gardening, bake, clothes, hobby, sports, walk, socrelg_h, 
    nnphysical, nnsocial,
    chldcontact, sibcontact, friendcontact, 
    sposupport, snegsupport, kposupport, knegsupport, oposupport, onegsupport, fposupport, fnegsupport,
    pdailydiscrim, loneliness,
    ufdis, ufhire, ufdenyp, ufpvmov, ufdenyb, ufpolic, ufdenyh,
    chdeathe, nadise, combate, drugcse, attacke, lifethe, lifethcse, 
    oghealth, ogphymen, ogdrug, ogwork, ogfis, oghouse, ogclose, oghelp,
    lostjob, unemployed, hshdunemployed, worseresid, robbed, fraud, 
    jail, longhospital, combatzone, military, homeless,
    smokev, smoken, drink, drinkdn, vgactx, mdactx, ltactx, bmi, sleep,
    higov, hipriv, hiltc, lifein, oopmd, caresat, usualcare)

cate_var <- predictors %>% 
  dplyr::select(where(is.factor)) %>%
  colnames()

cont_var <- predictors %>% 
  dplyr::select(where(is.numeric)) %>%
  colnames()

transformed_predictors <- predictors %>%
  mutate_if(is.factor, as.numeric)

# Define variable groups
demo <- c("age", "male")
ace <- c(
  "famfin", "rafeduc", "rameduc", "movfin", "fmfinh", "faunem", "radadoccup", 
  "schlover", "trpolice", "drkdrug", "phyabuse", "orphanage", "fosterhome", "padivch", "padiech", "sepmom", "sepdad")
ses <- c("raedyrs", "atotb", "itot", "socladder", "raracem", "rahispan", "lbrf")
mc <- c("efoodstamp", "enoughfood", "homeown", "hometype", "rural", "cenreg", "nnsafety")
socc <- c(
  "mstat", "hhres", "cchild", "csib", "cfriend", 
  "chldcontact", "sibcontact", "friendcontact", 
  "sposupport", "kposupport", "oposupport", "fposupport", "snegsupport", "knegsupport", "onegsupport", "fnegsupport", 
  "care", "playwthchld", "volunteer", "charity", "educourse", "club", "organizations", 
  "pray", "book", "tv", "puzzles", "cards", "writing", "computer", "gardening", "bake", "clothes", 
  "hobby", "sports", "walk", "socrelg_h", "nnphysical", "nnsocial")
stress <- c(
  "pdailydiscrim", "loneliness", 
  "oghealth", "ogphymen", "ogdrug", "ogwork", "ogfis", "oghouse", "ogclose", "oghelp", 
  "ufdis", "ufhire", "ufdenyp", "ufpvmov", "ufdenyb", "ufpolic", "ufdenyh", 
  "chdeathe", "nadise", "combate", "drugcse", "attacke", "lifethe", "lifethcse", 
  "lostjob", "unemployed", "hshdunemployed", "worseresid", "robbed", "fraud", 
  "jail", "longhospital", "combatzone", "military", "homeless")
behav <- c("smokev", "smoken", "drink", "drinkdn", "ltactx", "mdactx", "vgactx", "bmi", "sleep")
hcare <- c("higov", "hipriv", "hiltc", "lifein", "usualcare", "oopmd", "caresat")

# Define the order of variables
var_order <- c(demo, ace, ses, mc, socc, stress, behav, hcare)

# Define variable names
var_name <- c(
  "Age",
  "Sex: male",
  
  "Lower family financial situation",
  "Higher father's education", 
  "Higher mother's education",
  "Relocated due to financial difficulties",
  "Family received financial help",
  "Father unemployed",
  "Father's occupation", 

  "Repeated school",
  "Trouble with police",
  "Parents used drugs or alcohol",
  "Physically abused",
  "Live in an orphanage",
  "Live in a foster home",
  "Parents separated or divorced",
  "Parents died",
  "Separated from mother",
  "Separated from father",
  
  "Higher education",
  "Household wealth",
  "Annual household income",
  "Higher subjective social status",
  "Race",
  "Hispanic", 
  "Labor force status",
  
  "Received food stamps", 
  "Experienced food insecurity",
  "Home ownership",
  "House's type",
  "Live in the rural area",
  "Census region",
  "Neighborhood unsafety", 
  
  "Marital status",
  "Household size",
  "Number of close children",
  "Number of close family members", 
  "Number of close friends",
  "Contact with children",
  "Contact with other family members", 
  "Contact with friends", 
  "Support from spouse", 
  "Strain from spouse",
  "Support from children", 
  "Strain from children", 
  "Support from other family members", 
  "Strain from other family members", 
  "Support from friends",
  "Strain from friends", 
  "Care for a sick adult", 
  "Do activities with grandchildren",
  "Volunteer with children",
  "Do charity work", 
  "Attend an educational course",
  "Go to a sport/social club",
  "Attend meetings of non-religious organizations", 
  "Pray privately",
  "Reading",
  "Watch television",
  "Do word games",
  "Play cards or chess",
  "Writing",
  "Use a computer or email",
  "Maintenance or gardening",
  "Baking or cooking",
  "Knitting",
  "Work on a hobby or project",
  "Play sports or exercise",
  "Walk for ≥20 minutes",
  "Attend religious activities",
  "Neighborhood physical disorder", 
  "Neighborhood social cohesion", 

  "Daily discrimination", 
  "Loneliness",
  "Ongoing health problems", 
  "Ongoing physical/emotional problems", 
  "Ongoing alcohol/drug issues in family member", 
  "Ongoing difficulties at work", 
  "Ongoing financial strain", 
  "Ongoing housing problems", 
  "Ongoing problems in a close relationship",
  "Helping sick family members or friends regularly",
  "Unfairly dismissed from a job",
  "Unfairly not been hired for a job",
  "Unfairly denied a promotion",
  "Unfairly been prevented from moving into a neighborhood",
  "Unfairly denied a bank loan",
  "Unfairly treated by the police",
  "Unfairly denied health care",
  "Experienced the death of a child", 
  "Experienced a natural disaster",
  "Fired a weapon in combat",
  "Partner addicted to drugs/alcohol", 
  "Been a victim of a physical attack",
  "Ever had a life-threatening illness", 
  "Ever had a spouse/child with a life-threatening illness", 
  "Involuntarily lost a job for reasons other than retirement",
  "Unemployed",
  "Anyone else in the household unemployed", 
  "Moved to a worse residence/neighborhood",
  "Robbed/burglarized",
  "Been the victim of fraud",
  "Ever been in a jail",
  "Ever been in long-term hospitalization",
  "Ever lived in a combat zone",
  "Ever lived in military housing",
  "Ever been homeless",
  
  "Ever smoking", 
  "Currently smoking", 
  "Ever drinking any alcohol",
  "Total number of drinks per week", 
  "Light physical activities", 
  "Moderate physical activities", 
  "Vigorous physical activities",
  "Body mass index",
  "Sleep problems", 

  "Government health insurance", 
  "Private health insurance", 
  "Long-term care insurance",
  "Life insurance",
  "Access to routine place for healthcare",
  "Out-of-pocket medical expenditure",
  "Lower healthcare satisfaction"
  )

# Calculate spearman correlation matrix
cor_matrix <- cor(transformed_predictors, method = "spearman", use = "pairwise.complete.obs")
heatmap_mat_hrs <- cor_matrix[, var_order]
colnames(heatmap_mat_hrs) <- var_name
heatmap_mat_hrs <- heatmap_mat_hrs[var_order,]
rownames(heatmap_mat_hrs) <- var_name

rm(predictors, cor_matrix)

```

# Develop machine learning models 

```{r}

opt_hyper_hrs <- tibble(
  group = c("overall", "female", "male", "<65 years", "≥65 years"), 
  mtry = NA, trees = NA, min_n = NA, tree_depth = NA, 
  learn_rate = NA, loss_reduction = NA, sample_size = NA, stop_iter = NA
)

```

## Overall

### Data preparation

```{r}

# Train-test split
data <- final %>%
  filter(fi_b < 0.2) %>%
  dplyr::select(
    age, male, 
    famfin, rameduc, rafeduc, movfin, fmfinh, faunem, radadoccup, 
    schlover, trpolice, drkdrug, phyabuse, 
    orphanage, fosterhome, padivch, padiech, sepmom, sepdad,
    raedyrs, atotb, itot, socladder, raracem, rahispan, lbrf, 
    efoodstamp, enoughfood, homeown, hometype, rural, cenreg, nnsafety, 
    mstat, hhres, cchild, csib, cfriend, chldcontact, sibcontact, friendcontact, 
    sposupport, kposupport, oposupport, fposupport, 
    snegsupport, knegsupport, onegsupport, fnegsupport, 
    care, playwthchld, volunteer, charity, educourse, club, organizations, pray, book, tv, 
    puzzles, cards, writing, computer, gardening, bake, clothes, hobby, sports, walk, socrelg_h, 
    nnphysical, nnsocial,
    pdailydiscrim, loneliness,
    oghealth, ogphymen, ogdrug, ogwork, ogfis, oghouse, ogclose, oghelp,
    ufdis, ufhire, ufdenyp, ufpvmov, ufdenyb, ufpolic, ufdenyh,
    chdeathe, nadise, combate, drugcse, attacke, lifethe, lifethcse, 
    lostjob, unemployed, hshdunemployed, worseresid, robbed, fraud, 
    jail, longhospital, combatzone, military, homeless,
    smokev, smoken, drink, drinkdn, ltactx, mdactx, vgactx, bmi, sleep,
    higov, hipriv, hiltc, lifein, usualcare, oopmd, caresat, 
    fi)
# 5792 participants

set.seed(12345)
hrs_split <- initial_split(data, prop = 0.8)
train_hrs <- training(hrs_split)
test_hrs  <- testing(hrs_split)

# Missing value imputation
tic()
train_preped <- missRanger(train_hrs %>% dplyr::select(!fi), . ~ ., pmm.k = 5, maxiter = 10, num.trees = 100, returnOOB = T, verbose = 1, seed = 12345)
toc() # 16 s
train_preped$fi <- train_hrs$fi

tic()
test_preped <- missRanger(test_hrs %>% dplyr::select(!fi), . ~ ., pmm.k = 5, maxiter = 10, num.trees = 100, returnOOB = T, verbose = 1, seed = 12345)
toc() # 11 s
test_preped$fi <- test_hrs$fi

# Data baking
train_baked <- recipe(fi ~ ., data = train_preped) %>% 
  prep() %>%
  bake(new_data = NULL) %>%
  dplyr::select(!fi, fi) 

test_baked <- recipe(fi ~ ., data = test_preped) %>% 
  prep() %>%
  bake(new_data = NULL) %>%
  dplyr::select(!fi, fi)

#### Save data for GA2M ####
write.csv(train_baked, file = "train_baked_hrs.csv", row.names = F)
write.csv(test_baked, file = "test_baked_hrs.csv", row.names = F)

```

### Model comparison

```{r}

# Preprocessing and virtual encoding
hrs_rec <- recipe(fi ~ ., data = train_preped) %>%
  step_dummy(all_factor_predictors(), one_hot = F)

# Cross-validation setup
set.seed(12345)
hrs_cv_folds <- rsample::vfold_cv(train_preped, v = 3)

# Model definitions
# SVM model
svm_mod <- svm_rbf(
  cost = tune(),
  rbf_sigma = tune()
) %>%
  set_engine("kernlab") %>%
  set_mode("regression")

# XGBoost model
xgb_mod <- boost_tree(
  trees = tune(), # nrounds
  tree_depth = tune(),
  min_n = tune(),
  loss_reduction = tune(),  
  sample_size = tune(),
  mtry = tune(),
  learn_rate = tune(),
  stop_iter = tune()
  ) %>%
  set_engine("xgboost", objective = "reg:squarederror") %>%
  set_mode("regression")

# Random Forest model
rf_mod <- rand_forest(
  mtry = tune(),
  trees = tune(),
  min_n = tune()
) %>%
  set_engine("ranger") %>%
  set_mode("regression")

# Lasso model
lasso_mod <- linear_reg(
  penalty = tune(),
  mixture = 1  # Lasso
) %>%
  set_engine("glmnet") %>%
  set_mode("regression")

# Elastic Net model
elastic_mod <- linear_reg(
  penalty = tune(),
  mixture = tune()  # Elastic Net
) %>%
  set_engine("glmnet") %>%
  set_mode("regression")

# Parameter grids
# SVM parameter grid
set.seed(12345)
svm_grid <- grid_latin_hypercube(
  cost(range = c(-10, 10), trans = log10_trans()),
  rbf_sigma(range = c(-10, 10), trans = log10_trans()),
  size = 50
)

# XGBoost parameter grid
set.seed(12345)
xgb_grid <- grid_latin_hypercube(
  trees(),
  tree_depth(), # max_depth
  min_n(), # min_child_weight
  loss_reduction(), # gamma
  sample_size = sample_prop(), # subsample
  finalize(mtry(), train_preped), # colsample_bynode
  learn_rate(),
  stop_iter(),
  size = 50
)

# Random Forest parameter grid
set.seed(12345)
rf_grid <- grid_latin_hypercube(
  mtry(range = c(1, ncol(train_preped) - 1)),
  trees(range = c(100, 1000)),
  min_n(range = c(10, 50)),
  size = 50
)

# Lasso parameter grid
set.seed(12345)
lasso_grid <- grid_regular(
  penalty(range = c(-10, 0)),
  levels = 50
)

# Elastic Net parameter grid
set.seed(12345)
elastic_grid <- grid_latin_hypercube(
  penalty(range = c(-10, 0)),
  mixture(range = c(0, 1)),
  size = 50
)

# Model performance metrics
model_metrics <- yardstick::metric_set(mae, rmse, rsq)

# Model tuning
# SVM
svm_wf <- create_workflow(svm_mod, hrs_rec)
svm_tuned <- tune_model(svm_wf, hrs_cv_folds, svm_grid, model_metrics) # 450s
svm_best_params <- svm_tuned %>% select_best(metric = "mae")

# XGBoost
xgb_wf <- create_workflow(xgb_mod, hrs_rec)
xgb_tuned <- tune_model(xgb_wf, hrs_cv_folds, xgb_grid, model_metrics) # 450s
xgb_best_params <- xgb_tuned %>% select_best(metric = "mae")

# Random Forest
rf_wf <- create_workflow(rf_mod, hrs_rec)
rf_tuned <- tune_model(rf_wf, hrs_cv_folds, rf_grid, model_metrics) # 600s
rf_best_params <- rf_tuned %>% select_best(metric = "mae")

# Lasso
lasso_wf <- create_workflow(lasso_mod, hrs_rec)
lasso_tuned <- tune_model(lasso_wf, hrs_cv_folds, lasso_grid, model_metrics) # 15s
lasso_best_params <- lasso_tuned %>% select_best(metric = "mae")

# Elastic Net
elastic_wf <- create_workflow(elastic_mod, hrs_rec)
elastic_tuned <- tune_model(elastic_wf, hrs_cv_folds, elastic_grid, model_metrics) # 20s
elastic_best_params <- elastic_tuned %>% select_best(metric = "mae")

# Constructing final models
# SVM final model
svm_final_wf <- svm_wf %>% finalize_workflow(svm_best_params)
set.seed(12345)
final_svm_mod <- svm_final_wf %>% fit(data = train_preped)

# XGBoost final model
xgb_final_wf <- xgb_wf %>% finalize_workflow(xgb_best_params)
set.seed(12345)
final_xgb_mod <- xgb_final_wf %>% fit(data = train_preped)

# Random Forest final model
rf_final_wf <- rf_wf %>% finalize_workflow(rf_best_params)
set.seed(12345)
final_rf_mod <- rf_final_wf %>% fit(data = train_preped)

# Lasso final model
lasso_final_wf <- lasso_wf %>% finalize_workflow(lasso_best_params)
set.seed(12345)
final_lasso_mod <- lasso_final_wf %>% fit(data = train_preped)

# Elastic Net final model
elastic_final_wf <- elastic_wf %>% finalize_workflow(elastic_best_params)
set.seed(12345)
final_elastic_mod <- elastic_final_wf %>% fit(data = train_preped)

# Training and test set performance evaluation
# Training set performance
train_metrics <- list(
  SVM = evaluate_model(final_svm_mod, train_preped),
  XGBoost = evaluate_model(final_xgb_mod, train_preped),
  RandomForest = evaluate_model(final_rf_mod, train_preped),
  Lasso = evaluate_model(final_lasso_mod, train_preped),
  ElasticNet = evaluate_model(final_elastic_mod, train_preped)
)

# Test set performance
test_metrics <- list(
  SVM = evaluate_model(final_svm_mod, test_preped),
  XGBoost = evaluate_model(final_xgb_mod, test_preped),
  RandomForest = evaluate_model(final_rf_mod, test_preped),
  Lasso = evaluate_model(final_lasso_mod, test_preped),
  ElasticNet = evaluate_model(final_elastic_mod, test_preped)
)

performance_df <- bind_rows(
  mutate(test_metrics$SVM, Model = "SVM"),
  mutate(test_metrics$XGBoost, Model = "XGBoost"),
  mutate(test_metrics$RandomForest, Model = "Random Forest"),
  mutate(test_metrics$Lasso, Model = "Lasso"),
  mutate(test_metrics$ElasticNet, Model = "Elastic Net")
) %>%
  pivot_wider(
    names_from = .metric, 
    values_from = .estimate
  ) %>%
  mutate(across(c(rmse, mae, rsq), as.numeric))

# Cross-validation performance
model_cv_summary <- analyze_all_models(
  svm_tuned, svm_best_params,
  xgb_tuned, xgb_best_params,
  rf_tuned, rf_best_params,
  lasso_tuned, lasso_best_params,
  elastic_tuned, elastic_best_params
)

```

### xgboost

```{r}

# Preprocessing and Dummy Encoding
hrs_rec <- recipe(fi ~ ., data = train_preped) %>%
  step_dummy(all_factor_predictors(), one_hot = F)

## Cross-Validation Setup
set.seed(12345)
hrs_cv_folds <- rsample::vfold_cv(train_preped, v = 10)

# Model Specification and Hyperparameter Tuning
xgb_mod <- boost_tree(
  trees = tune(), # nrounds
  tree_depth = tune(),
  min_n = tune(),
  loss_reduction = tune(),  
  sample_size = tune(),
  mtry = tune(),
  learn_rate = tune(),
  stop_iter = tune()
  ) %>%
  set_engine("xgboost", objective = "reg:squarederror") %>%
  set_mode("regression")

## Create Hyperparameter Search Grid
set.seed(12345)
xgb_grid <- grid_latin_hypercube(
  trees(),
  tree_depth(), # max_depth
  min_n(), # min_child_weight
  loss_reduction(), # gamma
  sample_size = sample_prop(), # subsample
  finalize(mtry(), train_preped), # colsample_bynode
  learn_rate(),
  stop_iter(),
  size = 100
)

# Create Workflow
xgb_wf <- 
  workflow() %>% 
  add_recipe(hrs_rec) %>%
  add_model(xgb_mod) 

# Parallel Computing for Hyperparameter Tuning
n_cores <- detectCores()
doParallel::registerDoParallel(n_cores/2)

grid_ctrl <-
   control_grid(
     verbose = T,
      save_pred = F,
      parallel_over = NULL,
      save_workflow = F
   )

tic()
set.seed(12345)
xgb_tuned <- tune::tune_grid(
  object = xgb_wf,
  resamples = hrs_cv_folds,
  grid = xgb_grid,
  metrics = yardstick::metric_set(mae, rmse, rsq),
  control = grid_ctrl
)
toc() # 1000 s

## Analyze Tuning Results
### Print all metrics
print(collect_metrics(xgb_tuned), n = 100)

### Visualize hyperparameter impacts
xgb_tuned %>%
  collect_metrics() %>%
  filter(.metric == "mae") %>%
  dplyr::select(mean, mtry:stop_iter) %>%
  pivot_longer(mtry:stop_iter,
               values_to = "value",
               names_to = "parameter"
  ) %>%
  ggplot(aes(value, mean, color = parameter)) +
  geom_point(alpha = 0.8, show.legend = FALSE) +
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "Mean absolute error")

### Select Best Hyperparameters
xgb_best_params <- xgb_tuned %>% 
  tune::select_best(metric = "mae")

mtry_best <- xgb_best_params$mtry
min_n_best <- xgb_best_params$min_n
trees_best <- xgb_best_params$trees
tree_depth_best <- xgb_best_params$tree_depth

opt_hyper_hrs[opt_hyper_hrs$group == "overall", c("mtry", "trees", "min_n", "tree_depth", "learn_rate", "loss_reduction", "sample_size", "stop_iter")] <- xgb_tuned %>% tune::select_best(metric = "mae") %>% dplyr::select(mtry:stop_iter)

### Calculate Cross-Validation Metrics
mae_cv_overall <- xgb_tuned %>%
  collect_metrics(summarize = FALSE) %>%
  filter(mtry == mtry_best & min_n == min_n_best & trees == trees_best & tree_depth == tree_depth_best) %>%
  filter(.metric == "mae") %>%
  pull(.estimate)
skim(mae_cv_overall)

rmse_cv_overall <- xgb_tuned %>%
  collect_metrics(summarize = FALSE) %>%
  filter(mtry == mtry_best & min_n == min_n_best & trees == trees_best & tree_depth == tree_depth_best) %>%
  filter(.metric == "rmse") %>%
  pull(.estimate)
skim(rmse_cv_overall)

rsq_cv_overall <- xgb_tuned %>%
  collect_metrics(summarize = FALSE) %>%
  filter(mtry == mtry_best & min_n == min_n_best & trees == trees_best & tree_depth == tree_depth_best) %>%
  filter(.metric == "rsq") %>%
  pull(.estimate)
skim(rsq_cv_overall)

## Finalize Workflow with Best Parameters
xgb_final_wf <- 
  xgb_wf %>% 
  finalize_workflow(xgb_best_params)

## Fit Final Model
### Fit model on entire training data
set.seed(12345)
final_xgb_mod <- xgb_final_wf %>%
  fit(data = train_preped)

train_preped %>%
  mutate(
    pred = predict(final_xgb_mod, new_data = train_preped, type = "raw")
  ) %>%
  yardstick::metrics(fi, pred) %>%
  mutate(.estimate = format(round(.estimate, 4), big.mark = ","))

test_preped %>%
  mutate(
    pred = predict(final_xgb_mod, new_data = test_preped, type = "raw")
  ) %>%
  yardstick::metrics(fi, pred) %>%
  mutate(.estimate = format(round(.estimate, 4), big.mark = ","))

### Bootstrap Performance Metrics on testing data
options(boot.parallel = "no", boot.ncpus = 1)
set.seed(12345)
tic()
mae_boot_xgb_overall <- boot(data = test_preped, statistic = mae_func, R = 1000, model = final_xgb_mod)
mae_boot_xgb_overall
boot.ci(mae_boot_xgb_overall, type = "norm", conf = 0.95)
toc()

set.seed(12345)
tic()
rmse_boot_xgb_overall <- boot(data = test_preped, statistic = rmse_func, R = 1000, model = final_xgb_mod)
rmse_boot_xgb_overall
boot.ci(rmse_boot_xgb_overall, type = "norm", conf = 0.95)
toc()

set.seed(12345)
tic()
rsq_boot_xgb_overall <- boot(data = test_preped, statistic = rsq_func, R = 1000, model = final_xgb_mod)
rsq_boot_xgb_overall
boot.ci(rsq_boot_xgb_overall, type = "norm", conf = 0.95)
toc()

```

##### SHAP 

```{r}

# Extract model information
xgb_fit_overall <- final_xgb_mod %>% extract_fit_engine()

# Create “shapviz” object
set.seed(12345)
shp_overall <- shapviz(xgb_fit_overall, X_pred = data.matrix(hrs_rec %>% prep() %>% bake(new_data = NULL) %>% dplyr::select(-fi)))

demo <- c("age", "male_male")
ace <- c(
  "famfin", "rafeduc", "rameduc", "movfin_yes", "fmfinh_yes", "faunem_yes", "faunem_never_work", "faunem_not_alive", "radadoccup_bluecollar", "radadoccup_military",
  "schlover_yes", "trpolice_yes", "drkdrug_yes", "phyabuse_yes", "orphanage_yes", "fosterhome_yes", "padivch_yes", "padiech_yes", "sepmom_yes", "sepdad_yes")
ses <- c("raedyrs", "atotb", "itot", "socladder", "raracem_black", "raracem_other", "rahispan_yes", "lbrf_others", "lbrf_retired")
mc <- c("efoodstamp_yes", "enoughfood_yes", "homeown_yes", "hometype_mobilehome", "hometype_onefamily", "hometype_apartment", "hometype_other", "rural_yes", "cenreg_Northeast", "cenreg_Midwest", "cenreg_West", "nnsafety")
socc <- c(
  "mstat_widowed", "mstat_separated", "mstat_never", "hhres",
  "cchild", "csib", "cfriend", 
  "chldcontact", "sibcontact", "friendcontact", 
  "sposupport", "snegsupport", "kposupport", "knegsupport", "oposupport", "onegsupport", "fposupport", "fnegsupport", 
  "care", "playwthchld", "volunteer", "charity", "educourse", "club", "organizations", 
  "pray", "book", "tv", "puzzles", "cards", "writing", "computer", "gardening", "bake", "clothes", 
  "hobby", "sports", "walk", "socrelg_h", "nnphysical", "nnsocial")
stress <- c(
  "pdailydiscrim", "loneliness", 
  "oghealth", "ogphymen", "ogdrug", "ogwork", "ogfis", "oghouse", "ogclose", "oghelp", 
  "ufdis_yes", "ufhire_yes", "ufdenyp_yes", "ufpvmov_yes", "ufdenyb_yes", "ufpolic_yes", "ufdenyh_yes", 
  "chdeathe_yes", "nadise_yes", "combate_yes", "drugcse_yes", "attacke_yes", "lifethe_yes", "lifethcse_yes", 
  "lostjob_yes", "unemployed_yes", "hshdunemployed_yes", "worseresid_yes", "robbed_yes", "fraud_yes", 
  "jail_yes", "longhospital_yes", "combatzone_yes", "military_yes", "homeless_yes")
behav <- c("smokev_yes", "smoken_yes", "drink_yes", "drinkdn", "ltactx", "mdactx", "vgactx", "bmi", "sleep")
hcare <- c("higov_yes", "hipriv_yes", "hiltc_yes", "lifein_yes", "usualcare_yes", "oopmd", "caresat")

var_order <- c(demo, ace, ses, mc, socc, stress, behav, hcare)

var_name <- c(
  "Age",
  "Sex: male",
  
  "Lower family financial situation",
  "Higher father's education", 
  "Higher mother's education",
  "Relocated due to financial difficulties",
  "Family received financial help",
  "Father unemployed: yes",
  "Father unemployed: never worked/always disabled",
  "Father unemployed: never lived with/not alive",
  "Father's occupation: blue collar",
  "Father's occupation: military",
  
  "Repeated school",
  "Trouble with police",
  "Parents used drugs or alcohol",
  "Physically abused",
  "Live in an orphanage",
  "Live in a foster home",
  "Parents separated or divorced",
  "Parents died",
  "Separated from mother",
  "Separated from father",

  "Higher education",
  "Household wealth",
  "Annual household income",
  "Higher subjective social status",
  "Race: black",
  "Race: other", 
  "Hispanic", 
  "Labor force status: other",
  "Labor force status: retired",
  
  "Received food stamps", 
  "Experienced food insecurity",
  "Home ownership",
  "House's type: mobile home",
  "House's type: one-family house",
  "House's type: apartment/townhouse",
  "House's type: other",
  "Live in the rural area",
  "Census region: Northeast",
  "Census region: Midwest", 
  "Census region: West",
  "Neighborhood unsafety",
  
  "Marital status: widowed", 
  "Marital status: separated/divorced",
  "Marital status: never married",
  "Household size",
  "Number of close children",
  "Number of close family members", 
  "Number of close friends",
  "Contact with children",
  "Contact with other family members", 
  "Contact with friends", 
  "Support from spouse", 
  "Strain from spouse",
  "Support from children", 
  "Strain from children", 
  "Support from other family members", 
  "Strain from other family members", 
  "Support from friends",
  "Strain from friends", 
  "Care for a sick adult", 
  "Do activities with grandchildren",
  "Volunteer with children",
  "Do charity work", 
  "Attend an educational course",
  "Go to a sport/social club",
  "Attend meetings of non-religious organizations", 
  "Pray privately",
  "Reading",
  "Watch television",
  "Do word games",
  "Play cards or chess",
  "Writing",
  "Use a computer or email",
  "Maintenance or gardening",
  "Baking or cooking",
  "Knitting",
  "Work on a hobby or project",
  "Play sports or exercise",
  "Walk for ≥20 minutes",
  "Attend religious activities",
  "Neighborhood physical disorder", 
  "Neighborhood social cohesion", 

  "Daily discrimination", 
  "Loneliness",
  "Ongoing health problems", 
  "Ongoing physical/emotional problems", 
  "Ongoing alcohol/drug issues in family member", 
  "Ongoing difficulties at work", 
  "Ongoing financial strain", 
  "Ongoing housing problems", 
  "Ongoing problems in a close relationship",
  "Helping sick family members or friends regularly",
  "Unfairly dismissed from a job",
  "Unfairly not been hired for a job",
  "Unfairly denied a promotion",
  "Unfairly been prevented from moving into a neighborhood",
  "Unfairly denied a bank loan",
  "Unfairly treated by the police",
  "Unfairly denied health care",
  "Experienced the death of a child", 
  "Experienced a natural disaster",
  "Fired a weapon in combat",
  "Partner addicted to drugs/alcohol", 
  "Been a victim of a physical attack",
  "Ever had a life-threatening illness", 
  "Ever had a spouse/child with a life-threatening illness", 
  "Involuntarily lost a job for reasons other than retirement",
  "Unemployed",
  "Anyone else in the household unemployed", 
  "Moved to a worse residence/neighborhood",
  "Robbed/burglarized",
  "Been the victim of fraud",
  "Ever been in a jail",
  "Ever been in long-term hospitalization",
  "Ever lived in a combat zone",
  "Ever lived in military housing",
  "Ever been homeless",
  
  "Ever smoking", 
  "Currently smoking", 
  "Ever drinking any alcohol",
  "Total number of drinks per week", 
  "Light physical activities", 
  "Moderate physical activities", 
  "Vigorous physical activities",
  "Body mass index",
  "Sleep problems", 

  "Government health insurance", 
  "Private health insurance", 
  "Long-term care insurance",
  "Life insurance",
  "Access to routine place for healthcare",
  "Out-of-pocket medical expenditure",
  "Lower healthcare satisfaction"
  )


# SHAP values
shp_imp_var_overall <- sv_importance(shp_overall, max_display = 150)$data %>%
  as_tibble() %>%
  mutate(
    value_normalized = value / sum(value),
    category = case_when(
      feature %in% demo ~ "Demographics",
      feature %in% ace ~ "Adverse Childhood Experiences",
      feature %in% ses ~ "Socioeconomic Status",
      feature %in% mc ~ "Material Circumstances",
      feature %in% socc ~ "Social Connections",
      feature %in% stress ~ "Social Stressors",
      feature %in% behav ~ "Health Behaviors",
      feature %in% hcare ~ "Healthcare Systems"
    ),
    category = factor(category, levels = c("Demographics", "Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems")),
    feature = factor(feature, levels = var_order)
  ) %>%
  arrange(category, feature) %>%
  mutate(var_name = var_name) %>%
  arrange(value)
shp_imp_var_overall$var_name <- factor(shp_imp_var_overall$var_name, levels = shp_imp_var_overall$var_name)

shp_imp_cate_overall <- shp_imp_var_overall %>%
  dplyr::select(value_normalized, category) %>%
  group_by(category) %>%
  summarise(value_normalized = sum(value_normalized)) %>%
  arrange(category) %>%
  arrange(value_normalized)


# Dependence plot
S <- shp_overall[["S"]] %>% # Matrix of SHAP values
  as_tibble() %>%
  dplyr::select(all_of(var_order)) %>%
  data.matrix()
colnames(S) <- var_name

X <- shp_overall[["X"]] %>% # Dataset that includes the corresponding feature values
  dplyr::select(all_of(var_order))
colnames(X) <- var_name

shp_overall_named <- shp_overall
shp_overall_named$S <- S
shp_overall_named$X <- X

sv_imp_overall <- sv_importance(shp_overall_named, max_display = 150)

```

### Environment-wide association study (EWAS)

```{r}

# Variable
ace <- c(
  "famfin", "rafeduc", "rameduc", "movfinyes", "fmfinhyes", "faunemyes", "faunemnever_work", "faunemnot_alive", "radadoccupbluecollar", "radadoccupmilitary",
  "schloveryes", "trpoliceyes", "drkdrugyes", "phyabuseyes", "orphanageyes", "fosterhomeyes", "padivchyes", "padiechyes", "sepmomyes", "sepdadyes")
ses <- c("raedyrs", "atotb", "itot", "socladder", "raracemblack", "raracemother", "rahispanyes", "lbrfothers", "lbrfretired")
mc <- c("efoodstampyes", "enoughfoodyes", "homeownyes", "hometypemobilehome", "hometypeonefamily", "hometypeapartment", "hometypeother", "ruralyes", "cenregNortheast", "cenregMidwest", "cenregWest", "nnsafety")
socc <- c(
  "mstatwidowed", "mstatseparated", "mstatnever", "hhres",
  "cchild", "csib", "cfriend", 
  "chldcontact", "sibcontact", "friendcontact", 
  "sposupport", "snegsupport", "kposupport", "knegsupport", "oposupport", "onegsupport", "fposupport", "fnegsupport", 
  "care", "playwthchld", "volunteer", "charity", "educourse", "club", "organizations", 
  "pray", "book", "tv", "puzzles", "cards", "writing", "computer", "gardening", "bake", "clothes", 
  "hobby", "sports", "walk", "socrelg_h", "nnphysical", "nnsocial")
stress <- c(
  "pdailydiscrim", "loneliness", 
  "oghealth", "ogphymen", "ogdrug", "ogwork", "ogfis", "oghouse", "ogclose", "oghelp", 
  "ufdisyes", "ufhireyes", "ufdenypyes", "ufpvmovyes", "ufdenybyes", "ufpolicyes", "ufdenyhyes", 
  "chdeatheyes", "nadiseyes", "combateyes", "drugcseyes", "attackeyes", "lifetheyes", "lifethcseyes", 
  "lostjobyes", "unemployedyes", "hshdunemployedyes", "worseresidyes", "robbedyes", "fraudyes", 
  "jailyes", "longhospitalyes", "combatzoneyes", "militaryyes", "homelessyes")
behav <- c("smokevyes", "smokenyes", "drinkyes", "drinkdn", "ltactx", "mdactx", "vgactx", "bmi", "sleep")
hcare <- c("higovyes", "hiprivyes", "hiltcyes", "lifeinyes", "usualcareyes", "oopmd", "caresat")

# Variable information
var_name <- c(
  "Lower family financial situation",
  "Higher father's education", 
  "Higher mother's education",
  "Relocated due to financial difficulties",
  "Family received financial help",
  "Father unemployed: yes",
  "Father unemployed: never worked/always disabled",
  "Father unemployed: never lived with/not alive",
  "Father's occupation: blue collar",
  "Father's occupation: military",
  
  "Repeated school",
  "Trouble with police",
  "Parents used drugs or alcohol",
  "Physically abused",
  "Live in an orphanage",
  "Live in a foster home",
  "Parents separated or divorced",
  "Parents died",
  "Separated from mother",
  "Separated from father",

  "Higher education",
  "Household wealth",
  "Annual household income",
  "Higher subjective social status",
  "Race: black",
  "Race: other", 
  "Hispanic", 
  "Labor force status: other",
  "Labor force status: partly retired/retired",
  
  "Received food stamps", 
  "Experienced food insecurity",
  "Home ownership",
  "House's type: mobile home",
  "House's type: one-family house",
  "House's type: apartment/townhouse",
  "House's type: other",
  "Live in the rural area",
  "Census region: Northeast",
  "Census region: Midwest", 
  "Census region: West",
  "Neighborhood unsafety",
  
  "Marital status: widowed", 
  "Marital status: separated/divorced",
  "Marital status: never married",
  "Household size",
  "Number of close children",
  "Number of close family members", 
  "Number of close friends",
  "Contact with children",
  "Contact with other family members", 
  "Contact with friends", 
  "Support from spouse", 
  "Strain from spouse",
  "Support from children", 
  "Strain from children", 
  "Support from other family members", 
  "Strain from other family members", 
  "Support from friends",
  "Strain from friends", 
  "Care for a sick adult", 
  "Do activities with grandchildren",
  "Volunteer with children",
  "Do charity work", 
  "Attend an educational course",
  "Go to a sport/social club",
  "Attend meetings of non-religious organizations", 
  "Pray privately",
  "Reading",
  "Watch television",
  "Do word games",
  "Play cards or chess",
  "Writing",
  "Use a computer or email",
  "Maintenance or gardening",
  "Baking or cooking",
  "Knitting",
  "Work on a hobby or project",
  "Play sports or exercise",
  "Walk for ≥20 minutes",
  "Attend religious activities",
  "Neighborhood physical disorder", 
  "Neighborhood social cohesion", 

  "Daily discrimination", 
  "Loneliness",
  "Ongoing health problems", 
  "Ongoing physical/emotional problems", 
  "Ongoing alcohol/drug issues in family member", 
  "Ongoing difficulties at work", 
  "Ongoing financial strain", 
  "Ongoing housing problems", 
  "Ongoing problems in a close relationship",
  "Helping sick family members or friends regularly",
  "Unfairly dismissed from a job",
  "Unfairly not been hired for a job",
  "Unfairly denied a promotion",
  "Unfairly been prevented from moving into a neighborhood",
  "Unfairly denied a bank loan",
  "Unfairly treated by the police",
  "Unfairly denied health care",
  "Experienced the death of a child", 
  "Experienced a natural disaster",
  "Fired a weapon in combat",
  "Partner addicted to drugs/alcohol", 
  "Been a victim of a physical attack",
  "Ever had a life-threatening illness", 
  "Ever had a spouse/child with a life-threatening illness", 
  "Involuntarily lost a job for reasons other than retirement",
  "Unemployed",
  "Anyone else in the household unemployed", 
  "Moved to a worse residence/neighborhood",
  "Robbed/burglarized",
  "Been the victim of fraud",
  "Ever been in a jail",
  "Ever been in long-term hospitalization",
  "Ever lived in a combat zone",
  "Ever lived in military housing",
  "Ever been homeless",
  
  "Ever smoking", 
  "Currently smoking", 
  "Ever drinking any alcohol",
  "Total number of drinks per week", 
  "Light physical activities", 
  "Moderate physical activities", 
  "Vigorous physical activities",
  "Body mass index",
  "Sleep problems", 

  "Government health insurance", 
  "Private health insurance", 
  "Long-term care insurance",
  "Life insurance",
  "Access to routine place for healthcare",
  "Out-of-pocket medical expenditure",
  "Lower healthcare satisfaction"
  )

var_mapping <- data.frame(term = c(
  ace, ses, mc, socc, stress, behav, hcare
), var_name = var_name)



# EWAS
train_results <- environmental_wide_association_study(train_baked) %>%
  left_join(var_mapping, by = "term") %>%
  mutate(
    category = case_when(
      term %in% ace ~ "Adverse Childhood Experiences",
      term %in% ses ~ "Socioeconomic Status",
      term %in% mc ~ "Material Circumstances",
      term %in% socc ~ "Social Connections",
      term %in% stress ~ "Social Stressors",
      term %in% behav ~ "Health Behaviors",
      term %in% hcare ~ "Healthcare Systems"
    ),
    category = factor(category, levels = c("Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems")),
    neg_log_p = -log10(p.value),
    fdr = p.adjust(p.value, method = "BH"),
    significant  = ifelse(fdr < 0.05, 1, 0)
    )
test_results <- environmental_wide_association_study(test_baked) %>%
  left_join(var_mapping, by = "term") %>%
  mutate(
    category = case_when(
      term %in% ace ~ "Adverse Childhood Experiences",
      term %in% ses ~ "Socioeconomic Status",
      term %in% mc ~ "Material Circumstances",
      term %in% socc ~ "Social Connections",
      term %in% stress ~ "Social Stressors",
      term %in% behav ~ "Health Behaviors",
      term %in% hcare ~ "Healthcare Systems"
    ),
    category = factor(category, levels = c("Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems")),
    neg_log_p = -log10(p.value),
    fdr = NA,
    significant  = ifelse(p.value < 0.05, 1, 0),
    )

## Significant variables in both training and testing data
train_significant_vars <- train_results %>%
  filter(significant == 1) %>%
  pull(term)

test_significant_vars <- test_results %>%
  filter(significant == 1) %>%
  pull(term)

consistent_significant_vars <- intersect(train_significant_vars, test_significant_vars)

train_consistent_results <- train_results %>%
  filter(var %in% consistent_significant_vars)

test_consistent_results <- test_results %>%
  filter(var %in% consistent_significant_vars)

combined_results <- full_join(
  train_consistent_results %>% 
    rename(train_estimate = estimate, 
           train_std_error = std.error, 
           train_p_value = p.value,
           train_neg_log_p = neg_log_p,
           train_fdr = fdr,
           train_significant = significant),
  test_consistent_results %>% 
    dplyr::select(-c(var, var_name, category)) %>%
    rename(test_estimate = estimate, 
           test_std_error = std.error, 
           test_p_value = p.value,
           test_neg_log_p = neg_log_p,
           test_fdr = fdr,
           test_significant = significant),
  by = "term"
)

```

## Male

### Data preparation

```{r}

# Train-test split
data <- final %>%
  filter(male == "male" & fi_b < 0.2) %>%
  dplyr::select(
    age, #male, 
    famfin, rameduc, rafeduc, movfin, fmfinh, faunem, radadoccup, 
    schlover, trpolice, drkdrug, phyabuse, 
    orphanage, fosterhome, padivch, padiech, sepmom, sepdad,
    raedyrs, atotb, itot, socladder, raracem, rahispan, lbrf, 
    efoodstamp, enoughfood, homeown, hometype, rural, cenreg, nnsafety, 
    mstat, hhres, cchild, csib, cfriend, chldcontact, sibcontact, friendcontact, 
    sposupport, kposupport, oposupport, fposupport, 
    snegsupport, knegsupport, onegsupport, fnegsupport, 
    care, playwthchld, volunteer, charity, educourse, club, organizations, pray, book, tv, 
    puzzles, cards, writing, computer, gardening, bake, clothes, hobby, sports, walk, socrelg_h, 
    nnphysical, nnsocial,
    pdailydiscrim, loneliness,
    oghealth, ogphymen, ogdrug, ogwork, ogfis, oghouse, ogclose, oghelp,
    ufdis, ufhire, ufdenyp, ufpvmov, ufdenyb, ufpolic, ufdenyh,
    chdeathe, nadise, combate, drugcse, attacke, lifethe, lifethcse, 
    lostjob, unemployed, hshdunemployed, worseresid, robbed, fraud, 
    jail, longhospital, combatzone, military, homeless,
    smokev, smoken, drink, drinkdn, ltactx, mdactx, vgactx, bmi, sleep,
    higov, hipriv, hiltc, lifein, usualcare, oopmd, caresat, 
    fi)

set.seed(12345)
hrs_split <- initial_split(data, prop = 0.8)
train_hrs <- training(hrs_split)
test_hrs  <- testing(hrs_split)

# Missing value imputation
tic()
train_preped <- missRanger(train_hrs %>% dplyr::select(!fi), . ~ ., pmm.k = 5, maxiter = 10, num.trees = 100, returnOOB = T, verbose = 1, seed = 12345)
toc() # 16 s
train_preped$fi <- train_hrs$fi

tic()
test_preped <- missRanger(test_hrs %>% dplyr::select(!fi), . ~ ., pmm.k = 5, maxiter = 10, num.trees = 100, returnOOB = T, verbose = 1, seed = 12345)
toc() # 11 s
test_preped$fi <- test_hrs$fi

#### Save data for GA2M ####
train_baked <- recipe(fi ~ ., data = train_preped) %>%
  prep() %>%
  bake(new_data = NULL) %>%
  dplyr::select(!fi, fi)

test_baked <- recipe(fi ~ ., data = test_preped) %>%
  prep() %>%
  bake(new_data = NULL) %>%
  dplyr::select(!fi, fi)

write.csv(train_baked, file = "train_baked_male_hrs.csv", row.names = F)
write.csv(test_baked, file = "test_baked_male_hrs.csv", row.names = F)

```

### xgboost

```{r}

# Preprocessing and Dummy Encoding
hrs_rec <- recipe(fi ~ ., data = train_preped) %>%
  step_dummy(all_factor_predictors(), one_hot = F)

## Cross-Validation Setup
set.seed(12345)
hrs_cv_folds <- rsample::vfold_cv(train_preped, v = 10)

# Model Specification and Hyperparameter Tuning
xgb_mod <- boost_tree(
  trees = tune(), # nrounds
  tree_depth = tune(),
  min_n = tune(),
  loss_reduction = tune(),  
  sample_size = tune(),
  mtry = tune(),
  learn_rate = tune(),
  stop_iter = tune()
  ) %>%
  set_engine("xgboost", objective = "reg:squarederror") %>%
  set_mode("regression")

## Create Hyperparameter Search Grid
set.seed(12345)
xgb_grid <- grid_latin_hypercube(
  trees(),
  tree_depth(), # max_depth
  min_n(), # min_child_weight
  loss_reduction(), # gamma
  sample_size = sample_prop(), # subsample
  finalize(mtry(), train_preped), # colsample_bynode
  learn_rate(),
  stop_iter(),
  size = 100
)

# Create Workflow
xgb_wf <- 
  workflow() %>% 
  add_recipe(hrs_rec) %>%
  add_model(xgb_mod) 

# Parallel Computing for Hyperparameter Tuning
n_cores <- detectCores()
doParallel::registerDoParallel(n_cores/2)

grid_ctrl <-
   control_grid(
     verbose = T,
      save_pred = F,
      parallel_over = NULL,
      save_workflow = F
   )

tic()
set.seed(12345)
xgb_tuned <- tune::tune_grid(
  object = xgb_wf,
  resamples = hrs_cv_folds,
  grid = xgb_grid,
  metrics = yardstick::metric_set(mae, rmse, rsq),
  control = grid_ctrl
)
toc() # 200 s

## Analyze Tuning Results
### Print all metrics
print(collect_metrics(xgb_tuned), n = 100)

### Visualize hyperparameter impacts
xgb_tuned %>%
  collect_metrics() %>%
  filter(.metric == "mae") %>%
  dplyr::select(mean, mtry:stop_iter) %>%
  pivot_longer(mtry:stop_iter,
               values_to = "value",
               names_to = "parameter"
  ) %>%
  ggplot(aes(value, mean, color = parameter)) +
  geom_point(alpha = 0.8, show.legend = FALSE) +
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "Mean absolute error")

### Select Best Hyperparameters
xgb_best_params <- xgb_tuned %>% 
  tune::select_best(metric = "mae")

mtry_best <- xgb_best_params$mtry
min_n_best <- xgb_best_params$min_n
trees_best <- xgb_best_params$trees
tree_depth_best <- xgb_best_params$tree_depth

opt_hyper_hrs[opt_hyper_hrs$group == "male", c("mtry", "trees", "min_n", "tree_depth", "learn_rate", "loss_reduction", "sample_size", "stop_iter")] <- xgb_tuned %>% tune::select_best(metric = "mae") %>% dplyr::select(mtry:stop_iter)

### Calculate Cross-Validation Metrics
mae_cv_male <- xgb_tuned %>%
  collect_metrics(summarize = FALSE) %>%
  filter(mtry == mtry_best & min_n == min_n_best & trees == trees_best & tree_depth == tree_depth_best) %>%
  filter(.metric == 'mae') %>%
  pull(.estimate)
skim(mae_cv_male)

rmse_cv_male <- xgb_tuned %>%
  collect_metrics(summarize = FALSE) %>%
  filter(mtry == mtry_best & min_n == min_n_best & trees == trees_best & tree_depth == tree_depth_best) %>%
  filter(.metric == 'rmse') %>%
  pull(.estimate)
skim(rmse_cv_male)

rsq_cv_male <- xgb_tuned %>%
  collect_metrics(summarize = FALSE) %>%
  filter(mtry == mtry_best & min_n == min_n_best & trees == trees_best & tree_depth == tree_depth_best) %>%
  filter(.metric == 'rsq') %>%
  pull(.estimate)
skim(rsq_cv_male)


## Finalize Workflow with Best Parameters
xgb_final_wf <- 
  xgb_wf %>% 
  finalize_workflow(xgb_best_params)

## Fit Final Model
### Fit model on entire training data
set.seed(12345)
final_xgb_mod <- xgb_final_wf %>%
  fit(data = train_preped)

### Bootstrap Performance Metrics on testing data
options(boot.parallel = "no", boot.ncpus = 1)
set.seed(12345)
tic()
mae_boot_xgb_male <- boot(data = test_preped, statistic = mae_func, R = 1000, model = final_xgb_mod)
print(mae_boot_xgb_male)
toc()

set.seed(12345)
tic()
rmse_boot_xgb_male <- boot(data = test_preped, statistic = rmse_func, R = 1000, model = final_xgb_mod)
print(rmse_boot_xgb_male)
toc()

set.seed(12345)
tic()
rsq_boot_xgb_male <- boot(data = test_preped, statistic = rsq_func, R = 1000, model = final_xgb_mod)
print(rsq_boot_xgb_male)
toc()

```

##### SHAP 

```{r}

# Extract model information
xgb_fit_male <- final_xgb_mod %>% extract_fit_engine()

# Create “shapviz” object
set.seed(12345)
shp_male <- shapviz(xgb_fit_male, X_pred = data.matrix(hrs_rec %>% prep() %>% bake(new_data = NULL) %>% dplyr::select(-fi)))

demo <- c("age")
ace <- c(
  "famfin", "rafeduc", "rameduc", "movfin_yes", "fmfinh_yes", "faunem_yes", "faunem_never_work", "faunem_not_alive", "radadoccup_bluecollar", "radadoccup_military",
  "schlover_yes", "trpolice_yes", "drkdrug_yes", "phyabuse_yes", "orphanage_yes", "fosterhome_yes", "padivch_yes", "padiech_yes", "sepmom_yes", "sepdad_yes")
ses <- c("raedyrs", "atotb", "itot", "socladder", "raracem_black", "raracem_other", "rahispan_yes", "lbrf_others", "lbrf_retired")
mc <- c("efoodstamp_yes", "enoughfood_yes", "homeown_yes", "hometype_mobilehome", "hometype_onefamily", "hometype_apartment", "hometype_other", "rural_yes", "cenreg_Northeast", "cenreg_Midwest", "cenreg_West", "nnsafety")
socc <- c(
  "mstat_widowed", "mstat_separated", "mstat_never", "hhres",
  "cchild", "csib", "cfriend", 
  "chldcontact", "sibcontact", "friendcontact", 
  "sposupport", "snegsupport", "kposupport", "knegsupport", "oposupport", "onegsupport", "fposupport", "fnegsupport", 
  "care", "playwthchld", "volunteer", "charity", "educourse", "club", "organizations", 
  "pray", "book", "tv", "puzzles", "cards", "writing", "computer", "gardening", "bake", "clothes", 
  "hobby", "sports", "walk", "socrelg_h", "nnphysical", "nnsocial")
stress <- c(
  "pdailydiscrim", "loneliness", 
  "oghealth", "ogphymen", "ogdrug", "ogwork", "ogfis", "oghouse", "ogclose", "oghelp", 
  "ufdis_yes", "ufhire_yes", "ufdenyp_yes", "ufpvmov_yes", "ufdenyb_yes", "ufpolic_yes", "ufdenyh_yes", 
  "chdeathe_yes", "nadise_yes", "combate_yes", "drugcse_yes", "attacke_yes", "lifethe_yes", "lifethcse_yes", 
  "lostjob_yes", "unemployed_yes", "hshdunemployed_yes", "worseresid_yes", "robbed_yes", "fraud_yes", 
  "jail_yes", "longhospital_yes", "combatzone_yes", "military_yes", "homeless_yes")
behav <- c("smokev_yes", "smoken_yes", "drink_yes", "drinkdn", "ltactx", "mdactx", "vgactx", "bmi", "sleep")
hcare <- c("higov_yes", "hipriv_yes", "hiltc_yes", "lifein_yes", "usualcare_yes", "oopmd", "caresat")

var_order <- c(demo, ace, ses, mc, socc, stress, behav, hcare)

var_name <- c(
  "Age",

  "Lower family financial situation",
  "Higher father's education", 
  "Higher mother's education",
  "Relocated due to financial difficulties",
  "Family received financial help",
  "Father unemployed: yes",
  "Father unemployed: never worked/always disabled",
  "Father unemployed: never lived with/not alive",
  "Father's occupation: blue collar",
  "Father's occupation: military",
  
  "Repeated school",
  "Trouble with police",
  "Parents used drugs or alcohol",
  "Physically abused",
  "Live in an orphanage",
  "Live in a foster home",
  "Parents separated or divorced",
  "Parents died",
  "Separated from mother",
  "Separated from father",

  "Higher education",
  "Household wealth",
  "Annual household income",
  "Higher subjective social status",
  "Race: black",
  "Race: other", 
  "Hispanic", 
  "Labor force status: other",
  "Labor force status: retired",
  
  "Received food stamps", 
  "Experienced food insecurity",
  "Home ownership",
  "House's type: mobile home",
  "House's type: one-family house",
  "House's type: apartment/townhouse",
  "House's type: other",
  "Live in the rural area",
  "Census region: Northeast",
  "Census region: Midwest", 
  "Census region: West",
  "Neighborhood unsafety",
  
  "Marital status: widowed", 
  "Marital status: separated/divorced",
  "Marital status: never married",
  "Household size",
  "Number of close children",
  "Number of close family members", 
  "Number of close friends",
  "Contact with children",
  "Contact with other family members", 
  "Contact with friends", 
  "Support from spouse", 
  "Strain from spouse",
  "Support from children", 
  "Strain from children", 
  "Support from other family members", 
  "Strain from other family members", 
  "Support from friends",
  "Strain from friends", 
  "Care for a sick adult", 
  "Do activities with grandchildren",
  "Volunteer with children",
  "Do charity work", 
  "Attend an educational course",
  "Go to a sport/social club",
  "Attend meetings of non-religious organizations", 
  "Pray privately",
  "Reading",
  "Watch television",
  "Do word games",
  "Play cards or chess",
  "Writing",
  "Use a computer or email",
  "Maintenance or gardening",
  "Baking or cooking",
  "Knitting",
  "Work on a hobby or project",
  "Play sports or exercise",
  "Walk for ≥20 minutes",
  "Attend religious activities",
  "Neighborhood physical disorder", 
  "Neighborhood social cohesion", 

  "Daily discrimination", 
  "Loneliness",
  "Ongoing health problems", 
  "Ongoing physical/emotional problems", 
  "Ongoing alcohol/drug issues in family member", 
  "Ongoing difficulties at work", 
  "Ongoing financial strain", 
  "Ongoing housing problems", 
  "Ongoing problems in a close relationship",
  "Helping sick family members or friends regularly",
  "Unfairly dismissed from a job",
  "Unfairly not been hired for a job",
  "Unfairly denied a promotion",
  "Unfairly been prevented from moving into a neighborhood",
  "Unfairly denied a bank loan",
  "Unfairly treated by the police",
  "Unfairly denied health care",
  "Experienced the death of a child", 
  "Experienced a natural disaster",
  "Fired a weapon in combat",
  "Partner addicted to drugs/alcohol", 
  "Been a victim of a physical attack",
  "Ever had a life-threatening illness", 
  "Ever had a spouse/child with a life-threatening illness", 
  "Involuntarily lost a job for reasons other than retirement",
  "Unemployed",
  "Anyone else in the household unemployed", 
  "Moved to a worse residence/neighborhood",
  "Robbed/burglarized",
  "Been the victim of fraud",
  "Ever been in a jail",
  "Ever been in long-term hospitalization",
  "Ever lived in a combat zone",
  "Ever lived in military housing",
  "Ever been homeless",
  
  "Ever smoking", 
  "Currently smoking", 
  "Ever drinking any alcohol",
  "Total number of drinks per week", 
  "Light physical activities", 
  "Moderate physical activities", 
  "Vigorous physical activities",
  "Body mass index",
  "Sleep problems", 

  "Government health insurance", 
  "Private health insurance", 
  "Long-term care insurance",
  "Life insurance",
  "Access to routine place for healthcare",
  "Out-of-pocket medical expenditure",
  "Lower healthcare satisfaction"
  )


# SHAP values
shp_imp_var_male <- sv_importance(shp_male, max_display = 150)$data %>%
  as_tibble() %>%
  mutate(
    value_normalized = value / sum(value),
    category = case_when(
      feature %in% demo ~ "Demographics",
      feature %in% ace ~ "Adverse Childhood Experiences",
      feature %in% ses ~ "Socioeconomic Status",
      feature %in% mc ~ "Material Circumstances",
      feature %in% socc ~ "Social Connections",
      feature %in% stress ~ "Social Stressors",
      feature %in% behav ~ "Health Behaviors",
      feature %in% hcare ~ "Healthcare Systems"
    ),
    category = factor(category, levels = c("Demographics", "Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems")),
    feature = factor(feature, levels = var_order)
  ) %>%
  arrange(category, feature) %>%
  mutate(var_name = var_name) %>%
  arrange(value)
shp_imp_var_male$var_name <- factor(shp_imp_var_male$var_name, levels = shp_imp_var_male$var_name)

shp_imp_cate_male <- shp_imp_var_male %>%
  dplyr::select(value_normalized, category) %>%
  group_by(category) %>%
  summarise(value_normalized = sum(value_normalized)) %>%
  arrange(category) %>%
  arrange(value_normalized)


# Dependence plot
S <- shp_male[["S"]] %>% # Matrix of SHAP values
  as_tibble() %>%
  dplyr::select(all_of(var_order)) %>%
  data.matrix()
colnames(S) <- var_name

X <- shp_male[["X"]] %>% # Dataset that includes the corresponding feature values
  dplyr::select(all_of(var_order))
colnames(X) <- var_name

shp_male_named <- shp_male
shp_male_named$S <- S
shp_male_named$X <- X

sv_imp_male <- sv_importance(shp_male_named, max_display = 150)

```

## Female

### Data preparation

```{r}

# Train-test split
data <- final %>%
  filter(male == "female" & fi_b < 0.2) %>%
  dplyr::select(
    age, #male, 
    famfin, rameduc, rafeduc, movfin, fmfinh, faunem, radadoccup, 
    schlover, trpolice, drkdrug, phyabuse, 
    orphanage, fosterhome, padivch, padiech, sepmom, sepdad,
    raedyrs, atotb, itot, socladder, raracem, rahispan, lbrf, 
    efoodstamp, enoughfood, homeown, hometype, rural, cenreg, nnsafety, 
    mstat, hhres, cchild, csib, cfriend, chldcontact, sibcontact, friendcontact, 
    sposupport, kposupport, oposupport, fposupport, 
    snegsupport, knegsupport, onegsupport, fnegsupport, 
    care, playwthchld, volunteer, charity, educourse, club, organizations, pray, book, tv, 
    puzzles, cards, writing, computer, gardening, bake, clothes, hobby, sports, walk, socrelg_h, 
    nnphysical, nnsocial,
    pdailydiscrim, loneliness,
    oghealth, ogphymen, ogdrug, ogwork, ogfis, oghouse, ogclose, oghelp,
    ufdis, ufhire, ufdenyp, ufpvmov, ufdenyb, ufpolic, ufdenyh,
    chdeathe, nadise, combate, drugcse, attacke, lifethe, lifethcse, 
    lostjob, unemployed, hshdunemployed, worseresid, robbed, fraud, 
    jail, longhospital, combatzone, military, homeless,
    smokev, smoken, drink, drinkdn, ltactx, mdactx, vgactx, bmi, sleep,
    higov, hipriv, hiltc, lifein, usualcare, oopmd, caresat, 
    fi)

set.seed(12345)
hrs_split <- initial_split(data, prop = 0.8)
train_hrs <- training(hrs_split)
test_hrs  <- testing(hrs_split)

# Missing value imputation
tic()
train_preped <- missRanger(train_hrs %>% dplyr::select(!fi), . ~ ., pmm.k = 5, maxiter = 10, num.trees = 100, returnOOB = T, verbose = 1, seed = 12345)
toc() # 22 s
train_preped$fi <- train_hrs$fi

tic()
test_preped <- missRanger(test_hrs %>% dplyr::select(!fi), . ~ ., pmm.k = 5, maxiter = 10, num.trees = 100, returnOOB = T, verbose = 1, seed = 12345)
toc() # 8 s
test_preped$fi <- test_hrs$fi

#### Save data for GA2M ####
train_baked <- recipe(fi ~ ., data = train_preped) %>%
  prep() %>%
  bake(new_data = NULL) %>%
  dplyr::select(!fi, fi)

test_baked <- recipe(fi ~ ., data = test_preped) %>%
  prep() %>%
  bake(new_data = NULL) %>%
  dplyr::select(!fi, fi)

write.csv(train_baked, file = "train_baked_female_hrs.csv", row.names = F)
write.csv(test_baked, file = "test_baked_female_hrs.csv", row.names = F)

```

### xgboost

```{r}

# Preprocessing and Dummy Encoding
hrs_rec <- recipe(fi ~ ., data = train_preped) %>%
  step_dummy(all_factor_predictors(), one_hot = F)

## Cross-Validation Setup
set.seed(12345)
hrs_cv_folds <- rsample::vfold_cv(train_preped, v = 10)

# Model Specification and Hyperparameter Tuning
xgb_mod <- boost_tree(
  trees = tune(), # nrounds
  tree_depth = tune(),
  min_n = tune(),
  loss_reduction = tune(),  
  sample_size = tune(),
  mtry = tune(),
  learn_rate = tune(),
  stop_iter = tune()
  ) %>%
  set_engine("xgboost", objective = "reg:squarederror") %>%
  set_mode("regression")

## Create Hyperparameter Search Grid
set.seed(12345)
xgb_grid <- grid_latin_hypercube(
  trees(),
  tree_depth(), # max_depth
  min_n(), # min_child_weight
  loss_reduction(), # gamma
  sample_size = sample_prop(), # subsample
  finalize(mtry(), train_preped), # colsample_bynode
  learn_rate(),
  stop_iter(),
  size = 100
)

# Create Workflow
xgb_wf <- 
  workflow() %>% 
  add_recipe(hrs_rec) %>%
  add_model(xgb_mod) 

# Parallel Computing for Hyperparameter Tuning
n_cores <- detectCores()
doParallel::registerDoParallel(n_cores/2)

grid_ctrl <-
   control_grid(
     verbose = T,
      save_pred = F,
      parallel_over = NULL,
      save_workflow = F
   )

tic()
set.seed(12345)
xgb_tuned <- tune::tune_grid(
  object = xgb_wf,
  resamples = hrs_cv_folds,
  grid = xgb_grid,
  metrics = yardstick::metric_set(mae, rmse, rsq),
  control = grid_ctrl
)
toc() # 4500 s

## Analyze Tuning Results
### Print all metrics
print(collect_metrics(xgb_tuned), n = 100)

### Visualize hyperparameter impacts
xgb_tuned %>%
  collect_metrics() %>%
  filter(.metric == "mae") %>%
  dplyr::select(mean, mtry:stop_iter) %>%
  pivot_longer(mtry:stop_iter,
               values_to = "value",
               names_to = "parameter"
  ) %>%
  ggplot(aes(value, mean, color = parameter)) +
  geom_point(alpha = 0.8, show.legend = FALSE) +
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "Mean absolute error")

### Select Best Hyperparameters
xgb_best_params <- xgb_tuned %>% 
  tune::select_best(metric = "mae")

mtry_best <- xgb_best_params$mtry
min_n_best <- xgb_best_params$min_n
trees_best <- xgb_best_params$trees
tree_depth_best <- xgb_best_params$tree_depth

opt_hyper_hrs[opt_hyper_hrs$group == "female", c("mtry", "trees", "min_n", "tree_depth", "learn_rate", "loss_reduction", "sample_size", "stop_iter")] <- xgb_tuned %>% tune::select_best(metric = "mae") %>% dplyr::select(mtry:stop_iter)

### Calculate Cross-Validation Metrics
mae_cv_female <- xgb_tuned %>%
  collect_metrics(summarize = FALSE) %>%
  filter(mtry == mtry_best & min_n == min_n_best & trees == trees_best & tree_depth == tree_depth_best) %>%
  filter(.metric == 'mae') %>%
  pull(.estimate)
skim(mae_cv_female)

rmse_cv_female <- xgb_tuned %>%
  collect_metrics(summarize = FALSE) %>%
  filter(mtry == mtry_best & min_n == min_n_best & trees == trees_best & tree_depth == tree_depth_best) %>%
  filter(.metric == 'rmse') %>%
  pull(.estimate)
skim(rmse_cv_female)

rsq_cv_female <- xgb_tuned %>%
  collect_metrics(summarize = FALSE) %>%
  filter(mtry == mtry_best & min_n == min_n_best & trees == trees_best & tree_depth == tree_depth_best) %>%
  filter(.metric == 'rsq') %>%
  pull(.estimate)
skim(rsq_cv_female)

## Finalize Workflow with Best Parameters
xgb_final_wf <- 
  xgb_wf %>% 
  finalize_workflow(xgb_best_params)

## Fit Final Model
### Fit model on entire training data
set.seed(12345)
final_xgb_mod <- xgb_final_wf %>%
  fit(data = train_preped)

### Bootstrap Performance Metrics on testing data
options(boot.parallel = "no", boot.ncpus = 1)
set.seed(12345)
tic()
mae_boot_xgb_female <- boot(data = test_preped, statistic = mae_func, R = 1000, model = final_xgb_mod)
print(mae_boot_xgb_female)
toc()

set.seed(12345)
tic()
rmse_boot_xgb_female <- boot(data = test_preped, statistic = rmse_func, R = 1000, model = final_xgb_mod)
print(rmse_boot_xgb_female)
toc()

set.seed(12345)
tic()
rsq_boot_xgb_female <- boot(data = test_preped, statistic = rsq_func, R = 1000, model = final_xgb_mod)
print(rsq_boot_xgb_female)
toc()

```

##### SHAP 

```{r}

# Extract model information
xgb_fit_female <- final_xgb_mod %>% extract_fit_engine()

# Create “shapviz” object
set.seed(12345)
shp_female <- shapviz(xgb_fit_female, X_pred = data.matrix(hrs_rec %>% prep() %>% bake(new_data = NULL) %>% dplyr::select(-fi)))

demo <- c("age")
ace <- c(
  "famfin", "rafeduc", "rameduc", "movfin_yes", "fmfinh_yes", "faunem_yes", "faunem_never_work", "faunem_not_alive", "radadoccup_bluecollar", "radadoccup_military",
  "schlover_yes", "trpolice_yes", "drkdrug_yes", "phyabuse_yes", "orphanage_yes", "fosterhome_yes", "padivch_yes", "padiech_yes", "sepmom_yes", "sepdad_yes")
ses <- c("raedyrs", "atotb", "itot", "socladder", "raracem_black", "raracem_other", "rahispan_yes", "lbrf_others", "lbrf_retired")
mc <- c("efoodstamp_yes", "enoughfood_yes", "homeown_yes", "hometype_mobilehome", "hometype_onefamily", "hometype_apartment", "hometype_other", "rural_yes", "cenreg_Northeast", "cenreg_Midwest", "cenreg_West", "nnsafety")
socc <- c(
  "mstat_widowed", "mstat_separated", "mstat_never", "hhres",
  "cchild", "csib", "cfriend", 
  "chldcontact", "sibcontact", "friendcontact", 
  "sposupport", "snegsupport", "kposupport", "knegsupport", "oposupport", "onegsupport", "fposupport", "fnegsupport", 
  "care", "playwthchld", "volunteer", "charity", "educourse", "club", "organizations", 
  "pray", "book", "tv", "puzzles", "cards", "writing", "computer", "gardening", "bake", "clothes", 
  "hobby", "sports", "walk", "socrelg_h", "nnphysical", "nnsocial")
stress <- c(
  "pdailydiscrim", "loneliness", 
  "oghealth", "ogphymen", "ogdrug", "ogwork", "ogfis", "oghouse", "ogclose", "oghelp", 
  "ufdis_yes", "ufhire_yes", "ufdenyp_yes", "ufpvmov_yes", "ufdenyb_yes", "ufpolic_yes", "ufdenyh_yes", 
  "chdeathe_yes", "nadise_yes", "combate_yes", "drugcse_yes", "attacke_yes", "lifethe_yes", "lifethcse_yes", 
  "lostjob_yes", "unemployed_yes", "hshdunemployed_yes", "worseresid_yes", "robbed_yes", "fraud_yes", 
  "jail_yes", "longhospital_yes", "combatzone_yes", "military_yes", "homeless_yes")
behav <- c("smokev_yes", "smoken_yes", "drink_yes", "drinkdn", "ltactx", "mdactx", "vgactx", "bmi", "sleep")
hcare <- c("higov_yes", "hipriv_yes", "hiltc_yes", "lifein_yes", "usualcare_yes", "oopmd", "caresat")

var_order <- c(demo, ace, ses, mc, socc, stress, behav, hcare)

var_name <- c(
  "Age",

  "Lower family financial situation",
  "Higher father's education", 
  "Higher mother's education",
  "Relocated due to financial difficulties",
  "Family received financial help",
  "Father unemployed: yes",
  "Father unemployed: never worked/always disabled",
  "Father unemployed: never lived with/not alive",
  "Father's occupation: blue collar",
  "Father's occupation: military",
  
  "Repeated school",
  "Trouble with police",
  "Parents used drugs or alcohol",
  "Physically abused",
  "Live in an orphanage",
  "Live in a foster home",
  "Parents separated or divorced",
  "Parents died",
  "Separated from mother",
  "Separated from father",

  "Higher education",
  "Household wealth",
  "Annual household income",
  "Higher subjective social status",
  "Race: black",
  "Race: other", 
  "Hispanic", 
  "Labor force status: other",
  "Labor force status: retired",
  
  "Received food stamps", 
  "Experienced food insecurity",
  "Home ownership",
  "House's type: mobile home",
  "House's type: one-family house",
  "House's type: apartment/townhouse",
  "House's type: other",
  "Live in the rural area",
  "Census region: Northeast",
  "Census region: Midwest", 
  "Census region: West",
  "Neighborhood unsafety",
  
  "Marital status: widowed", 
  "Marital status: separated/divorced",
  "Marital status: never married",
  "Household size",
  "Number of close children",
  "Number of close family members", 
  "Number of close friends",
  "Contact with children",
  "Contact with other family members", 
  "Contact with friends", 
  "Support from spouse", 
  "Strain from spouse",
  "Support from children", 
  "Strain from children", 
  "Support from other family members", 
  "Strain from other family members", 
  "Support from friends",
  "Strain from friends", 
  "Care for a sick adult", 
  "Do activities with grandchildren",
  "Volunteer with children",
  "Do charity work", 
  "Attend an educational course",
  "Go to a sport/social club",
  "Attend meetings of non-religious organizations", 
  "Pray privately",
  "Reading",
  "Watch television",
  "Do word games",
  "Play cards or chess",
  "Writing",
  "Use a computer or email",
  "Maintenance or gardening",
  "Baking or cooking",
  "Knitting",
  "Work on a hobby or project",
  "Play sports or exercise",
  "Walk for ≥20 minutes",
  "Attend religious activities",
  "Neighborhood physical disorder", 
  "Neighborhood social cohesion", 

  "Daily discrimination", 
  "Loneliness",
  "Ongoing health problems", 
  "Ongoing physical/emotional problems", 
  "Ongoing alcohol/drug issues in family member", 
  "Ongoing difficulties at work", 
  "Ongoing financial strain", 
  "Ongoing housing problems", 
  "Ongoing problems in a close relationship",
  "Helping sick family members or friends regularly",
  "Unfairly dismissed from a job",
  "Unfairly not been hired for a job",
  "Unfairly denied a promotion",
  "Unfairly been prevented from moving into a neighborhood",
  "Unfairly denied a bank loan",
  "Unfairly treated by the police",
  "Unfairly denied health care",
  "Experienced the death of a child", 
  "Experienced a natural disaster",
  "Fired a weapon in combat",
  "Partner addicted to drugs/alcohol", 
  "Been a victim of a physical attack",
  "Ever had a life-threatening illness", 
  "Ever had a spouse/child with a life-threatening illness", 
  "Involuntarily lost a job for reasons other than retirement",
  "Unemployed",
  "Anyone else in the household unemployed", 
  "Moved to a worse residence/neighborhood",
  "Robbed/burglarized",
  "Been the victim of fraud",
  "Ever been in a jail",
  "Ever been in long-term hospitalization",
  "Ever lived in a combat zone",
  "Ever lived in military housing",
  "Ever been homeless",
  
  "Ever smoking", 
  "Currently smoking", 
  "Ever drinking any alcohol",
  "Total number of drinks per week", 
  "Light physical activities", 
  "Moderate physical activities", 
  "Vigorous physical activities",
  "Body mass index",
  "Sleep problems", 

  "Government health insurance", 
  "Private health insurance", 
  "Long-term care insurance",
  "Life insurance",
  "Access to routine place for healthcare",
  "Out-of-pocket medical expenditure",
  "Lower healthcare satisfaction"
  )

# SHAP values
shp_imp_var_female <- sv_importance(shp_female, max_display = 150)$data %>%
  as_tibble() %>%
  mutate(
    value_normalized = value / sum(value),
    category = case_when(
      feature %in% demo ~ "Demographics",
      feature %in% ace ~ "Adverse Childhood Experiences",
      feature %in% ses ~ "Socioeconomic Status",
      feature %in% mc ~ "Material Circumstances",
      feature %in% socc ~ "Social Connections",
      feature %in% stress ~ "Social Stressors",
      feature %in% behav ~ "Health Behaviors",
      feature %in% hcare ~ "Healthcare Systems"
    ),
    category = factor(category, levels = c("Demographics", "Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems")),
    feature = factor(feature, levels = var_order)
  ) %>%
  arrange(category, feature) %>%
  mutate(var_name = var_name) %>%
  arrange(value)
shp_imp_var_female$var_name <- factor(shp_imp_var_female$var_name, levels = shp_imp_var_female$var_name)

shp_imp_cate_female <- shp_imp_var_female %>%
  dplyr::select(value_normalized, category) %>%
  group_by(category) %>%
  summarise(value_normalized = sum(value_normalized)) %>%
  arrange(category) %>%
  arrange(value_normalized)


# Dependence plot
S <- shp_female[["S"]] %>% # Matrix of SHAP values
  as_tibble() %>%
  dplyr::select(all_of(var_order)) %>%
  data.matrix()
colnames(S) <- var_name

X <- shp_female[["X"]] %>% # Dataset that includes the corresponding feature values
  dplyr::select(all_of(var_order))
colnames(X) <- var_name

shp_female_named <- shp_female
shp_female_named$S <- S
shp_female_named$X <- X

sv_imp_female <- sv_importance(shp_female_named, max_display = 150)

```

## 50-64

### Data preparation

```{r}

# Train-test split
data <- final %>%
  filter(age < 65 & fi_b < 0.2) %>%
  dplyr::select(
    age, male, 
    famfin, rameduc, rafeduc, movfin, fmfinh, faunem, radadoccup, 
    schlover, trpolice, drkdrug, phyabuse, 
    orphanage, fosterhome, padivch, padiech, sepmom, sepdad,
    raedyrs, atotb, itot, socladder, raracem, rahispan, lbrf, 
    efoodstamp, enoughfood, homeown, hometype, rural, cenreg, nnsafety, 
    mstat, hhres, cchild, csib, cfriend, chldcontact, sibcontact, friendcontact, 
    sposupport, kposupport, oposupport, fposupport, 
    snegsupport, knegsupport, onegsupport, fnegsupport, 
    care, playwthchld, volunteer, charity, educourse, club, organizations, pray, book, tv, 
    puzzles, cards, writing, computer, gardening, bake, clothes, hobby, sports, walk, socrelg_h, 
    nnphysical, nnsocial,
    pdailydiscrim, loneliness,
    oghealth, ogphymen, ogdrug, ogwork, ogfis, oghouse, ogclose, oghelp,
    ufdis, ufhire, ufdenyp, ufpvmov, ufdenyb, ufpolic, ufdenyh,
    chdeathe, nadise, combate, drugcse, attacke, lifethe, lifethcse, 
    lostjob, unemployed, hshdunemployed, worseresid, robbed, fraud, 
    jail, longhospital, combatzone, military, homeless,
    smokev, smoken, drink, drinkdn, ltactx, mdactx, vgactx, bmi, sleep,
    higov, hipriv, hiltc, lifein, usualcare, oopmd, caresat, 
    fi)
# 2987 participants

set.seed(12345)
hrs_split <- initial_split(data, prop = 0.8)
train_hrs <- training(hrs_split)
test_hrs  <- testing(hrs_split)

# Missing value imputation
tic()
train_preped <- missRanger(train_hrs %>% dplyr::select(!fi), . ~ ., pmm.k = 5, maxiter = 10, num.trees = 100, returnOOB = T, verbose = 1, seed = 12345)
toc() # 16 s
train_preped$fi <- train_hrs$fi

tic()
test_preped <- missRanger(test_hrs %>% dplyr::select(!fi), . ~ ., pmm.k = 5, maxiter = 10, num.trees = 100, returnOOB = T, verbose = 1, seed = 12345)
toc() # 11 s
test_preped$fi <- test_hrs$fi

#### Save data for GA2M ####
train_baked <- recipe(fi ~ ., data = train_preped) %>%
  prep() %>%
  bake(new_data = NULL) %>%
  dplyr::select(!fi, fi)

test_baked <- recipe(fi ~ ., data = test_preped) %>%
  prep() %>%
  bake(new_data = NULL) %>%
  dplyr::select(!fi, fi)

write.csv(train_baked, file = "train_baked_5064_hrs.csv", row.names = F)
write.csv(test_baked, file = "test_baked_5064_hrs.csv", row.names = F)

```

### xgboost

```{r}

# Preprocessing and Dummy Encoding
hrs_rec <- recipe(fi ~ ., data = train_preped) %>%
  step_dummy(all_factor_predictors(), one_hot = F)

## Cross-Validation Setup
set.seed(12345)
hrs_cv_folds <- rsample::vfold_cv(train_preped, v = 10)

# Model Specification and Hyperparameter Tuning
xgb_mod <- boost_tree(
  trees = tune(), # nrounds
  tree_depth = tune(),
  min_n = tune(),
  loss_reduction = tune(),  
  sample_size = tune(),
  mtry = tune(),
  learn_rate = tune(),
  stop_iter = tune()
  ) %>%
  set_engine("xgboost", objective = "reg:squarederror") %>%
  set_mode("regression")

## Create Hyperparameter Search Grid
set.seed(12345)
xgb_grid <- grid_latin_hypercube(
  trees(),
  tree_depth(), # max_depth
  min_n(), # min_child_weight
  loss_reduction(), # gamma
  sample_size = sample_prop(), # subsample
  finalize(mtry(), train_preped), # colsample_bynode
  learn_rate(),
  stop_iter(),
  size = 100
)

# Create Workflow
xgb_wf <- 
  workflow() %>% 
  add_recipe(hrs_rec) %>%
  add_model(xgb_mod) 

# Parallel Computing for Hyperparameter Tuning
n_cores <- detectCores()
doParallel::registerDoParallel(n_cores/2)

grid_ctrl <-
   control_grid(
     verbose = T,
      save_pred = F,
      parallel_over = NULL,
      save_workflow = F
   )

tic()
set.seed(12345)
xgb_tuned <- tune::tune_grid(
  object = xgb_wf,
  resamples = hrs_cv_folds,
  grid = xgb_grid,
  metrics = yardstick::metric_set(mae, rmse, rsq),
  control = grid_ctrl
)
toc() # 200 s

## Analyze Tuning Results
### Print all metrics
print(collect_metrics(xgb_tuned), n = 100)

### Visualize hyperparameter impacts
xgb_tuned %>%
  collect_metrics() %>%
  filter(.metric == "mae") %>%
  dplyr::select(mean, mtry:stop_iter) %>%
  pivot_longer(mtry:stop_iter,
               values_to = "value",
               names_to = "parameter"
  ) %>%
  ggplot(aes(value, mean, color = parameter)) +
  geom_point(alpha = 0.8, show.legend = FALSE) +
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "Mean absolute error")

### Select Best Hyperparameters
xgb_best_params <- xgb_tuned %>% 
  tune::select_best(metric = "mae")

mtry_best <- xgb_best_params$mtry
min_n_best <- xgb_best_params$min_n
trees_best <- xgb_best_params$trees
tree_depth_best <- xgb_best_params$tree_depth

opt_hyper_hrs[opt_hyper_hrs$group == "<65 years", c("mtry", "trees", "min_n", "tree_depth", "learn_rate", "loss_reduction", "sample_size", "stop_iter")] <- xgb_tuned %>% tune::select_best(metric = "mae") %>% dplyr::select(mtry:stop_iter)

### Calculate Cross-Validation Metrics
mae_cv_5064 <- xgb_tuned %>%
  collect_metrics(summarize = FALSE) %>%
  filter(mtry == mtry_best & min_n == min_n_best & trees == trees_best & tree_depth == tree_depth_best) %>%
  filter(.metric == 'mae') %>%
  pull(.estimate)
skim(mae_cv_5064)

rmse_cv_5064 <- xgb_tuned %>%
  collect_metrics(summarize = FALSE) %>%
  filter(mtry == mtry_best & min_n == min_n_best & trees == trees_best & tree_depth == tree_depth_best) %>%
  filter(.metric == 'rmse') %>%
  pull(.estimate)
skim(rmse_cv_5064)

rsq_cv_5064 <- xgb_tuned %>%
  collect_metrics(summarize = FALSE) %>%
  filter(mtry == mtry_best & min_n == min_n_best & trees == trees_best & tree_depth == tree_depth_best) %>%
  filter(.metric == 'rsq') %>%
  pull(.estimate)
skim(rsq_cv_5064)

## Finalize Workflow with Best Parameters
xgb_final_wf <- 
  xgb_wf %>% 
  finalize_workflow(xgb_best_params)

## Fit Final Model
### Fit model on entire training data
set.seed(12345)
final_xgb_mod <- xgb_final_wf %>%
  fit(data = train_preped)

### Bootstrap Performance Metrics on testing data
options(boot.parallel = "no", boot.ncpus = 1)
set.seed(12345)
tic()
mae_boot_xgb_5064 <- boot(data = test_preped, statistic = mae_func, R = 1000, model = final_xgb_mod)
print(mae_boot_xgb_5064)
toc()

set.seed(12345)
tic()
rmse_boot_xgb_5064 <- boot(data = test_preped, statistic = rmse_func, R = 1000, model = final_xgb_mod)
print(rmse_boot_xgb_5064)
toc()

set.seed(12345)
tic()
rsq_boot_xgb_5064 <- boot(data = test_preped, statistic = rsq_func, R = 1000, model = final_xgb_mod)
print(rsq_boot_xgb_5064)
toc()

```

##### SHAP 

```{r}

# Extract model information
xgb_fit_5064 <- final_xgb_mod %>% extract_fit_engine()

# Create “shapviz” object
set.seed(12345)
shp_5064 <- shapviz(xgb_fit_5064, X_pred = data.matrix(hrs_rec %>% prep() %>% bake(new_data = NULL) %>% dplyr::select(-fi)))

demo <- c("age", "male_male")
ace <- c(
  "famfin", "rafeduc", "rameduc", "movfin_yes", "fmfinh_yes", "faunem_yes", "faunem_never_work", "faunem_not_alive", "radadoccup_bluecollar", "radadoccup_military",
  "schlover_yes", "trpolice_yes", "drkdrug_yes", "phyabuse_yes", "orphanage_yes", "fosterhome_yes", "padivch_yes", "padiech_yes", "sepmom_yes", "sepdad_yes")
ses <- c("raedyrs", "atotb", "itot", "socladder", "raracem_black", "raracem_other", "rahispan_yes", "lbrf_others", "lbrf_retired")
mc <- c("efoodstamp_yes", "enoughfood_yes", "homeown_yes", "hometype_mobilehome", "hometype_onefamily", "hometype_apartment", "hometype_other", "rural_yes", "cenreg_Northeast", "cenreg_Midwest", "cenreg_West", "nnsafety")
socc <- c(
  "mstat_widowed", "mstat_separated", "mstat_never", "hhres",
  "cchild", "csib", "cfriend", 
  "chldcontact", "sibcontact", "friendcontact", 
  "sposupport", "snegsupport", "kposupport", "knegsupport", "oposupport", "onegsupport", "fposupport", "fnegsupport", 
  "care", "playwthchld", "volunteer", "charity", "educourse", "club", "organizations", 
  "pray", "book", "tv", "puzzles", "cards", "writing", "computer", "gardening", "bake", "clothes", 
  "hobby", "sports", "walk", "socrelg_h", "nnphysical", "nnsocial")
stress <- c(
  "pdailydiscrim", "loneliness", 
  "oghealth", "ogphymen", "ogdrug", "ogwork", "ogfis", "oghouse", "ogclose", "oghelp", 
  "ufdis_yes", "ufhire_yes", "ufdenyp_yes", "ufpvmov_yes", "ufdenyb_yes", "ufpolic_yes", "ufdenyh_yes", 
  "chdeathe_yes", "nadise_yes", "combate_yes", "drugcse_yes", "attacke_yes", "lifethe_yes", "lifethcse_yes", 
  "lostjob_yes", "unemployed_yes", "hshdunemployed_yes", "worseresid_yes", "robbed_yes", "fraud_yes", 
  "jail_yes", "longhospital_yes", "combatzone_yes", "military_yes", "homeless_yes")
behav <- c("smokev_yes", "smoken_yes", "drink_yes", "drinkdn", "ltactx", "mdactx", "vgactx", "bmi", "sleep")
hcare <- c("higov_yes", "hipriv_yes", "hiltc_yes", "lifein_yes", "usualcare_yes", "oopmd", "caresat")

var_order <- c(demo, ace, ses, mc, socc, stress, behav, hcare)

var_name <- c(
  "Age",
  "Sex: male",
  
  "Lower family financial situation",
  "Higher father's education", 
  "Higher mother's education",
  "Relocated due to financial difficulties",
  "Family received financial help",
  "Father unemployed: yes",
  "Father unemployed: never worked/always disabled",
  "Father unemployed: never lived with/not alive",
  "Father's occupation: blue collar",
  "Father's occupation: military",
  
  "Repeated school",
  "Trouble with police",
  "Parents used drugs or alcohol",
  "Physically abused",
  "Live in an orphanage",
  "Live in a foster home",
  "Parents separated or divorced",
  "Parents died",
  "Separated from mother",
  "Separated from father",

  "Higher education",
  "Household wealth",
  "Annual household income",
  "Higher subjective social status",
  "Race: black",
  "Race: other", 
  "Hispanic", 
  "Labor force status: other",
  "Labor force status: retired",
  
  "Received food stamps", 
  "Experienced food insecurity",
  "Home ownership",
  "House's type: mobile home",
  "House's type: one-family house",
  "House's type: apartment/townhouse",
  "House's type: other",
  "Live in the rural area",
  "Census region: Northeast",
  "Census region: Midwest", 
  "Census region: West",
  "Neighborhood unsafety",
  
  "Marital status: widowed", 
  "Marital status: separated/divorced",
  "Marital status: never married",
  "Household size",
  "Number of close children",
  "Number of close family members", 
  "Number of close friends",
  "Contact with children",
  "Contact with other family members", 
  "Contact with friends", 
  "Support from spouse", 
  "Strain from spouse",
  "Support from children", 
  "Strain from children", 
  "Support from other family members", 
  "Strain from other family members", 
  "Support from friends",
  "Strain from friends", 
  "Care for a sick adult", 
  "Do activities with grandchildren",
  "Volunteer with children",
  "Do charity work", 
  "Attend an educational course",
  "Go to a sport/social club",
  "Attend meetings of non-religious organizations", 
  "Pray privately",
  "Reading",
  "Watch television",
  "Do word games",
  "Play cards or chess",
  "Writing",
  "Use a computer or email",
  "Maintenance or gardening",
  "Baking or cooking",
  "Knitting",
  "Work on a hobby or project",
  "Play sports or exercise",
  "Walk for ≥20 minutes",
  "Attend religious activities",
  "Neighborhood physical disorder", 
  "Neighborhood social cohesion", 

  "Daily discrimination", 
  "Loneliness",
  "Ongoing health problems", 
  "Ongoing physical/emotional problems", 
  "Ongoing alcohol/drug issues in family member", 
  "Ongoing difficulties at work", 
  "Ongoing financial strain", 
  "Ongoing housing problems", 
  "Ongoing problems in a close relationship",
  "Helping sick family members or friends regularly",
  "Unfairly dismissed from a job",
  "Unfairly not been hired for a job",
  "Unfairly denied a promotion",
  "Unfairly been prevented from moving into a neighborhood",
  "Unfairly denied a bank loan",
  "Unfairly treated by the police",
  "Unfairly denied health care",
  "Experienced the death of a child", 
  "Experienced a natural disaster",
  "Fired a weapon in combat",
  "Partner addicted to drugs/alcohol", 
  "Been a victim of a physical attack",
  "Ever had a life-threatening illness", 
  "Ever had a spouse/child with a life-threatening illness", 
  "Involuntarily lost a job for reasons other than retirement",
  "Unemployed",
  "Anyone else in the household unemployed", 
  "Moved to a worse residence/neighborhood",
  "Robbed/burglarized",
  "Been the victim of fraud",
  "Ever been in a jail",
  "Ever been in long-term hospitalization",
  "Ever lived in a combat zone",
  "Ever lived in military housing",
  "Ever been homeless",
  
  "Ever smoking", 
  "Currently smoking", 
  "Ever drinking any alcohol",
  "Total number of drinks per week", 
  "Light physical activities", 
  "Moderate physical activities", 
  "Vigorous physical activities",
  "Body mass index",
  "Sleep problems", 

  "Government health insurance", 
  "Private health insurance", 
  "Long-term care insurance",
  "Life insurance",
  "Access to routine place for healthcare",
  "Out-of-pocket medical expenditure",
  "Lower healthcare satisfaction"
  )


# SHAP values
shp_imp_var_5064 <- sv_importance(shp_5064, max_display = 150)$data %>%
  as_tibble() %>%
  mutate(
    value_normalized = value / sum(value),
    category = case_when(
      feature %in% demo ~ "Demographics",
      feature %in% ace ~ "Adverse Childhood Experiences",
      feature %in% ses ~ "Socioeconomic Status",
      feature %in% mc ~ "Material Circumstances",
      feature %in% socc ~ "Social Connections",
      feature %in% stress ~ "Social Stressors",
      feature %in% behav ~ "Health Behaviors",
      feature %in% hcare ~ "Healthcare Systems"
    ),
    category = factor(category, levels = c("Demographics", "Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems")),
    feature = factor(feature, levels = var_order)
  ) %>%
  arrange(category, feature) %>%
  mutate(var_name = var_name) %>%
  arrange(value)
shp_imp_var_5064$var_name <- factor(shp_imp_var_5064$var_name, levels = shp_imp_var_5064$var_name)

shp_imp_cate_5064 <- shp_imp_var_5064 %>%
  dplyr::select(value_normalized, category) %>%
  group_by(category) %>%
  summarise(value_normalized = sum(value_normalized)) %>%
  arrange(category) %>%
  arrange(value_normalized)


# Dependence plot
S <- shp_5064[["S"]] %>% # Matrix of SHAP values
  as_tibble() %>%
  dplyr::select(all_of(var_order)) %>%
  data.matrix()
colnames(S) <- var_name

X <- shp_5064[["X"]] %>% # Dataset that includes the corresponding feature values
  dplyr::select(all_of(var_order))
colnames(X) <- var_name

shp_5064_named <- shp_5064
shp_5064_named$S <- S
shp_5064_named$X <- X

sv_imp_5064 <- sv_importance(shp_5064_named, max_display = 150)

```

## 65+

### Data preparation

```{r}

# Train-test split
data <- final %>%
  filter(age >= 65 & fi_b < 0.2) %>%
  dplyr::select(
    age, male, 
    famfin, rameduc, rafeduc, movfin, fmfinh, faunem, radadoccup, 
    schlover, trpolice, drkdrug, phyabuse, 
    orphanage, fosterhome, padivch, padiech, sepmom, sepdad,
    raedyrs, atotb, itot, socladder, raracem, rahispan, lbrf, 
    efoodstamp, enoughfood, homeown, hometype, rural, cenreg, nnsafety, 
    mstat, hhres, cchild, csib, cfriend, chldcontact, sibcontact, friendcontact, 
    sposupport, kposupport, oposupport, fposupport, 
    snegsupport, knegsupport, onegsupport, fnegsupport, 
    care, playwthchld, volunteer, charity, educourse, club, organizations, pray, book, tv, 
    puzzles, cards, writing, computer, gardening, bake, clothes, hobby, sports, walk, socrelg_h, 
    nnphysical, nnsocial,
    pdailydiscrim, loneliness,
    oghealth, ogphymen, ogdrug, ogwork, ogfis, oghouse, ogclose, oghelp,
    ufdis, ufhire, ufdenyp, ufpvmov, ufdenyb, ufpolic, ufdenyh,
    chdeathe, nadise, combate, drugcse, attacke, lifethe, lifethcse, 
    lostjob, unemployed, hshdunemployed, worseresid, robbed, fraud, 
    jail, longhospital, combatzone, military, homeless,
    smokev, smoken, drink, drinkdn, ltactx, mdactx, vgactx, bmi, sleep,
    higov, hipriv, hiltc, lifein, usualcare, oopmd, caresat, 
    fi)

set.seed(12345)
hrs_split <- initial_split(data, prop = 0.8)
train_hrs <- training(hrs_split)
test_hrs  <- testing(hrs_split)

# Missing value imputation
tic()
train_preped <- missRanger(train_hrs %>% dplyr::select(!fi), . ~ ., pmm.k = 5, maxiter = 10, num.trees = 100, returnOOB = T, verbose = 1, seed = 12345)
toc() # 16 s
train_preped$fi <- train_hrs$fi

tic()
test_preped <- missRanger(test_hrs %>% dplyr::select(!fi), . ~ ., pmm.k = 5, maxiter = 10, num.trees = 100, returnOOB = T, verbose = 1, seed = 12345)
toc() # 11 s
test_preped$fi <- test_hrs$fi

#### Save data for GA2M ####
train_baked <- recipe(fi ~ ., data = train_preped) %>%
  prep() %>%
  bake(new_data = NULL) %>%
  dplyr::select(!fi, fi)

test_baked <- recipe(fi ~ ., data = test_preped) %>%
  prep() %>%
  bake(new_data = NULL) %>%
  dplyr::select(!fi, fi)

write.csv(train_baked, file = "train_baked_65plus_hrs.csv", row.names = F)
write.csv(test_baked, file = "test_baked_65plus_hrs.csv", row.names = F)

```

### xgboost

```{r}

# Preprocessing and Dummy Encoding
hrs_rec <- recipe(fi ~ ., data = train_preped) %>%
  step_dummy(all_factor_predictors(), one_hot = F)

## Cross-Validation Setup
set.seed(12345)
hrs_cv_folds <- rsample::vfold_cv(train_preped, v = 10)

# Model Specification and Hyperparameter Tuning
xgb_mod <- boost_tree(
  trees = tune(), # nrounds
  tree_depth = tune(),
  min_n = tune(),
  loss_reduction = tune(),  
  sample_size = tune(),
  mtry = tune(),
  learn_rate = tune(),
  stop_iter = tune()
  ) %>%
  set_engine("xgboost", objective = "reg:squarederror") %>%
  set_mode("regression")

## Create Hyperparameter Search Grid
set.seed(12345)
xgb_grid <- grid_latin_hypercube(
  trees(),
  tree_depth(), # max_depth
  min_n(), # min_child_weight
  loss_reduction(), # gamma
  sample_size = sample_prop(), # subsample
  finalize(mtry(), train_preped), # colsample_bynode
  learn_rate(),
  stop_iter(),
  size = 100
)

# Create Workflow
xgb_wf <- 
  workflow() %>% 
  add_recipe(hrs_rec) %>%
  add_model(xgb_mod) 

# Parallel Computing for Hyperparameter Tuning
n_cores <- detectCores()
doParallel::registerDoParallel(n_cores/2)

grid_ctrl <-
   control_grid(
     verbose = T,
      save_pred = F,
      parallel_over = NULL,
      save_workflow = F
   )

tic()
set.seed(12345)
xgb_tuned <- tune::tune_grid(
  object = xgb_wf,
  resamples = hrs_cv_folds,
  grid = xgb_grid,
  metrics = yardstick::metric_set(mae, rmse, rsq),
  control = grid_ctrl
)
toc() # 200 s

## Analyze Tuning Results
### Print all metrics
print(collect_metrics(xgb_tuned), n = 100)

### Visualize hyperparameter impacts
xgb_tuned %>%
  collect_metrics() %>%
  filter(.metric == "mae") %>%
  dplyr::select(mean, mtry:stop_iter) %>%
  pivot_longer(mtry:stop_iter,
               values_to = "value",
               names_to = "parameter"
  ) %>%
  ggplot(aes(value, mean, color = parameter)) +
  geom_point(alpha = 0.8, show.legend = FALSE) +
  facet_wrap(~parameter, scales = "free_x") +
  labs(x = NULL, y = "Mean absolute error")

### Select Best Hyperparameters
xgb_best_params <- xgb_tuned %>% 
  tune::select_best(metric = "mae")

mtry_best <- xgb_best_params$mtry
min_n_best <- xgb_best_params$min_n
trees_best <- xgb_best_params$trees
tree_depth_best <- xgb_best_params$tree_depth

opt_hyper_hrs[opt_hyper_hrs$group == "≥65 years", c("mtry", "trees", "min_n", "tree_depth", "learn_rate", "loss_reduction", "sample_size", "stop_iter")] <- xgb_tuned %>% tune::select_best(metric = "mae") %>% dplyr::select(mtry:stop_iter)

### Calculate Cross-Validation Metrics
mae_cv_65plus <- xgb_tuned %>%
  collect_metrics(summarize = FALSE) %>%
  filter(mtry == mtry_best & min_n == min_n_best & trees == trees_best & tree_depth == tree_depth_best) %>%
  filter(.metric == 'mae') %>%
  pull(.estimate)
skim(mae_cv_65plus)

rmse_cv_65plus <- xgb_tuned %>%
  collect_metrics(summarize = FALSE) %>%
  filter(mtry == mtry_best & min_n == min_n_best & trees == trees_best & tree_depth == tree_depth_best) %>%
  filter(.metric == 'rmse') %>%
  pull(.estimate)
skim(rmse_cv_65plus)

rsq_cv_65plus <- xgb_tuned %>%
  collect_metrics(summarize = FALSE) %>%
  filter(mtry == mtry_best & min_n == min_n_best & trees == trees_best & tree_depth == tree_depth_best) %>%
  filter(.metric == 'rsq') %>%
  pull(.estimate)
skim(rsq_cv_65plus)

## Finalize Workflow with Best Parameters
xgb_final_wf <- 
  xgb_wf %>% 
  finalize_workflow(xgb_best_params)

## Fit Final Model
### Fit model on entire training data
set.seed(12345)
final_xgb_mod <- xgb_final_wf %>%
  fit(data = train_preped)

### Bootstrap Performance Metrics on testing data
options(boot.parallel = "no", boot.ncpus = 1)
set.seed(12345)
tic()
mae_boot_xgb_65plus <- boot(data = test_preped, statistic = mae_func, R = 1000, model = final_xgb_mod)
print(mae_boot_xgb_65plus)
toc()

set.seed(12345)
tic()
rmse_boot_xgb_65plus <- boot(data = test_preped, statistic = rmse_func, R = 1000, model = final_xgb_mod)
print(rmse_boot_xgb_65plus)
toc()

set.seed(12345)
tic()
rsq_boot_xgb_65plus <- boot(data = test_preped, statistic = rsq_func, R = 1000, model = final_xgb_mod)
print(rsq_boot_xgb_65plus)
toc()

```

##### SHAP 

```{r}

# Extract model information
xgb_fit_65plus <- final_xgb_mod %>% extract_fit_engine()

# Create “shapviz” object
set.seed(12345)
shp_65plus <- shapviz(xgb_fit_65plus, X_pred = data.matrix(hrs_rec %>% prep() %>% bake(new_data = NULL) %>% dplyr::select(-fi)))

demo <- c("age", "male_male")
ace <- c(
  "famfin", "rafeduc", "rameduc", "movfin_yes", "fmfinh_yes", "faunem_yes", "faunem_never_work", "faunem_not_alive", "radadoccup_bluecollar", "radadoccup_military",
  "schlover_yes", "trpolice_yes", "drkdrug_yes", "phyabuse_yes", "orphanage_yes", "fosterhome_yes", "padivch_yes", "padiech_yes", "sepmom_yes", "sepdad_yes")
ses <- c("raedyrs", "atotb", "itot", "socladder", "raracem_black", "raracem_other", "rahispan_yes", "lbrf_others", "lbrf_retired")
mc <- c("efoodstamp_yes", "enoughfood_yes", "homeown_yes", "hometype_mobilehome", "hometype_onefamily", "hometype_apartment", "hometype_other", "rural_yes", "cenreg_Northeast", "cenreg_Midwest", "cenreg_West", "nnsafety")
socc <- c(
  "mstat_widowed", "mstat_separated", "mstat_never", "hhres",
  "cchild", "csib", "cfriend", 
  "chldcontact", "sibcontact", "friendcontact", 
  "sposupport", "snegsupport", "kposupport", "knegsupport", "oposupport", "onegsupport", "fposupport", "fnegsupport", 
  "care", "playwthchld", "volunteer", "charity", "educourse", "club", "organizations", 
  "pray", "book", "tv", "puzzles", "cards", "writing", "computer", "gardening", "bake", "clothes", 
  "hobby", "sports", "walk", "socrelg_h", "nnphysical", "nnsocial")
stress <- c(
  "pdailydiscrim", "loneliness", 
  "oghealth", "ogphymen", "ogdrug", "ogwork", "ogfis", "oghouse", "ogclose", "oghelp", 
  "ufdis_yes", "ufhire_yes", "ufdenyp_yes", "ufpvmov_yes", "ufdenyb_yes", "ufpolic_yes", "ufdenyh_yes", 
  "chdeathe_yes", "nadise_yes", "combate_yes", "drugcse_yes", "attacke_yes", "lifethe_yes", "lifethcse_yes", 
  "lostjob_yes", "unemployed_yes", "hshdunemployed_yes", "worseresid_yes", "robbed_yes", "fraud_yes", 
  "jail_yes", "longhospital_yes", "combatzone_yes", "military_yes", "homeless_yes")
behav <- c("smokev_yes", "smoken_yes", "drink_yes", "drinkdn", "ltactx", "mdactx", "vgactx", "bmi", "sleep")
hcare <- c("higov_yes", "hipriv_yes", "hiltc_yes", "lifein_yes", "usualcare_yes", "oopmd", "caresat")

var_order <- c(demo, ace, ses, mc, socc, stress, behav, hcare)

var_name <- c(
  "Age",
  "Sex: male",
  
  "Lower family financial situation",
  "Higher father's education", 
  "Higher mother's education",
  "Relocated due to financial difficulties",
  "Family received financial help",
  "Father unemployed: yes",
  "Father unemployed: never worked/always disabled",
  "Father unemployed: never lived with/not alive",
  "Father's occupation: blue collar",
  "Father's occupation: military",
  
  "Repeated school",
  "Trouble with police",
  "Parents used drugs or alcohol",
  "Physically abused",
  "Live in an orphanage",
  "Live in a foster home",
  "Parents separated or divorced",
  "Parents died",
  "Separated from mother",
  "Separated from father",

  "Higher education",
  "Household wealth",
  "Annual household income",
  "Higher subjective social status",
  "Race: black",
  "Race: other", 
  "Hispanic", 
  "Labor force status: other",
  "Labor force status: retired",
  
  "Received food stamps", 
  "Experienced food insecurity",
  "Home ownership",
  "House's type: mobile home",
  "House's type: one-family house",
  "House's type: apartment/townhouse",
  "House's type: other",
  "Live in the rural area",
  "Census region: Northeast",
  "Census region: Midwest", 
  "Census region: West",
  "Neighborhood unsafety",
  
  "Marital status: widowed", 
  "Marital status: separated/divorced",
  "Marital status: never married",
  "Household size",
  "Number of close children",
  "Number of close family members", 
  "Number of close friends",
  "Contact with children",
  "Contact with other family members", 
  "Contact with friends", 
  "Support from spouse", 
  "Strain from spouse",
  "Support from children", 
  "Strain from children", 
  "Support from other family members", 
  "Strain from other family members", 
  "Support from friends",
  "Strain from friends", 
  "Care for a sick adult", 
  "Do activities with grandchildren",
  "Volunteer with children",
  "Do charity work", 
  "Attend an educational course",
  "Go to a sport/social club",
  "Attend meetings of non-religious organizations", 
  "Pray privately",
  "Reading",
  "Watch television",
  "Do word games",
  "Play cards or chess",
  "Writing",
  "Use a computer or email",
  "Maintenance or gardening",
  "Baking or cooking",
  "Knitting",
  "Work on a hobby or project",
  "Play sports or exercise",
  "Walk for ≥20 minutes",
  "Attend religious activities",
  "Neighborhood physical disorder", 
  "Neighborhood social cohesion", 

  "Daily discrimination", 
  "Loneliness",
  "Ongoing health problems", 
  "Ongoing physical/emotional problems", 
  "Ongoing alcohol/drug issues in family member", 
  "Ongoing difficulties at work", 
  "Ongoing financial strain", 
  "Ongoing housing problems", 
  "Ongoing problems in a close relationship",
  "Helping sick family members or friends regularly",
  "Unfairly dismissed from a job",
  "Unfairly not been hired for a job",
  "Unfairly denied a promotion",
  "Unfairly been prevented from moving into a neighborhood",
  "Unfairly denied a bank loan",
  "Unfairly treated by the police",
  "Unfairly denied health care",
  "Experienced the death of a child", 
  "Experienced a natural disaster",
  "Fired a weapon in combat",
  "Partner addicted to drugs/alcohol", 
  "Been a victim of a physical attack",
  "Ever had a life-threatening illness", 
  "Ever had a spouse/child with a life-threatening illness", 
  "Involuntarily lost a job for reasons other than retirement",
  "Unemployed",
  "Anyone else in the household unemployed", 
  "Moved to a worse residence/neighborhood",
  "Robbed/burglarized",
  "Been the victim of fraud",
  "Ever been in a jail",
  "Ever been in long-term hospitalization",
  "Ever lived in a combat zone",
  "Ever lived in military housing",
  "Ever been homeless",
  
  "Ever smoking", 
  "Currently smoking", 
  "Ever drinking any alcohol",
  "Total number of drinks per week", 
  "Light physical activities", 
  "Moderate physical activities", 
  "Vigorous physical activities",
  "Body mass index",
  "Sleep problems", 

  "Government health insurance", 
  "Private health insurance", 
  "Long-term care insurance",
  "Life insurance",
  "Access to routine place for healthcare",
  "Out-of-pocket medical expenditure",
  "Lower healthcare satisfaction"
  )


# SHAP values
shp_imp_var_65plus <- sv_importance(shp_65plus, max_display = 150)$data %>%
  as_tibble() %>%
  mutate(
    value_normalized = value / sum(value),
    category = case_when(
      feature %in% demo ~ "Demographics",
      feature %in% ace ~ "Adverse Childhood Experiences",
      feature %in% ses ~ "Socioeconomic Status",
      feature %in% mc ~ "Material Circumstances",
      feature %in% socc ~ "Social Connections",
      feature %in% stress ~ "Social Stressors",
      feature %in% behav ~ "Health Behaviors",
      feature %in% hcare ~ "Healthcare Systems"
    ),
    category = factor(category, levels = c("Demographics", "Adverse Childhood Experiences", "Socioeconomic Status", "Material Circumstances", "Social Connections", "Social Stressors", "Health Behaviors", "Healthcare Systems")),
    feature = factor(feature, levels = var_order)
  ) %>%
  arrange(category, feature) %>%
  mutate(var_name = var_name) %>%
  arrange(value)
shp_imp_var_65plus$var_name <- factor(shp_imp_var_65plus$var_name, levels = shp_imp_var_65plus$var_name)

shp_imp_cate_65plus <- shp_imp_var_65plus %>%
  dplyr::select(value_normalized, category) %>%
  group_by(category) %>%
  summarise(value_normalized = sum(value_normalized)) %>%
  arrange(category) %>%
  arrange(value_normalized)


# Dependence plot
S <- shp_65plus[["S"]] %>% # Matrix of SHAP values
  as_tibble() %>%
  dplyr::select(all_of(var_order)) %>%
  data.matrix()
colnames(S) <- var_name

X <- shp_65plus[["X"]] %>% # Dataset that includes the corresponding feature values
  dplyr::select(all_of(var_order))
colnames(X) <- var_name

shp_65plus_named <- shp_65plus
shp_65plus_named$S <- S
shp_65plus_named$X <- X

sv_imp_65plus <- sv_importance(shp_65plus_named, max_display = 150)

```

# Plot

## Save plotting data

```{r}

final_hrs <- final

mae_cv_overall_hrs <- mae_cv_overall
rmse_cv_overall_hrs <- rmse_cv_overall
rsq_cv_overall_hrs <- rsq_cv_overall
mae_boot_xgb_overall_hrs <- mae_boot_xgb_overall
rmse_boot_xgb_overall_hrs <- rmse_boot_xgb_overall
rsq_boot_xgb_overall_hrs <- rsq_boot_xgb_overall
shp_overall_hrs <- shp_overall
shp_imp_var_overall_hrs <- shp_imp_var_overall
shp_imp_cate_overall_hrs <- shp_imp_cate_overall
sv_imp_overall_hrs <- sv_imp_overall
train_results_hrs <- train_results
test_results_hrs <- test_results
combined_results_hrs <- combined_results

mae_cv_male_hrs <- mae_cv_male
rmse_cv_male_hrs <- rmse_cv_male
rsq_cv_male_hrs <- rsq_cv_male
mae_boot_xgb_male_hrs <- mae_boot_xgb_male
rmse_boot_xgb_male_hrs <- rmse_boot_xgb_male
rsq_boot_xgb_male_hrs <- rsq_boot_xgb_male
shp_male_hrs <- shp_male
shp_imp_var_male_hrs <- shp_imp_var_male
shp_imp_cate_male_hrs <- shp_imp_cate_male
sv_imp_male_hrs <- sv_imp_male

mae_cv_female_hrs <- mae_cv_female
rmse_cv_female_hrs <- rmse_cv_female
rsq_cv_female_hrs <- rsq_cv_female
mae_boot_xgb_female_hrs <- mae_boot_xgb_female
rmse_boot_xgb_female_hrs <- rmse_boot_xgb_female
rsq_boot_xgb_female_hrs <- rsq_boot_xgb_female
shp_female_hrs <- shp_female
shp_imp_var_female_hrs <- shp_imp_var_female
shp_imp_cate_female_hrs <- shp_imp_cate_female
sv_imp_female_hrs <- sv_imp_female

mae_cv_5064_hrs <- mae_cv_5064
rmse_cv_5064_hrs <- rmse_cv_5064
rsq_cv_5064_hrs <- rsq_cv_5064
mae_boot_xgb_5064_hrs <- mae_boot_xgb_5064
rmse_boot_xgb_5064_hrs <- rmse_boot_xgb_5064
rsq_boot_xgb_5064_hrs <- rsq_boot_xgb_5064
shp_5064_hrs <- shp_5064
shp_imp_var_5064_hrs <- shp_imp_var_5064
shp_imp_cate_5064_hrs <- shp_imp_cate_5064
sv_imp_5064_hrs <- sv_imp_5064

mae_cv_65plus_hrs <- mae_cv_65plus
rmse_cv_65plus_hrs <- rmse_cv_65plus
rsq_cv_65plus_hrs <- rsq_cv_65plus
mae_boot_xgb_65plus_hrs <- mae_boot_xgb_65plus
rmse_boot_xgb_65plus_hrs <- rmse_boot_xgb_65plus
rsq_boot_xgb_65plus_hrs <- rsq_boot_xgb_65plus
shp_65plus_hrs <- shp_65plus
shp_imp_var_65plus_hrs <- shp_imp_var_65plus
shp_imp_cate_65plus_hrs <- shp_imp_cate_65plus
sv_imp_65plus_hrs <- sv_imp_65plus

save(
  final_hrs, opt_hyper_hrs,
  mae_cv_overall_hrs, rmse_cv_overall_hrs, rsq_cv_overall_hrs, 
  mae_boot_xgb_overall_hrs, rmse_boot_xgb_overall_hrs, rsq_boot_xgb_overall_hrs, 
  shp_overall_hrs, shp_imp_var_overall_hrs, shp_imp_cate_overall_hrs, sv_imp_overall_hrs, 
  train_results_hrs, test_results_hrs, combined_results_hrs,
  
  mae_cv_male_hrs, rmse_cv_male_hrs, rsq_cv_male_hrs, 
  mae_boot_xgb_male_hrs, rmse_boot_xgb_male_hrs, rsq_boot_xgb_male_hrs,
  shp_male_hrs, shp_imp_var_male_hrs, shp_imp_cate_male_hrs, sv_imp_male_hrs, 
  
  mae_cv_female_hrs, rmse_cv_female_hrs, rsq_cv_female_hrs, 
  mae_boot_xgb_female_hrs, rmse_boot_xgb_female_hrs, rsq_boot_xgb_female_hrs,
  shp_female_hrs, shp_imp_var_female_hrs, shp_imp_cate_female_hrs, sv_imp_female_hrs,
  
  mae_cv_5064_hrs, rmse_cv_5064_hrs, rsq_cv_5064_hrs, 
  mae_boot_xgb_5064_hrs, rmse_boot_xgb_5064_hrs, rsq_boot_xgb_5064_hrs,
  shp_5064_hrs, shp_imp_var_5064_hrs, shp_imp_cate_5064_hrs, sv_imp_5064_hrs, 
  
  mae_cv_65plus_hrs, rmse_cv_65plus_hrs, rsq_cv_65plus_hrs, 
  mae_boot_xgb_65plus_hrs, rmse_boot_xgb_65plus_hrs, rsq_boot_xgb_65plus_hrs,
  shp_65plus_hrs, shp_imp_var_65plus_hrs, shp_imp_cate_65plus_hrs, sv_imp_65plus_hrs,
  
  heatmap_mat_hrs, 
  file = str_c(getwd(), "/data/processed/hrs_processed_data_for_visualization.RData", sep = ""))

```
